<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Transformers – Applied Soft Computing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../m04-text/bert-gpt.html" rel="next">
<link href="../m04-text/tokenization.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-1f36e651aa5e1ffb5e4e9439ef2eb9d4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "|"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script type="module" src="../site_libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="../site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../assets/custom.css">
</head>

<body class="nav-sidebar docked nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Applied Soft Computing</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../toc.html"> 
<span class="menu-text">Table of Contents</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-modules" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Modules</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-modules">    
        <li>
    <a class="dropdown-item" href="../m01-toolkit/overview.html">
 <span class="dropdown-text">Module 1: The Data Scientist’s Toolkit</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m02-visualization/overview.html">
 <span class="dropdown-text">Module 2: Visualizing Complexity</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m03-agentic-coding/overview.html">
 <span class="dropdown-text">Module 3: Agentic Coding</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m04-text/overview.html">
 <span class="dropdown-text">Module 4: Deep Learning for Text</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m05-images/overview.html">
 <span class="dropdown-text">Module 5: Deep Learning for Images</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m06-graph/overview.html">
 <span class="dropdown-text">Module 6: Deep Learning for Graphs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m07-representation/overview.html">
 <span class="dropdown-text">Module 7: Representations &amp; Structuralism</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m06-llms/overview.qmd">
 <span class="dropdown-text">Module 8: Advanced LLMs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m07-self-supervised/overview.qmd">
 <span class="dropdown-text">Module 9: Self-Supervised Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m08-explainability/overview.qmd">
 <span class="dropdown-text">Module 10: Explainability &amp; Ethics</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../m04-text/overview.html">Module 4: Deep Learning for Text</a></li><li class="breadcrumb-item"><a href="../m04-text/transformers.html">Transformers</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Course Information</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course/welcome.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course/about.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About Us</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course/why-applied-soft-computing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Why applied soft computing?</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course/discord.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Discord</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course/setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Setup</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course/minidora-usage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using Minidora</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course/how-to-submit-assignment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How to submit assignment</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course/deliverables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Deliverables</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Module 1: The Data Scientist’s Toolkit</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m01-toolkit/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m01-toolkit/git-github.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Version Control with Git &amp; GitHub</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m01-toolkit/tidy-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The Tidy Data Philosophy</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m01-toolkit/data-provenance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Provenance</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m01-toolkit/reproduceability.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reproducibility</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Module 2: Visualizing Complexity</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m02-visualization/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m02-visualization/principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Principles of Effective Visualization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m02-visualization/1d-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualizing 1D Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m02-visualization/2d-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualizing 2D Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m02-visualization/highd-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualizing High-Dimensional Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m02-visualization/networks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualizing Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m02-visualization/time-series.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualizing Time-Series</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Module 3: Agentic Coding</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m03-agentic-coding/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m03-agentic-coding/hands-on.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hands-on</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m03-agentic-coding/prompt-tuning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prompt Tuning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m03-agentic-coding/agentic-ai.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Agentic AI</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m03-agentic-coding/context-engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Context Engineering</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Module 4: Deep Learning for Text</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-text/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-text/llm-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Large Language Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-text/gpt-inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GPT Inference: Sampling Strategies</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-text/tokenization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tokenization: Unboxing How LLMs Read Text</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-text/transformers.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Transformers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-text/bert-gpt.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">BERT &amp; GPT</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-text/sentence-transformers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sentence Transformers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-text/word-embeddings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Word Embeddings</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-text/semaxis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Semaxis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-text/word-bias.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Word Bias</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Module 5: Deep Learning for Images</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m05-images/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m05-images/01-what-is-an-image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part 1: What is an Image?</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m05-images/02-the-deep-learning-revolution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part 2: The Deep Learning Revolution</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m05-images/03-using-cnn-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part 3: Using CNN Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m05-images/04-cnn-innovations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part 4: CNN Innovations</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Module 6: Deep Learning for Graphs</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m06-graph/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m06-graph/01-from-images-to-graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part 1: From Images to Graphs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m06-graph/02-spectral-perspective.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part 2: The Spectral Perspective</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m06-graph/03-spatial-networks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part 3: Spatial Graph Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m06-graph/04-graph-embeddings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part 4: Graph Embeddings</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="true">
 <span class="menu-text">Module 7: Representations &amp; Structuralism</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m07-representation/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m07-representation/01-boundaries.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part 1: When Boundaries Blur</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m07-representation/02-structuralism.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part 2: Meaning as Difference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m07-representation/03-embeddings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part 3: From Categories to Coordinates</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m07-representation/04-universal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part 4: Universal Representations</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../m04-text/overview.html">Module 4: Deep Learning for Text</a></li><li class="breadcrumb-item"><a href="../m04-text/transformers.html">Transformers</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Transformers</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled" title="What you'll learn in this module">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What you’ll learn in this module
</div>
</div>
<div class="callout-body-container callout-body">
<p>This module introduces the transformer architecture, the foundation of modern language models.</p>
<p>You’ll learn:</p>
<ul>
<li>Why <strong>static embeddings</strong> fail to capture context-dependent meanings.</li>
<li>How <strong>attention mechanisms</strong> compute context-aware representations through weighted mixing.</li>
<li>The role of <strong>Query, Key, and Value</strong> transformations in learning word relationships.</li>
<li>How <strong>multi-head attention</strong> captures different aspects of meaning in parallel.</li>
<li>The architecture of <strong>encoder and decoder modules</strong> with position embeddings, residual connections, and layer normalization.</li>
<li>Why transformers represent <strong>the fundamental shift</strong> in how machines understand language.</li>
</ul>
</div>
</div>
<section id="the-problem-with-one-vector-per-word" class="level2">
<h2 class="anchored" data-anchor-id="the-problem-with-one-vector-per-word">The Problem with One Vector Per Word</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../figs/attention-manga-problem.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p>For many years, natural language processing treated words as having fixed meanings. Each word (like “bank”) received a single vector of numbers, called a static embedding. But there’s a hidden catch in this “one meaning per word” mindset: with just a single fixed entry in the dictionary, “bank” means exactly the same thing in “I deposited money at the bank” as in “We had a picnic by the bank”. Think of it like describing a population by its average height and pretending nobody’s shorter or taller, where every possible meaning gets mashed into a one-size-fits-all average and the interesting details vanish in the mix.</p>
<p>What if we simply mixed the target word with its neighbors? For “I deposited money at the bank,” we could compute a contextualized representation as:</p>
<p><span class="math display">
\vec{v}_{\text{bank (new)}} = w_1 \cdot \vec{v}_{\text{bank}} + w_2 \cdot \vec{v}_{\text{deposited}} + w_3 \cdot \vec{v}_{\text{money}} + \cdots
</span></p>
<p>where <span class="math inline">w_i</span> are weights and <span class="math inline">\vec{v}_i</span> are word embeddings.</p>
<p>But here’s the key question: how do we determine these weights? Consider that “bank” sits neutrally between financial terms (money) and geographical terms (river).</p>
<p>Try manually adjusting the weights to contextualize “bank”:</p>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb1" data-startfrom="39" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 38;"><span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>d3 <span class="op">=</span> <span class="pp">require</span>(<span class="st">"d3@7"</span><span class="op">,</span> <span class="st">"d3-simple-slider@1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb2" data-startfrom="44" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 43;"><span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sliderWithLabel</span>(min<span class="op">,</span> max<span class="op">,</span> step<span class="op">,</span> width<span class="op">,</span> defaultValue<span class="op">,</span> label) {</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> slider <span class="op">=</span> d3<span class="op">.</span><span class="fu">sliderBottom</span>()</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">min</span>(min)<span class="op">.</span><span class="fu">max</span>(max)<span class="op">.</span><span class="fu">step</span>(step)<span class="op">.</span><span class="fu">width</span>(width)<span class="op">.</span><span class="fu">default</span>(defaultValue)<span class="op">;</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width <span class="op">+</span> <span class="dv">50</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> <span class="dv">60</span>)<span class="op">;</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="st">"translate(25,20)"</span>)<span class="op">.</span><span class="fu">call</span>(slider)<span class="op">;</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>  svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (width <span class="op">+</span> <span class="dv">50</span>) <span class="op">/</span> <span class="dv">2</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"5px"</span>)<span class="op">.</span><span class="fu">text</span>(label)<span class="op">;</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> svg<span class="op">.</span><span class="fu">node</span>()<span class="op">;</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb3" data-startfrom="56" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 55;"><span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">createWeightSlider</span>(min<span class="op">,</span> max<span class="op">,</span> step<span class="op">,</span> width<span class="op">,</span> defaultValue<span class="op">,</span> label) {</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> slider <span class="op">=</span> d3<span class="op">.</span><span class="fu">sliderBottom</span>()</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">min</span>(min)<span class="op">.</span><span class="fu">max</span>(max)<span class="op">.</span><span class="fu">step</span>(step)<span class="op">.</span><span class="fu">width</span>(width)<span class="op">.</span><span class="fu">default</span>(defaultValue)<span class="op">;</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width <span class="op">+</span> <span class="dv">50</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> <span class="dv">60</span>)<span class="op">;</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> g <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="st">"translate(25,20)"</span>)<span class="op">;</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    g<span class="op">.</span><span class="fu">call</span>(slider)<span class="op">;</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (width <span class="op">+</span> <span class="dv">50</span>) <span class="op">/</span> <span class="dv">2</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>       <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"12px"</span>)<span class="op">.</span><span class="fu">text</span>(label)<span class="op">;</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="dt">node</span><span class="op">:</span> svg<span class="op">.</span><span class="fu">node</span>()<span class="op">,</span> <span class="dt">slider</span><span class="op">:</span> slider }<span class="op">;</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> bankSliderObj <span class="op">=</span> <span class="fu">createWeightSlider</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="fl">0.01</span><span class="op">,</span> <span class="dv">120</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="st">"Bank weight"</span>)<span class="op">;</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> moneySliderObj <span class="op">=</span> <span class="fu">createWeightSlider</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="fl">0.01</span><span class="op">,</span> <span class="dv">120</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="st">"Money weight"</span>)<span class="op">;</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> riverSliderObj <span class="op">=</span> <span class="fu">createWeightSlider</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="fl">0.01</span><span class="op">,</span> <span class="dv">120</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="st">"River weight"</span>)<span class="op">;</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> contextWords <span class="op">=</span> [<span class="st">"bank"</span><span class="op">,</span> <span class="st">"money"</span><span class="op">,</span> <span class="st">"river"</span>]<span class="op">;</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> contextEmbeddings <span class="op">=</span> [</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span>]<span class="op">,</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    [<span class="op">-</span><span class="fl">1.6</span><span class="op">,</span> <span class="op">-</span><span class="fl">0.6</span>]<span class="op">,</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">1.4</span><span class="op">,</span> <span class="op">-</span><span class="fl">1.0</span>]</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> plotContainer <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">"div"</span>)<span class="op">;</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">update</span>() {</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> bankWeight <span class="op">=</span> bankSliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">value</span>()<span class="op">;</span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> moneyWeight <span class="op">=</span> moneySliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">value</span>()<span class="op">;</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> riverWeight <span class="op">=</span> riverSliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">value</span>()<span class="op">;</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> weights <span class="op">=</span> [bankWeight<span class="op">,</span> moneyWeight<span class="op">,</span> riverWeight]<span class="op">;</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> total <span class="op">=</span> weights<span class="op">.</span><span class="fu">reduce</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a <span class="op">+</span> b<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> normalizedWeights <span class="op">=</span> total <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> weights<span class="op">.</span><span class="fu">map</span>(w <span class="kw">=&gt;</span> w <span class="op">/</span> total) <span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> newVec <span class="op">=</span> [</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">0</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">1</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">1</span>][<span class="dv">0</span>] <span class="op">+</span></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">2</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">2</span>][<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">0</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">+</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">1</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">1</span>][<span class="dv">1</span>] <span class="op">+</span></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">2</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">2</span>][<span class="dv">1</span>]</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> originalData <span class="op">=</span> contextWords<span class="op">.</span><span class="fu">map</span>((word<span class="op">,</span> i) <span class="kw">=&gt;</span> ({</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>      <span class="dt">word</span><span class="op">:</span> word<span class="op">,</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> contextEmbeddings[i][<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> contextEmbeddings[i][<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">"Original"</span></span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> contextualizedData <span class="op">=</span> [{</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>      <span class="dt">word</span><span class="op">:</span> <span class="st">"bank (new)"</span><span class="op">,</span></span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> newVec[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> newVec[<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">"Contextualized"</span></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>    }]<span class="op">;</span></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> [<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>contextualizedData]<span class="op">;</span></span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>    d3<span class="op">.</span><span class="fu">select</span>(plotContainer)<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> plot <span class="op">=</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>      <span class="dt">width</span><span class="op">:</span> <span class="dv">300</span><span class="op">,</span></span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>      <span class="dt">height</span><span class="op">:</span> <span class="dv">300</span><span class="op">,</span></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>      <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>        <span class="dt">background</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span></span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>        <span class="dt">color</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>        <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">2</span>]<span class="op">,</span></span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>        <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 1"</span><span class="op">,</span></span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>        <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>        <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>        <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">2</span>]<span class="op">,</span></span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>        <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 2"</span><span class="op">,</span></span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>        <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>        <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>        <span class="dt">domain</span><span class="op">:</span> [<span class="st">"Original"</span><span class="op">,</span> <span class="st">"Contextualized"</span>]<span class="op">,</span></span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>        <span class="dt">range</span><span class="op">:</span> [<span class="st">"#dadada"</span><span class="op">,</span> <span class="st">"#ff7f0e"</span>]</span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">dot</span>(data<span class="op">,</span> {</span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"type"</span><span class="op">,</span></span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a>          <span class="dt">r</span><span class="op">:</span> <span class="dv">8</span><span class="op">,</span></span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>          <span class="dt">tip</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">text</span>(data<span class="op">,</span> {</span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a>          <span class="dt">text</span><span class="op">:</span> <span class="st">"word"</span><span class="op">,</span></span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a>          <span class="dt">dy</span><span class="op">:</span> <span class="op">-</span><span class="dv">15</span><span class="op">,</span></span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">8</span><span class="op">,</span></span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">text</span>([{<span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">2.3</span>}]<span class="op">,</span> {</span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a>          <span class="dt">text</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="vs">`Weights: Bank=</span><span class="sc">${</span>normalizedWeights[<span class="dv">0</span>]<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">, Money=</span><span class="sc">${</span>normalizedWeights[<span class="dv">1</span>]<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">, River=</span><span class="sc">${</span>normalizedWeights[<span class="dv">2</span>]<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">11</span><span class="op">,</span></span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">dot</span>([{<span class="dt">x</span><span class="op">:</span> <span class="op">-</span><span class="fl">0.8</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">2.7</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span> <span class="st">"#dadada"</span>}<span class="op">,</span> {<span class="dt">x</span><span class="op">:</span> <span class="fl">0.8</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">2.7</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span> <span class="st">"#ff7f0e"</span>}]<span class="op">,</span> {</span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"color"</span><span class="op">,</span></span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a>          <span class="dt">r</span><span class="op">:</span> <span class="dv">6</span></span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">text</span>([{<span class="dt">x</span><span class="op">:</span> <span class="op">-</span><span class="fl">0.5</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">2.7</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Original"</span>}<span class="op">,</span> {<span class="dt">x</span><span class="op">:</span> <span class="fl">1.1</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">2.7</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Contextualized"</span>}]<span class="op">,</span> {</span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a>          <span class="dt">text</span><span class="op">:</span> <span class="st">"label"</span><span class="op">,</span></span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a>          <span class="dt">textAnchor</span><span class="op">:</span> <span class="st">"start"</span></span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a>    d3<span class="op">.</span><span class="fu">select</span>(plotContainer)<span class="op">.</span><span class="fu">node</span>()<span class="op">.</span><span class="fu">appendChild</span>(plot)<span class="op">;</span></span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a>  bankSliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">on</span>(<span class="st">"onchange"</span><span class="op">,</span> update)<span class="op">;</span></span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a>  moneySliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">on</span>(<span class="st">"onchange"</span><span class="op">,</span> update)<span class="op">;</span></span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a>  riverSliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">on</span>(<span class="st">"onchange"</span><span class="op">,</span> update)<span class="op">;</span></span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>()<span class="op">;</span></span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div style="display: flex; align-items: center; gap: 40px; justify-content: center;"&gt;</span></span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="display: flex; flex-direction: column; gap: 10px;"&gt;</span></span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>bankSliderObj<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>moneySliderObj<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>riverSliderObj<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/div&gt;</span></span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div&gt;</span></span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>plotContainer<span class="sc">}</span></span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/div&gt;</span></span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb3-204"><a href="#cb3-204" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-3" data-nodetype="expression">

</div>
</div>
</div>
<p>By changing the weights, we see that the vector for “bank” can lean more towards financial terms or geographical terms.</p>
<p>So how do we determine the weights? The simplest idea gives each word equal weight: <span class="math inline">w_i = 1/N</span>, creating a basic bag-of-words average. But sentences aren’t this fair: some words are much more important than others. In “I deposited money at the bank,” the words “deposited” and “money” are key, while “I”, “at”, and “the” add little meaning. If we treat all words the same, we lose the details that matter and need a way to highlight important words and downplay the rest.</p>
</section>
<section id="attention-mechanism" class="level2">
<h2 class="anchored" data-anchor-id="attention-mechanism">Attention Mechanism</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../figs/attention-manga.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p>Let’s walk through how transformers identify the surrounding words that are relevant to a focal word to be contextualized. This process is called the attention mechanism.</p>
<p>Before diving in, let’s prepare some terminology. Suppose we have the sentence “I deposited money at the bank”. Given the word “bank”, we want to determine the weights <span class="math inline">w_i</span> for the surrounding words “I”, “deposited”, “money”, and “at”.</p>
<p>We call “bank” the query word, and the surrounding words the key words. At a high level, we compute the weights <span class="math inline">w_i</span> for each query and key pair, then average them.</p>
<p><span class="math display">
\vec{v}_{\text{query}}^{\text{c}} = \sum_{i=1}^N w_i \cdot \vec{v}_{i}
</span></p>
<p>with weights <span class="math inline">w_i</span> being determined by the query and key vectors <span class="math inline">w_{i}:=f(\vec{v}_{\text{query}}, \vec{v}_{i})</span>. This function, <span class="math inline">f</span>, is called the attention score function.</p>
<p>In transformers, the attention score function <span class="math inline">f</span> is implemented as follows. Given the original vector for a word (whether it’s the query word or the key word), we linearly transform it into three vectors: Query, Key, and Value.</p>
<p><span class="math display">
\begin{align}
\vec{q}_i &amp;= W_Q \vec{x}_i\\
\vec{k}_i &amp;= W_K \vec{x}_i\\
\vec{v}_i &amp;= W_V \vec{x}_i
\end{align}
</span></p>
<p>Why do we need three different vectors? Imagine you’re at a dinner party wanting to identify people talking about a topic you care about. You listen to surrounding people (playing as a listener), broadcast your own interests (playing as a speaker), and engage with conversation content. The query vector represents you as a listener, the key vector represents the people as speakers, and the value vector represents the conversation content.</p>
<p>Once we have the query, key, and value vectors, we compute the attention scores between the query and key vector:</p>
<p><span class="math display">
w_{ij} = \frac{\exp(\vec{q}_i \cdot \vec{k}_j / \sqrt{d})}{\sum_{\ell} \exp(\vec{q}_i \cdot \vec{k}_\ell / \sqrt{d})},
</span></p>
<p>where <span class="math inline">\vec{q}_i \cdot \vec{k}_j</span> is the dot product between the query and key vectors, which is larger when the query and key vectors are similar (pointing to a similar direction).</p>
<p>The division by <span class="math inline">\sqrt{d}</span> (where <span class="math inline">d</span> is the embedding dimension) is a scaling factor that prevents vanishing gradients during training. What is the vanishing gradient problem? It’s when gradients of the loss function with respect to weights become too small to be effective during training.</p>
<p>Finally, compute the contextualized representation as a weighted sum: <span class="math inline">\text{contextualized}_i = \sum_j w_{ij} \vec{v}_j</span>.</p>
<p>Now explore how different Query and Key transformations produce different attention patterns. First, let us create the key, query, and value vectors. In 2d, the linear transformation is just a scaling and a rotation.</p>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb4" data-startfrom="255" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 254;"><span id="cb4-255"><a href="#cb4-255" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">createQKVSlider</span>(min<span class="op">,</span> max<span class="op">,</span> step<span class="op">,</span> width<span class="op">,</span> defaultValue<span class="op">,</span> label<span class="op">,</span> valueSetter) {</span>
<span id="cb4-256"><a href="#cb4-256" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> slider <span class="op">=</span> d3<span class="op">.</span><span class="fu">sliderBottom</span>()</span>
<span id="cb4-257"><a href="#cb4-257" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">min</span>(min)<span class="op">.</span><span class="fu">max</span>(max)<span class="op">.</span><span class="fu">step</span>(step)<span class="op">.</span><span class="fu">width</span>(width)<span class="op">.</span><span class="fu">default</span>(defaultValue)</span>
<span id="cb4-258"><a href="#cb4-258" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">on</span>(<span class="st">'onchange'</span><span class="op">,</span> val <span class="kw">=&gt;</span> <span class="fu">valueSetter</span>(val))<span class="op">;</span></span>
<span id="cb4-259"><a href="#cb4-259" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width <span class="op">+</span> <span class="dv">40</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> <span class="dv">50</span>)<span class="op">;</span></span>
<span id="cb4-260"><a href="#cb4-260" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> g <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="st">"translate(20,15)"</span>)<span class="op">;</span></span>
<span id="cb4-261"><a href="#cb4-261" aria-hidden="true" tabindex="-1"></a>  g<span class="op">.</span><span class="fu">call</span>(slider)<span class="op">;</span></span>
<span id="cb4-262"><a href="#cb4-262" aria-hidden="true" tabindex="-1"></a>  svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (width <span class="op">+</span> <span class="dv">40</span>) <span class="op">/</span> <span class="dv">2</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb4-263"><a href="#cb4-263" aria-hidden="true" tabindex="-1"></a>     <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"11px"</span>)<span class="op">.</span><span class="fu">text</span>(label)<span class="op">;</span></span>
<span id="cb4-264"><a href="#cb4-264" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> { <span class="dt">node</span><span class="op">:</span> svg<span class="op">.</span><span class="fu">node</span>()<span class="op">,</span> <span class="dt">slider</span><span class="op">:</span> slider }<span class="op">;</span></span>
<span id="cb4-265"><a href="#cb4-265" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb5" data-startfrom="270" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 269;"><span id="cb5-270"><a href="#cb5-270" aria-hidden="true" tabindex="-1"></a>mutable qScaleXValue <span class="op">=</span> <span class="fl">1.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-5" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb6" data-startfrom="275" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 274;"><span id="cb6-275"><a href="#cb6-275" aria-hidden="true" tabindex="-1"></a>mutable qScaleYValue <span class="op">=</span> <span class="fl">1.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-6" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb7" data-startfrom="280" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 279;"><span id="cb7-280"><a href="#cb7-280" aria-hidden="true" tabindex="-1"></a>mutable qRotateValue <span class="op">=</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-7" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb8" data-startfrom="285" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 284;"><span id="cb8-285"><a href="#cb8-285" aria-hidden="true" tabindex="-1"></a>mutable kScaleXValue <span class="op">=</span> <span class="fl">1.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-8" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb9" data-startfrom="290" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 289;"><span id="cb9-290"><a href="#cb9-290" aria-hidden="true" tabindex="-1"></a>mutable kScaleYValue <span class="op">=</span> <span class="fl">1.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-9" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb10" data-startfrom="295" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 294;"><span id="cb10-295"><a href="#cb10-295" aria-hidden="true" tabindex="-1"></a>mutable kRotateValue <span class="op">=</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-10" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb11" data-startfrom="300" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 299;"><span id="cb11-300"><a href="#cb11-300" aria-hidden="true" tabindex="-1"></a>qScaleXSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="fl">0.1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="st">"Q Scale X"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable qScaleXValue <span class="op">=</span> val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-11" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb12" data-startfrom="305" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 304;"><span id="cb12-305"><a href="#cb12-305" aria-hidden="true" tabindex="-1"></a>qScaleYSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="fl">0.1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="st">"Q Scale Y"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable qScaleYValue <span class="op">=</span> val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-12" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb13" data-startfrom="310" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 309;"><span id="cb13-310"><a href="#cb13-310" aria-hidden="true" tabindex="-1"></a>qRotateSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="op">-</span><span class="dv">180</span><span class="op">,</span> <span class="dv">180</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="st">"Q Rotate (deg)"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable qRotateValue <span class="op">=</span> val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-13" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb14" data-startfrom="315" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 314;"><span id="cb14-315"><a href="#cb14-315" aria-hidden="true" tabindex="-1"></a>kScaleXSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="fl">0.1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="st">"K Scale X"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable kScaleXValue <span class="op">=</span> val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-14" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb15" data-startfrom="320" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 319;"><span id="cb15-320"><a href="#cb15-320" aria-hidden="true" tabindex="-1"></a>kScaleYSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="fl">0.1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="st">"K Scale Y"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable kScaleYValue <span class="op">=</span> val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-15" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb16" data-startfrom="325" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 324;"><span id="cb16-325"><a href="#cb16-325" aria-hidden="true" tabindex="-1"></a>kRotateSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="op">-</span><span class="dv">180</span><span class="op">,</span> <span class="dv">180</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="st">"K Rotate (deg)"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable kRotateValue <span class="op">=</span> val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-16" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb17" data-startfrom="330" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 329;"><span id="cb17-330"><a href="#cb17-330" aria-hidden="true" tabindex="-1"></a>qkvVisualization <span class="op">=</span> {</span>
<span id="cb17-331"><a href="#cb17-331" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> originalVectors <span class="op">=</span> [</span>
<span id="cb17-332"><a href="#cb17-332" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">name</span><span class="op">:</span> <span class="st">"bank"</span><span class="op">,</span> <span class="dt">vector</span><span class="op">:</span> [<span class="fl">1.5</span><span class="op">,</span> <span class="fl">0.5</span>] }<span class="op">,</span></span>
<span id="cb17-333"><a href="#cb17-333" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">name</span><span class="op">:</span> <span class="st">"money"</span><span class="op">,</span> <span class="dt">vector</span><span class="op">:</span> [<span class="fl">1.8</span><span class="op">,</span> <span class="fl">0.8</span>] }<span class="op">,</span></span>
<span id="cb17-334"><a href="#cb17-334" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">name</span><span class="op">:</span> <span class="st">"river"</span><span class="op">,</span> <span class="dt">vector</span><span class="op">:</span> [<span class="fl">0.5</span><span class="op">,</span> <span class="fl">1.5</span>] }</span>
<span id="cb17-335"><a href="#cb17-335" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb17-336"><a href="#cb17-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-337"><a href="#cb17-337" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qPlotContainer <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">"div"</span>)<span class="op">;</span></span>
<span id="cb17-338"><a href="#cb17-338" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kPlotContainer <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">"div"</span>)<span class="op">;</span></span>
<span id="cb17-339"><a href="#cb17-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-340"><a href="#cb17-340" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">transformVector</span>(vec<span class="op">,</span> scaleX<span class="op">,</span> scaleY<span class="op">,</span> rotateDeg) {</span>
<span id="cb17-341"><a href="#cb17-341" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> theta <span class="op">=</span> (rotateDeg <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span>) <span class="op">/</span> <span class="dv">180</span><span class="op">;</span></span>
<span id="cb17-342"><a href="#cb17-342" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cos <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">cos</span>(theta)<span class="op">;</span></span>
<span id="cb17-343"><a href="#cb17-343" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sin <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(theta)<span class="op">;</span></span>
<span id="cb17-344"><a href="#cb17-344" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> scaledX <span class="op">=</span> vec[<span class="dv">0</span>] <span class="op">*</span> scaleX<span class="op">;</span></span>
<span id="cb17-345"><a href="#cb17-345" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> scaledY <span class="op">=</span> vec[<span class="dv">1</span>] <span class="op">*</span> scaleY<span class="op">;</span></span>
<span id="cb17-346"><a href="#cb17-346" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [</span>
<span id="cb17-347"><a href="#cb17-347" aria-hidden="true" tabindex="-1"></a>      scaledX <span class="op">*</span> cos <span class="op">-</span> scaledY <span class="op">*</span> sin<span class="op">,</span></span>
<span id="cb17-348"><a href="#cb17-348" aria-hidden="true" tabindex="-1"></a>      scaledX <span class="op">*</span> sin <span class="op">+</span> scaledY <span class="op">*</span> cos</span>
<span id="cb17-349"><a href="#cb17-349" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb17-350"><a href="#cb17-350" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-351"><a href="#cb17-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-352"><a href="#cb17-352" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qScaleX <span class="op">=</span> qScaleXValue<span class="op">;</span></span>
<span id="cb17-353"><a href="#cb17-353" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qScaleY <span class="op">=</span> qScaleYValue<span class="op">;</span></span>
<span id="cb17-354"><a href="#cb17-354" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qRotate <span class="op">=</span> qRotateValue<span class="op">;</span></span>
<span id="cb17-355"><a href="#cb17-355" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kScaleX <span class="op">=</span> kScaleXValue<span class="op">;</span></span>
<span id="cb17-356"><a href="#cb17-356" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kScaleY <span class="op">=</span> kScaleYValue<span class="op">;</span></span>
<span id="cb17-357"><a href="#cb17-357" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kRotate <span class="op">=</span> kRotateValue<span class="op">;</span></span>
<span id="cb17-358"><a href="#cb17-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-359"><a href="#cb17-359" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> originalData <span class="op">=</span> originalVectors<span class="op">.</span><span class="fu">map</span>(item <span class="kw">=&gt;</span> ({</span>
<span id="cb17-360"><a href="#cb17-360" aria-hidden="true" tabindex="-1"></a>    <span class="dt">name</span><span class="op">:</span> item<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb17-361"><a href="#cb17-361" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> item<span class="op">.</span><span class="at">vector</span>[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb17-362"><a href="#cb17-362" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> item<span class="op">.</span><span class="at">vector</span>[<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb17-363"><a href="#cb17-363" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"Original"</span></span>
<span id="cb17-364"><a href="#cb17-364" aria-hidden="true" tabindex="-1"></a>  }))<span class="op">;</span></span>
<span id="cb17-365"><a href="#cb17-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-366"><a href="#cb17-366" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qData <span class="op">=</span> originalVectors<span class="op">.</span><span class="fu">map</span>(item <span class="kw">=&gt;</span> {</span>
<span id="cb17-367"><a href="#cb17-367" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> qVec <span class="op">=</span> <span class="fu">transformVector</span>(item<span class="op">.</span><span class="at">vector</span><span class="op">,</span> qScaleX<span class="op">,</span> qScaleY<span class="op">,</span> qRotate)<span class="op">;</span></span>
<span id="cb17-368"><a href="#cb17-368" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb17-369"><a href="#cb17-369" aria-hidden="true" tabindex="-1"></a>      <span class="dt">name</span><span class="op">:</span> <span class="vs">`q_</span><span class="sc">${</span>item<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb17-370"><a href="#cb17-370" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> qVec[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb17-371"><a href="#cb17-371" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> qVec[<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb17-372"><a href="#cb17-372" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">"Query"</span></span>
<span id="cb17-373"><a href="#cb17-373" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb17-374"><a href="#cb17-374" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb17-375"><a href="#cb17-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-376"><a href="#cb17-376" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kData <span class="op">=</span> originalVectors<span class="op">.</span><span class="fu">map</span>(item <span class="kw">=&gt;</span> {</span>
<span id="cb17-377"><a href="#cb17-377" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> kVec <span class="op">=</span> <span class="fu">transformVector</span>(item<span class="op">.</span><span class="at">vector</span><span class="op">,</span> kScaleX<span class="op">,</span> kScaleY<span class="op">,</span> kRotate)<span class="op">;</span></span>
<span id="cb17-378"><a href="#cb17-378" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb17-379"><a href="#cb17-379" aria-hidden="true" tabindex="-1"></a>      <span class="dt">name</span><span class="op">:</span> <span class="vs">`k_</span><span class="sc">${</span>item<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb17-380"><a href="#cb17-380" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> kVec[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb17-381"><a href="#cb17-381" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> kVec[<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb17-382"><a href="#cb17-382" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">"Key"</span></span>
<span id="cb17-383"><a href="#cb17-383" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb17-384"><a href="#cb17-384" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb17-385"><a href="#cb17-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-386"><a href="#cb17-386" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qPlot <span class="op">=</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb17-387"><a href="#cb17-387" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb17-388"><a href="#cb17-388" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb17-389"><a href="#cb17-389" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">40</span><span class="op">,</span></span>
<span id="cb17-390"><a href="#cb17-390" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb17-391"><a href="#cb17-391" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb17-392"><a href="#cb17-392" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb17-393"><a href="#cb17-393" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb17-394"><a href="#cb17-394" aria-hidden="true" tabindex="-1"></a>      <span class="dt">background</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span></span>
<span id="cb17-395"><a href="#cb17-395" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb17-396"><a href="#cb17-396" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb17-397"><a href="#cb17-397" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb17-398"><a href="#cb17-398" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">3</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span></span>
<span id="cb17-399"><a href="#cb17-399" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 1"</span><span class="op">,</span></span>
<span id="cb17-400"><a href="#cb17-400" aria-hidden="true" tabindex="-1"></a>      <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb17-401"><a href="#cb17-401" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb17-402"><a href="#cb17-402" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb17-403"><a href="#cb17-403" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb17-404"><a href="#cb17-404" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">3</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span></span>
<span id="cb17-405"><a href="#cb17-405" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 2"</span><span class="op">,</span></span>
<span id="cb17-406"><a href="#cb17-406" aria-hidden="true" tabindex="-1"></a>      <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb17-407"><a href="#cb17-407" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb17-408"><a href="#cb17-408" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb17-409"><a href="#cb17-409" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb17-410"><a href="#cb17-410" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>([{<span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="dv">0</span>}]<span class="op">,</span> {</span>
<span id="cb17-411"><a href="#cb17-411" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-412"><a href="#cb17-412" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-413"><a href="#cb17-413" aria-hidden="true" tabindex="-1"></a>        <span class="dt">r</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb17-414"><a href="#cb17-414" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb17-415"><a href="#cb17-415" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb17-416"><a href="#cb17-416" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">arrow</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>qData]<span class="op">,</span> {</span>
<span id="cb17-417"><a href="#cb17-417" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x1</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb17-418"><a href="#cb17-418" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y1</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb17-419"><a href="#cb17-419" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x2</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-420"><a href="#cb17-420" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y2</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-421"><a href="#cb17-421" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stroke</span><span class="op">:</span> <span class="st">"type"</span><span class="op">,</span></span>
<span id="cb17-422"><a href="#cb17-422" aria-hidden="true" tabindex="-1"></a>        <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb17-423"><a href="#cb17-423" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headLength</span><span class="op">:</span> <span class="dv">8</span></span>
<span id="cb17-424"><a href="#cb17-424" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb17-425"><a href="#cb17-425" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>qData]<span class="op">,</span> {</span>
<span id="cb17-426"><a href="#cb17-426" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-427"><a href="#cb17-427" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-428"><a href="#cb17-428" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"type"</span><span class="op">,</span></span>
<span id="cb17-429"><a href="#cb17-429" aria-hidden="true" tabindex="-1"></a>        <span class="dt">r</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb17-430"><a href="#cb17-430" aria-hidden="true" tabindex="-1"></a>        <span class="dt">tip</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb17-431"><a href="#cb17-431" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb17-432"><a href="#cb17-432" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>qData]<span class="op">,</span> {</span>
<span id="cb17-433"><a href="#cb17-433" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-434"><a href="#cb17-434" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-435"><a href="#cb17-435" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> <span class="st">"name"</span><span class="op">,</span></span>
<span id="cb17-436"><a href="#cb17-436" aria-hidden="true" tabindex="-1"></a>        <span class="dt">dy</span><span class="op">:</span> <span class="op">-</span><span class="dv">12</span><span class="op">,</span></span>
<span id="cb17-437"><a href="#cb17-437" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">9</span><span class="op">,</span></span>
<span id="cb17-438"><a href="#cb17-438" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb17-439"><a href="#cb17-439" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb17-440"><a href="#cb17-440" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb17-441"><a href="#cb17-441" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([{ <span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">3.4</span> }]<span class="op">,</span> {</span>
<span id="cb17-442"><a href="#cb17-442" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-443"><a href="#cb17-443" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-444"><a href="#cb17-444" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="st">"Query Space"</span><span class="op">,</span></span>
<span id="cb17-445"><a href="#cb17-445" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span></span>
<span id="cb17-446"><a href="#cb17-446" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb17-447"><a href="#cb17-447" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb17-448"><a href="#cb17-448" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb17-449"><a href="#cb17-449" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb17-450"><a href="#cb17-450" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb17-451"><a href="#cb17-451" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="st">"Original"</span><span class="op">,</span> <span class="st">"Query"</span>]<span class="op">,</span></span>
<span id="cb17-452"><a href="#cb17-452" aria-hidden="true" tabindex="-1"></a>      <span class="dt">range</span><span class="op">:</span> [<span class="st">"#666666"</span><span class="op">,</span> <span class="st">"#4682b4"</span>]</span>
<span id="cb17-453"><a href="#cb17-453" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-454"><a href="#cb17-454" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb17-455"><a href="#cb17-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-456"><a href="#cb17-456" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kPlot <span class="op">=</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb17-457"><a href="#cb17-457" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb17-458"><a href="#cb17-458" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb17-459"><a href="#cb17-459" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">40</span><span class="op">,</span></span>
<span id="cb17-460"><a href="#cb17-460" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb17-461"><a href="#cb17-461" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb17-462"><a href="#cb17-462" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb17-463"><a href="#cb17-463" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb17-464"><a href="#cb17-464" aria-hidden="true" tabindex="-1"></a>      <span class="dt">background</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span></span>
<span id="cb17-465"><a href="#cb17-465" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb17-466"><a href="#cb17-466" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb17-467"><a href="#cb17-467" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb17-468"><a href="#cb17-468" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">3</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span></span>
<span id="cb17-469"><a href="#cb17-469" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 1"</span><span class="op">,</span></span>
<span id="cb17-470"><a href="#cb17-470" aria-hidden="true" tabindex="-1"></a>      <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb17-471"><a href="#cb17-471" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb17-472"><a href="#cb17-472" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb17-473"><a href="#cb17-473" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb17-474"><a href="#cb17-474" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">3</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span></span>
<span id="cb17-475"><a href="#cb17-475" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 2"</span><span class="op">,</span></span>
<span id="cb17-476"><a href="#cb17-476" aria-hidden="true" tabindex="-1"></a>      <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb17-477"><a href="#cb17-477" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb17-478"><a href="#cb17-478" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb17-479"><a href="#cb17-479" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb17-480"><a href="#cb17-480" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>([{<span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="dv">0</span>}]<span class="op">,</span> {</span>
<span id="cb17-481"><a href="#cb17-481" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-482"><a href="#cb17-482" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-483"><a href="#cb17-483" aria-hidden="true" tabindex="-1"></a>        <span class="dt">r</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb17-484"><a href="#cb17-484" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb17-485"><a href="#cb17-485" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb17-486"><a href="#cb17-486" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">arrow</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>kData]<span class="op">,</span> {</span>
<span id="cb17-487"><a href="#cb17-487" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x1</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb17-488"><a href="#cb17-488" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y1</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb17-489"><a href="#cb17-489" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x2</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-490"><a href="#cb17-490" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y2</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-491"><a href="#cb17-491" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stroke</span><span class="op">:</span> <span class="st">"type"</span><span class="op">,</span></span>
<span id="cb17-492"><a href="#cb17-492" aria-hidden="true" tabindex="-1"></a>        <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb17-493"><a href="#cb17-493" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headLength</span><span class="op">:</span> <span class="dv">8</span></span>
<span id="cb17-494"><a href="#cb17-494" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb17-495"><a href="#cb17-495" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>kData]<span class="op">,</span> {</span>
<span id="cb17-496"><a href="#cb17-496" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-497"><a href="#cb17-497" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-498"><a href="#cb17-498" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"type"</span><span class="op">,</span></span>
<span id="cb17-499"><a href="#cb17-499" aria-hidden="true" tabindex="-1"></a>        <span class="dt">r</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb17-500"><a href="#cb17-500" aria-hidden="true" tabindex="-1"></a>        <span class="dt">tip</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb17-501"><a href="#cb17-501" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb17-502"><a href="#cb17-502" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>kData]<span class="op">,</span> {</span>
<span id="cb17-503"><a href="#cb17-503" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-504"><a href="#cb17-504" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-505"><a href="#cb17-505" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> <span class="st">"name"</span><span class="op">,</span></span>
<span id="cb17-506"><a href="#cb17-506" aria-hidden="true" tabindex="-1"></a>        <span class="dt">dy</span><span class="op">:</span> <span class="op">-</span><span class="dv">12</span><span class="op">,</span></span>
<span id="cb17-507"><a href="#cb17-507" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">9</span><span class="op">,</span></span>
<span id="cb17-508"><a href="#cb17-508" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb17-509"><a href="#cb17-509" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb17-510"><a href="#cb17-510" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb17-511"><a href="#cb17-511" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([{ <span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">3.4</span> }]<span class="op">,</span> {</span>
<span id="cb17-512"><a href="#cb17-512" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-513"><a href="#cb17-513" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-514"><a href="#cb17-514" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="st">"Key Space"</span><span class="op">,</span></span>
<span id="cb17-515"><a href="#cb17-515" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span></span>
<span id="cb17-516"><a href="#cb17-516" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb17-517"><a href="#cb17-517" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb17-518"><a href="#cb17-518" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb17-519"><a href="#cb17-519" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb17-520"><a href="#cb17-520" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb17-521"><a href="#cb17-521" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="st">"Original"</span><span class="op">,</span> <span class="st">"Key"</span>]<span class="op">,</span></span>
<span id="cb17-522"><a href="#cb17-522" aria-hidden="true" tabindex="-1"></a>      <span class="dt">range</span><span class="op">:</span> [<span class="st">"#666666"</span><span class="op">,</span> <span class="st">"#2e8b57"</span>]</span>
<span id="cb17-523"><a href="#cb17-523" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-524"><a href="#cb17-524" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb17-525"><a href="#cb17-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-526"><a href="#cb17-526" aria-hidden="true" tabindex="-1"></a>  d3<span class="op">.</span><span class="fu">select</span>(qPlotContainer)<span class="op">.</span><span class="fu">node</span>()<span class="op">.</span><span class="fu">appendChild</span>(qPlot)<span class="op">;</span></span>
<span id="cb17-527"><a href="#cb17-527" aria-hidden="true" tabindex="-1"></a>  d3<span class="op">.</span><span class="fu">select</span>(kPlotContainer)<span class="op">.</span><span class="fu">node</span>()<span class="op">.</span><span class="fu">appendChild</span>(kPlot)<span class="op">;</span></span>
<span id="cb17-528"><a href="#cb17-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-529"><a href="#cb17-529" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div style="display: flex; justify-content: center; gap: 40px;"&gt;</span></span>
<span id="cb17-530"><a href="#cb17-530" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="display: flex; flex-direction: column; gap: 20px;"&gt;</span></span>
<span id="cb17-531"><a href="#cb17-531" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div style="display: flex; align-items: center; gap: 20px;"&gt;</span></span>
<span id="cb17-532"><a href="#cb17-532" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style="display: flex; flex-direction: column; gap: 8px;"&gt;</span></span>
<span id="cb17-533"><a href="#cb17-533" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div style="font-weight: bold; margin-bottom: 3px;"&gt;Query (W_Q)&lt;/div&gt;</span></span>
<span id="cb17-534"><a href="#cb17-534" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>qScaleXSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb17-535"><a href="#cb17-535" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>qScaleYSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb17-536"><a href="#cb17-536" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>qRotateSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb17-537"><a href="#cb17-537" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb17-538"><a href="#cb17-538" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span>qPlotContainer<span class="sc">}</span></span>
<span id="cb17-539"><a href="#cb17-539" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb17-540"><a href="#cb17-540" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div style="display: flex; align-items: center; gap: 20px;"&gt;</span></span>
<span id="cb17-541"><a href="#cb17-541" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style="display: flex; flex-direction: column; gap: 8px;"&gt;</span></span>
<span id="cb17-542"><a href="#cb17-542" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div style="font-weight: bold; margin-bottom: 3px;"&gt;Key (W_K)&lt;/div&gt;</span></span>
<span id="cb17-543"><a href="#cb17-543" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>kScaleXSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb17-544"><a href="#cb17-544" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>kScaleYSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb17-545"><a href="#cb17-545" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>kRotateSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb17-546"><a href="#cb17-546" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb17-547"><a href="#cb17-547" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span>kPlotContainer<span class="sc">}</span></span>
<span id="cb17-548"><a href="#cb17-548" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb17-549"><a href="#cb17-549" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/div&gt;</span></span>
<span id="cb17-550"><a href="#cb17-550" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb17-551"><a href="#cb17-551" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-17" data-nodetype="declaration">

</div>
</div>
</div>
<p>Using the transformations above, we can compute the attention weights showing how each word attends to every other word:</p>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb18" data-startfrom="558" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 557;"><span id="cb18-558"><a href="#cb18-558" aria-hidden="true" tabindex="-1"></a>attentionHeatmap <span class="op">=</span> {</span>
<span id="cb18-559"><a href="#cb18-559" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> attentionWords <span class="op">=</span> [<span class="st">"bank"</span><span class="op">,</span> <span class="st">"money"</span><span class="op">,</span> <span class="st">"river"</span>]<span class="op">;</span></span>
<span id="cb18-560"><a href="#cb18-560" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> attentionEmbeddings <span class="op">=</span> [</span>
<span id="cb18-561"><a href="#cb18-561" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">1.5</span><span class="op">,</span> <span class="fl">0.5</span>]<span class="op">,</span></span>
<span id="cb18-562"><a href="#cb18-562" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">1.8</span><span class="op">,</span> <span class="fl">0.8</span>]<span class="op">,</span></span>
<span id="cb18-563"><a href="#cb18-563" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.5</span><span class="op">,</span> <span class="fl">1.5</span>]</span>
<span id="cb18-564"><a href="#cb18-564" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb18-565"><a href="#cb18-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-566"><a href="#cb18-566" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">transformVector</span>(vec<span class="op">,</span> scaleX<span class="op">,</span> scaleY<span class="op">,</span> rotateDeg) {</span>
<span id="cb18-567"><a href="#cb18-567" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> theta <span class="op">=</span> (rotateDeg <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span>) <span class="op">/</span> <span class="dv">180</span><span class="op">;</span></span>
<span id="cb18-568"><a href="#cb18-568" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cos <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">cos</span>(theta)<span class="op">;</span></span>
<span id="cb18-569"><a href="#cb18-569" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sin <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(theta)<span class="op">;</span></span>
<span id="cb18-570"><a href="#cb18-570" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> scaledX <span class="op">=</span> vec[<span class="dv">0</span>] <span class="op">*</span> scaleX<span class="op">;</span></span>
<span id="cb18-571"><a href="#cb18-571" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> scaledY <span class="op">=</span> vec[<span class="dv">1</span>] <span class="op">*</span> scaleY<span class="op">;</span></span>
<span id="cb18-572"><a href="#cb18-572" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [</span>
<span id="cb18-573"><a href="#cb18-573" aria-hidden="true" tabindex="-1"></a>      scaledX <span class="op">*</span> cos <span class="op">-</span> scaledY <span class="op">*</span> sin<span class="op">,</span></span>
<span id="cb18-574"><a href="#cb18-574" aria-hidden="true" tabindex="-1"></a>      scaledX <span class="op">*</span> sin <span class="op">+</span> scaledY <span class="op">*</span> cos</span>
<span id="cb18-575"><a href="#cb18-575" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb18-576"><a href="#cb18-576" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-577"><a href="#cb18-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-578"><a href="#cb18-578" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qScaleX <span class="op">=</span> qScaleXValue<span class="op">;</span></span>
<span id="cb18-579"><a href="#cb18-579" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qScaleY <span class="op">=</span> qScaleYValue<span class="op">;</span></span>
<span id="cb18-580"><a href="#cb18-580" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qRotate <span class="op">=</span> qRotateValue<span class="op">;</span></span>
<span id="cb18-581"><a href="#cb18-581" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kScaleX <span class="op">=</span> kScaleXValue<span class="op">;</span></span>
<span id="cb18-582"><a href="#cb18-582" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kScaleY <span class="op">=</span> kScaleYValue<span class="op">;</span></span>
<span id="cb18-583"><a href="#cb18-583" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kRotate <span class="op">=</span> kRotateValue<span class="op">;</span></span>
<span id="cb18-584"><a href="#cb18-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-585"><a href="#cb18-585" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> Q <span class="op">=</span> attentionEmbeddings<span class="op">.</span><span class="fu">map</span>(vec <span class="kw">=&gt;</span></span>
<span id="cb18-586"><a href="#cb18-586" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transformVector</span>(vec<span class="op">,</span> qScaleX<span class="op">,</span> qScaleY<span class="op">,</span> qRotate)</span>
<span id="cb18-587"><a href="#cb18-587" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb18-588"><a href="#cb18-588" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> K <span class="op">=</span> attentionEmbeddings<span class="op">.</span><span class="fu">map</span>(vec <span class="kw">=&gt;</span></span>
<span id="cb18-589"><a href="#cb18-589" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transformVector</span>(vec<span class="op">,</span> kScaleX<span class="op">,</span> kScaleY<span class="op">,</span> kRotate)</span>
<span id="cb18-590"><a href="#cb18-590" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb18-591"><a href="#cb18-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-592"><a href="#cb18-592" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> scores <span class="op">=</span> Q<span class="op">.</span><span class="fu">map</span>(q <span class="kw">=&gt;</span> K<span class="op">.</span><span class="fu">map</span>(k <span class="kw">=&gt;</span> q[<span class="dv">0</span>] <span class="op">*</span> k[<span class="dv">0</span>] <span class="op">+</span> q[<span class="dv">1</span>] <span class="op">*</span> k[<span class="dv">1</span>]))<span class="op">;</span></span>
<span id="cb18-593"><a href="#cb18-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-594"><a href="#cb18-594" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> attentionWeights <span class="op">=</span> scores<span class="op">.</span><span class="fu">map</span>(row <span class="kw">=&gt;</span> {</span>
<span id="cb18-595"><a href="#cb18-595" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> maxScore <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(<span class="op">...</span>row)<span class="op">;</span></span>
<span id="cb18-596"><a href="#cb18-596" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> expScores <span class="op">=</span> row<span class="op">.</span><span class="fu">map</span>(s <span class="kw">=&gt;</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">exp</span>(s <span class="op">-</span> maxScore))<span class="op">;</span></span>
<span id="cb18-597"><a href="#cb18-597" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sumExp <span class="op">=</span> expScores<span class="op">.</span><span class="fu">reduce</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a <span class="op">+</span> b<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb18-598"><a href="#cb18-598" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> expScores<span class="op">.</span><span class="fu">map</span>(e <span class="kw">=&gt;</span> e <span class="op">/</span> sumExp)<span class="op">;</span></span>
<span id="cb18-599"><a href="#cb18-599" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb18-600"><a href="#cb18-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-601"><a href="#cb18-601" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> heatmapData <span class="op">=</span> (() <span class="kw">=&gt;</span> {</span>
<span id="cb18-602"><a href="#cb18-602" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb18-603"><a href="#cb18-603" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> attentionWords<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb18-604"><a href="#cb18-604" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">let</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> attentionWords<span class="op">.</span><span class="at">length</span><span class="op">;</span> j<span class="op">++</span>) {</span>
<span id="cb18-605"><a href="#cb18-605" aria-hidden="true" tabindex="-1"></a>        data<span class="op">.</span><span class="fu">push</span>({</span>
<span id="cb18-606"><a href="#cb18-606" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Query</span><span class="op">:</span> attentionWords[i]<span class="op">,</span></span>
<span id="cb18-607"><a href="#cb18-607" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Key</span><span class="op">:</span> attentionWords[j]<span class="op">,</span></span>
<span id="cb18-608"><a href="#cb18-608" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Weight</span><span class="op">:</span> attentionWeights[i][j]</span>
<span id="cb18-609"><a href="#cb18-609" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb18-610"><a href="#cb18-610" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb18-611"><a href="#cb18-611" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-612"><a href="#cb18-612" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb18-613"><a href="#cb18-613" aria-hidden="true" tabindex="-1"></a>  })()<span class="op">;</span></span>
<span id="cb18-614"><a href="#cb18-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-615"><a href="#cb18-615" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> heatmapPlot <span class="op">=</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb18-616"><a href="#cb18-616" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">320</span><span class="op">,</span></span>
<span id="cb18-617"><a href="#cb18-617" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">320</span><span class="op">,</span></span>
<span id="cb18-618"><a href="#cb18-618" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb18-619"><a href="#cb18-619" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb18-620"><a href="#cb18-620" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">70</span><span class="op">,</span></span>
<span id="cb18-621"><a href="#cb18-621" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">80</span><span class="op">,</span></span>
<span id="cb18-622"><a href="#cb18-622" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb18-623"><a href="#cb18-623" aria-hidden="true" tabindex="-1"></a>      <span class="dt">background</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span></span>
<span id="cb18-624"><a href="#cb18-624" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb18-625"><a href="#cb18-625" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb18-626"><a href="#cb18-626" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb18-627"><a href="#cb18-627" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Key Word"</span><span class="op">,</span></span>
<span id="cb18-628"><a href="#cb18-628" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> attentionWords</span>
<span id="cb18-629"><a href="#cb18-629" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb18-630"><a href="#cb18-630" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb18-631"><a href="#cb18-631" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Query Word"</span><span class="op">,</span></span>
<span id="cb18-632"><a href="#cb18-632" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> attentionWords</span>
<span id="cb18-633"><a href="#cb18-633" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb18-634"><a href="#cb18-634" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb18-635"><a href="#cb18-635" aria-hidden="true" tabindex="-1"></a>      <span class="dt">scheme</span><span class="op">:</span> <span class="st">"Blues"</span><span class="op">,</span></span>
<span id="cb18-636"><a href="#cb18-636" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Attention"</span><span class="op">,</span></span>
<span id="cb18-637"><a href="#cb18-637" aria-hidden="true" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb18-638"><a href="#cb18-638" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb18-639"><a href="#cb18-639" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb18-640"><a href="#cb18-640" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">cell</span>(heatmapData<span class="op">,</span> {</span>
<span id="cb18-641"><a href="#cb18-641" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"Key"</span><span class="op">,</span></span>
<span id="cb18-642"><a href="#cb18-642" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"Query"</span><span class="op">,</span></span>
<span id="cb18-643"><a href="#cb18-643" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"Weight"</span><span class="op">,</span></span>
<span id="cb18-644"><a href="#cb18-644" aria-hidden="true" tabindex="-1"></a>        <span class="dt">tip</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb18-645"><a href="#cb18-645" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb18-646"><a href="#cb18-646" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>(heatmapData<span class="op">,</span> {</span>
<span id="cb18-647"><a href="#cb18-647" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"Key"</span><span class="op">,</span></span>
<span id="cb18-648"><a href="#cb18-648" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"Query"</span><span class="op">,</span></span>
<span id="cb18-649"><a href="#cb18-649" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">Weight</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">,</span></span>
<span id="cb18-650"><a href="#cb18-650" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">Weight</span> <span class="op">&gt;</span> <span class="fl">0.35</span> <span class="op">?</span> <span class="st">"white"</span> <span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb18-651"><a href="#cb18-651" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">11</span></span>
<span id="cb18-652"><a href="#cb18-652" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb18-653"><a href="#cb18-653" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([{ <span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="dv">0</span> }]<span class="op">,</span> {</span>
<span id="cb18-654"><a href="#cb18-654" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> () <span class="kw">=&gt;</span> attentionWords<span class="op">.</span><span class="at">length</span> <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb18-655"><a href="#cb18-655" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="op">-</span><span class="fl">0.8</span><span class="op">,</span></span>
<span id="cb18-656"><a href="#cb18-656" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="st">"Attention Weights (Softmax)"</span><span class="op">,</span></span>
<span id="cb18-657"><a href="#cb18-657" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span></span>
<span id="cb18-658"><a href="#cb18-658" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb18-659"><a href="#cb18-659" aria-hidden="true" tabindex="-1"></a>        <span class="dt">frameAnchor</span><span class="op">:</span> <span class="st">"top"</span><span class="op">,</span></span>
<span id="cb18-660"><a href="#cb18-660" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb18-661"><a href="#cb18-661" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb18-662"><a href="#cb18-662" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb18-663"><a href="#cb18-663" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb18-664"><a href="#cb18-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-665"><a href="#cb18-665" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div style="display: flex; justify-content: center;"&gt;</span></span>
<span id="cb18-666"><a href="#cb18-666" aria-hidden="true" tabindex="-1"></a><span class="vs">    </span><span class="sc">${</span>heatmapPlot<span class="sc">}</span></span>
<span id="cb18-667"><a href="#cb18-667" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb18-668"><a href="#cb18-668" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-18" data-nodetype="declaration">

</div>
</div>
</div>
<p>Rows represent words asking for context (Queries), while columns represent words providing context (Keys). Each cell <span class="math inline">(i,j)</span> indicates how much word <span class="math inline">i</span> attends to word <span class="math inline">j</span>, with each row summing to 1 to form a probability distribution over context words.</p>
</section>
<section id="multi-head-attention" class="level2">
<h2 class="anchored" data-anchor-id="multi-head-attention">Multi-head Attention</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../figs/multihead-attention-manga.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p>Putting it all together (query-key-value transformation, attention matrix, and softmax normalization), this forms one attention head of the transformer. But we can have multiple attention heads in parallel, each with its own query-key-value transformation, attention matrix, and softmax normalization. The output of the attention heads are concatenated and then passed through a linear transformation to produce the final output.</p>
<p><span class="math display">
\text{Output} = \text{Linear}(\text{Concat}(\text{head}_1, \text{head}_2, \ldots, \text{head}_h))
</span></p>
<p>This is one attention block of the transformer. Why multiple heads? Having parallel attention heads is a powerful technique to capture different aspects of the input data. The model can learn multiple relationships between the words in the input data.</p>
</section>
<section id="transformer-architecture" class="level2">
<h2 class="anchored" data-anchor-id="transformer-architecture">Transformer Architecture</h2>
<p>Let’s step back and look at the transformer architecture at a high level. We base our discussion on the original Transformer paper, “Attention Is All You Need”, noting that the transformer architecture has evolved since then with many variants.</p>
<section id="encoder-module" class="level3">
<h3 class="anchored" data-anchor-id="encoder-module">Encoder Module</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*7sjcgd_nyODdLbZSxyxz_g.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></p>
</figure>
</div>
<p>The encoder module consists of position embedding, multi-head attention, residual connection, and layer normalization, along with feed-forward networks.</p>
<p>Let us go through each component in detail.</p>
<section id="position-embedding" class="level4">
<h4 class="anchored" data-anchor-id="position-embedding">Position Embedding</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../figs/transformer-position-encoding-manga.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p>In the encoder module, we start from the positional encoding, which fixes a key issue: the attention modules are permutation invariant (attention produces the same output even if we shuffle the words in the sentence). But position matters in language understanding and generation, so position encoding fixes this issue.</p>
<p>Let’s approach position encoding from a naive perspective. Suppose we have a sequence of <span class="math inline">T</span> token embeddings, denoted by <span class="math inline">x_1, x_2, ..., x_T</span>, each a <span class="math inline">d</span>-dimensional vector.</p>
<p>A simple way to encode position is to add a position index to each token embedding:</p>
<p><span class="math display">
x_t := x_t + \beta t,
</span></p>
<p>where <span class="math inline">t = 1, 2, ..., T</span> is the position index of the token in the sequence, and <span class="math inline">\beta</span> is the step size.</p>
<p>This appears simple but has critical problems. First, the position index can be arbitrarily large: when models see sequences longer than those in training data, they’ll be exposed to position indices they’ve never seen before. Second, the position index is discrete, meaning the model cannot capture position information smoothly.</p>
<p>Because this naive approach has problems, consider another approach. Let’s represent position using a binary vector of length <span class="math inline">d</span>. For example, with <span class="math inline">d=4</span>:</p>
<p><span class="math display">
\begin{align*}
  0: \ \ \ \ \color{orange}{\texttt{0}} \ \ \color{green}{\texttt{0}} \ \ \color{blue}{\texttt{0}} \ \ \color{red}{\texttt{0}} &amp; &amp;
  8: \ \ \ \ \color{orange}{\texttt{1}} \ \ \color{green}{\texttt{0}} \ \ \color{blue}{\texttt{0}} \ \ \color{red}{\texttt{0}} \\
  1: \ \ \ \ \color{orange}{\texttt{0}} \ \ \color{green}{\texttt{0}} \ \ \color{blue}{\texttt{0}} \ \ \color{red}{\texttt{1}} &amp; &amp;
  9: \ \ \ \ \color{orange}{\texttt{1}} \ \ \color{green}{\texttt{0}} \ \ \color{blue}{\texttt{0}} \ \ \color{red}{\texttt{1}} \\
  2: \ \ \ \ \color{orange}{\texttt{0}} \ \ \color{green}{\texttt{0}} \ \ \color{blue}{\texttt{1}} \ \ \color{red}{\texttt{0}} &amp; &amp;
  10: \ \ \ \ \color{orange}{\texttt{1}} \ \ \color{green}{\texttt{0}} \ \ \color{blue}{\texttt{1}} \ \ \color{red}{\texttt{0}} \\
  3: \ \ \ \ \color{orange}{\texttt{0}} \ \ \color{green}{\texttt{0}} \ \ \color{blue}{\texttt{1}} \ \ \color{red}{\texttt{1}} &amp; &amp;
  11: \ \ \ \ \color{orange}{\texttt{1}} \ \ \color{green}{\texttt{0}} \ \ \color{blue}{\texttt{1}} \ \ \color{red}{\texttt{1}} \\
  4: \ \ \ \ \color{orange}{\texttt{0}} \ \ \color{green}{\texttt{1}} \ \ \color{blue}{\texttt{0}} \ \ \color{red}{\texttt{0}} &amp; &amp;
  12: \ \ \ \ \color{orange}{\texttt{1}} \ \ \color{green}{\texttt{1}} \ \ \color{blue}{\texttt{0}} \ \ \color{red}{\texttt{0}} \\
  5: \ \ \ \ \color{orange}{\texttt{0}} \ \ \color{green}{\texttt{1}} \ \ \color{blue}{\texttt{0}} \ \ \color{red}{\texttt{1}} &amp; &amp;
  13: \ \ \ \ \color{orange}{\texttt{1}} \ \ \color{green}{\texttt{1}} \ \ \color{blue}{\texttt{0}} \ \ \color{red}{\texttt{1}} \\
  6: \ \ \ \ \color{orange}{\texttt{0}} \ \ \color{green}{\texttt{1}} \ \ \color{blue}{\texttt{1}} \ \ \color{red}{\texttt{0}} &amp; &amp;
  14: \ \ \ \ \color{orange}{\texttt{1}} \ \ \color{green}{\texttt{1}} \ \ \color{blue}{\texttt{1}} \ \ \color{red}{\texttt{0}} \\
  7: \ \ \ \ \color{orange}{\texttt{0}} \ \ \color{green}{\texttt{1}} \ \ \color{blue}{\texttt{1}} \ \ \color{red}{\texttt{1}} &amp; &amp;
  15: \ \ \ \ \color{orange}{\texttt{1}} \ \ \color{green}{\texttt{1}} \ \ \color{blue}{\texttt{1}} \ \ \color{red}{\texttt{1}} \\
\end{align*}
</span></p>
<p>Then, use the binary vector as the position embedding:</p>
<p><span class="math display">
x_{t,i} := x_{t,i} + \text{Pos}(t, i),
</span></p>
<p>where <span class="math inline">\text{Pos}(t, i)</span> is the position embedding vector of position index <span class="math inline">t</span> and dimension index <span class="math inline">i</span>.</p>
<p>This representation is bounded between 0 and 1, yet still discrete.</p>
<p>What’s a better approach? An elegant position embedding used in transformers is sinusoidal position embedding, which appears complicated but stay with me.</p>
<p><span class="math display">
\text{Pos}(t, i) =
\begin{cases}
\sin\left(\dfrac{t}{10000^{2i/d}}\right), &amp; \text{if } i \text{ is even} \\
\cos\left(\dfrac{t}{10000^{2i/d}}\right), &amp; \text{if } i \text{ is odd}
\end{cases},
</span></p>
<p>where <span class="math inline">i</span> is the dimension index of the position embedding vector. This position embedding is added to the input token embedding as:</p>
<p><span class="math display">
x_{t,i} := x_{t,i} + \text{Pos}(t, i),
</span></p>
<p>It appears complicated, but it’s a continuous version of the binary position embedding above.</p>
<p>To see this, let’s plot the position embedding for the first 100 positions.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kazemnejad.com/img/transformer_architecture_positional_encoding/positional_encoding.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p>The position embedding exhibits the alternating pattern (vertically) with frequency increasing as the dimension index increases (horizontal axis). Additionally, sinusoidal position embedding is continuous, allowing the model to capture position information smoothly.</p>
<p>Another key property: the dot similarity between two position embedding vectors represents the similarity between the two positions, regardless of the position index.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://kazemnejad.com/img/transformer_architecture_positional_encoding/time-steps_dot_product.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p>The dot similarity between position embedding vectors represents the distance between positions, regardless of the position index.</p>
<p>Why additive position embedding? Sinusoidal position embedding is additive, altering the token embedding. Alternatively, one might concatenate the position embedding to the token embedding: <span class="math inline">x_{t,i} := [x_{t,i}; \text{Pos}(t, i)]</span>, which makes it easier for a model to distinguish position from token information. So why not use concatenation? Concatenation requires a larger embedding dimension, increasing the number of parameters. Instead, adding the position embedding creates an interesting effect in the attention mechanism (interested readers can check out <a href="https://www.reddit.com/r/MachineLearning/comments/cttefo/comment/exs7d08/?utm_source=reddit&amp;utm_medium=web2x&amp;context=3">this Reddit post</a>).</p>
<p>What about alternatives? Absolute position embedding is what we discussed above, where each position is represented by a unique vector. Relative position embedding, on the other hand, represents the position difference between two positions rather than the absolute position.</p>
<p>Relative position embedding can be implemented by adding a learnable scalar to the unnormalized attention scores before softmax:</p>
<p><span class="math display">
\text{Attention}(Q, K, V) = \text{softmax}\left(\frac{QK^T + B}{\sqrt{d_k}}\right)V
</span></p>
<p>where <span class="math inline">B</span> is a learnable offset matrix added to the unnormalized attention scores. The matrix <span class="math inline">B</span> is a function of the position difference between query and key: <span class="math inline">B = f(i-j)</span>, where <span class="math inline">i</span> and <span class="math inline">j</span> are the position indices of query and key. Such formulation is useful when the model needs to capture relative position between tokens.</p>
</section>
<section id="residual-connection" class="level4">
<h4 class="anchored" data-anchor-id="residual-connection">Residual Connection</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../figs/transformer-residual-connection-manga.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p>Another important component is the residual connection. The input is first passed through multi-head attention, followed by layer normalization. Notice the parallel path from input to the output of the attention module, called a residual connection (or skip connection), a technique used to stabilize the training of deep neural networks by mitigating the problem of too large or too small input values that can cause network instability.</p>
<p>Let’s denote by <span class="math inline">f</span> the neural network we want to train (the multi-head attention or feed-forward networks in the transformer block).</p>
<p>The residual connection is defined as:</p>
<p><span class="math display">
\underbrace{x_{\text{out}}}_{\text{output}} = \underbrace{x_{\text{in}}}_{\text{input}} + \underbrace{f(x_{\text{in}})}_{\text{component}}.
</span></p>
<p>Rather than learning the complete mapping from input to output, the network <span class="math inline">f</span> learns to model the residual (difference) between them. This is particularly advantageous when the desired transformation approximates an identity mapping, as the network can simply learn to output values near zero.</p>
<p>Why are residual connections important? Residual connections help prevent the vanishing gradient problem. Deep learning models like LLMs consist of many layers, trained to minimize the loss function <span class="math inline">{\cal L}_{\text{loss}}</span> with respect to parameters <span class="math inline">\theta</span>.</p>
<p>The gradient of the loss is computed using the chain rule:</p>
<p><span class="math display">
\frac{\partial {\cal L}_{\text{loss}}}{\partial \theta} = \frac{\partial {\cal L}_{\text{loss}}}{\partial f_L} \cdot \frac{\partial f_L}{\partial f_{L-1}} \cdot \frac{\partial f_{L-1}}{\partial f_{L-2}} \cdot ... \cdot \frac{\partial f_{l+1}}{\partial f_l} \cdot \frac{\partial f_l}{\partial \theta}
</span></p>
<p>where <span class="math inline">f_i</span> is the output of the <span class="math inline">i</span>-th layer.</p>
<p>The gradient vanishing problem occurs when the individual terms <span class="math inline">\frac{\partial f_{i+1}}{\partial f_i}</span> are less than 1. As a result, the gradient becomes smaller and smaller as it flows backward through earlier layers.</p>
<p>By adding the residual connection, the gradient for the individual term becomes:</p>
<p><span class="math display">
\frac{\partial x_{i+1}}{\partial x_i} = 1 + \frac{\partial f_i(x_i)}{\partial x_i}
</span></p>
<p>Notice the “+1” term, which is the direct path from input to output. The chain rule is thus modified to include this term.</p>
<p>When we expand the product, we can group terms by their order (how many <span class="math inline">\partial f_i</span> terms are multiplied together):</p>
<p><span class="math display">1 + O_1 + O_2 + O_3 + ...</span></p>
<p>where the <span class="math inline">O_n</span> terms represent various combinations of gradients at different orders.</p>
<p>Without the residual connection, we only have the highest-order terms, which are subject to the gradient vanishing problem. With the residual connection, we have lower-order terms like <span class="math inline">O_1, O_2, O_3, ...</span>, which are less susceptible to gradient vanishing.</p>
<p>Residual connections are an architectural innovation that allows neural networks to be much deeper without degrading performance. They were proposed by He et al.&nbsp;for image processing from Microsoft Research.</p>
<p>Residual connections also help prevent gradient explosion by providing alternative paths for gradients to flow. By distributing gradients between the residual path and the learning component path, the gradient is less likely to explode.</p>
</section>
<section id="layer-normalization" class="level4">
<h4 class="anchored" data-anchor-id="layer-normalization">Layer Normalization</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../figs/transformer-layer-normalization-manga.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p>In transformer models, you find multiple layer normalization steps. Layer normalization is a technique used to stabilize the training of deep neural networks by mitigating the problem of too large or too small input values that can cause network instability.</p>
<p>More specifically, layer normalization is computed as:</p>
<p><span class="math display">
\text{LayerNorm}(x) = \gamma \frac{x - \mu}{\sigma} + \beta,
</span></p>
<p>where <span class="math inline">\mu</span> and <span class="math inline">\sigma</span> are the mean and standard deviation of the input, <span class="math inline">\gamma</span> is the scaling factor, and <span class="math inline">\beta</span> is the shifting factor.</p>
<p>The variables <span class="math inline">\gamma</span> and <span class="math inline">\beta</span> are learnable parameters initialized to 1 and 0, and updated during training.</p>
<p>Note that layer normalization is applied to individual tokens: the normalization is token-wise rather than feature-wise, with mean and standard deviation calculated for each token across all feature dimensions. This differs from feature-wise normalization, where mean and standard deviation are calculated for each feature across all tokens.</p>
</section>
</section>
</section>
<section id="decoder-module" class="level2">
<h2 class="anchored" data-anchor-id="decoder-module">Decoder Module</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://res.cloudinary.com/edlitera/image/upload/c_fill,f_auto/v1680629118/blog/gz5ccspg3yvq4eo6xhrr.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></p>
</figure>
</div>
<section id="causal-attention" class="level3">
<h3 class="anchored" data-anchor-id="causal-attention">Causal Attention</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../figs/transformer-causal-attention-manga.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p>One key advantage of transformers is their ability to generate contextualized vectors in parallel. Recurrent neural networks (RNNs) read the input sequence sequentially, limiting parallelism. Transformer models, on the other hand, can compute attention scores and weighted averages of value vectors in parallel, generating contextualized vectors at once, which speeds up training.</p>
<p>In the decoder module, a vector is contextualized by attending to the previous vectors in the sequence. Importantly, it should not see the future token vectors, as that’s what the model is tasked to predict. We prevent this by setting the attention scores to zero for future tokens. Another benefit of causal attention: the model doesn’t suffer from the error accumulation problem, where prediction error from one step carries over to the next.</p>
<p>How do we implement the masking? We set the attention scores to negative infinity for future tokens before the softmax operation, effectively zeroing out their contribution:</p>
<p><span class="math display">
\text{Mask}(Q, K, V) = \text{softmax}\left(\frac{QK^T + M}{\sqrt{d_k}}\right)V
</span></p>
<p>where <span class="math inline">M</span> is a matrix with <span class="math inline">-\infty</span> for positions corresponding to future tokens. The result is attention scores where tokens attend only to previous tokens.</p>
</section>
<section id="cross-attention" class="level3">
<h3 class="anchored" data-anchor-id="cross-attention">Cross-Attention</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../figs/transformer-cross-attention-manga.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p>Cross-attention occurs when the Query comes from one sequence (like a sentence being generated) and the Keys and Values come from another sequence (like the input sentence you want to translate). Here, the model learns to align information from input to output, a sort of bilingual dictionary lookup, but learned and fuzzy.</p>
<p>The mechanism works by using queries (Q) from the decoder’s previous layer and keys (K) and values (V) from the encoder’s output. This enables each position in the decoder to attend to the full encoder sequence without any masking, since encoding is already complete.</p>
<p>For instance, in translating “I love you” to “Je t’aime”, cross-attention helps each French word focus on relevant English words (“Je” attends to “I”, and “t’aime” to “love”), maintaining semantic relationships between input and output.</p>
<p>The cross-attention formula is:</p>
<p><span class="math display">
\text{CrossAttention}(Q, K, V) = \text{softmax}\left(\frac{QK^T}{\sqrt{d_k}}\right)V
</span></p>
<p>where Q comes from the decoder and K, V come from the encoder. This effectively bridges the encoding and decoding processes.</p>
</section>
</section>
<section id="putting-it-all-together" class="level2">
<h2 class="anchored" data-anchor-id="putting-it-all-together">Putting It All Together</h2>
<p>Let’s overview the transformer architecture and see how the components fit into the overall architecture.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://machinelearningmastery.com/wp-content/uploads/2025/05/Full_Transformer.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p>We hope that you now have a better understanding of the transformer architecture and how the components fit together into the overall architecture.</p>
</section>
<section id="the-key-insight" class="level2">
<h2 class="anchored" data-anchor-id="the-key-insight">The Key Insight</h2>
<p>Every time you use GPT (ChatGPT, Claude, Gemini, etc.), you’re seeing transformers in action. Transformers don’t “think”. They perform statistical pattern matching at scale.</p>


</section>

</main> <!-- /main -->
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W3sibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6ImQzID0gcmVxdWlyZShcImQzQDdcIiwgXCJkMy1zaW1wbGUtc2xpZGVyQDFcIilcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMiIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6ImZ1bmN0aW9uIHNsaWRlcldpdGhMYWJlbChtaW4sIG1heCwgc3RlcCwgd2lkdGgsIGRlZmF1bHRWYWx1ZSwgbGFiZWwpIHtcbiAgY29uc3Qgc2xpZGVyID0gZDMuc2xpZGVyQm90dG9tKClcbiAgICAubWluKG1pbikubWF4KG1heCkuc3RlcChzdGVwKS53aWR0aCh3aWR0aCkuZGVmYXVsdChkZWZhdWx0VmFsdWUpO1xuICBjb25zdCBzdmcgPSBkMy5jcmVhdGUoXCJzdmdcIikuYXR0cihcIndpZHRoXCIsIHdpZHRoICsgNTApLmF0dHIoXCJoZWlnaHRcIiwgNjApO1xuICBzdmcuYXBwZW5kKFwiZ1wiKS5hdHRyKFwidHJhbnNmb3JtXCIsIFwidHJhbnNsYXRlKDI1LDIwKVwiKS5jYWxsKHNsaWRlcik7XG4gIHN2Zy5hcHBlbmQoXCJ0ZXh0XCIpLmF0dHIoXCJ4XCIsICh3aWR0aCArIDUwKSAvIDIpLmF0dHIoXCJ5XCIsIDEwKS5hdHRyKFwidGV4dC1hbmNob3JcIiwgXCJtaWRkbGVcIikuc3R5bGUoXCJmb250LXNpemVcIiwgXCI1cHhcIikudGV4dChsYWJlbCk7XG4gIHJldHVybiBzdmcubm9kZSgpO1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0zIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoie1xuICBmdW5jdGlvbiBjcmVhdGVXZWlnaHRTbGlkZXIobWluLCBtYXgsIHN0ZXAsIHdpZHRoLCBkZWZhdWx0VmFsdWUsIGxhYmVsKSB7XG4gICAgY29uc3Qgc2xpZGVyID0gZDMuc2xpZGVyQm90dG9tKClcbiAgICAgIC5taW4obWluKS5tYXgobWF4KS5zdGVwKHN0ZXApLndpZHRoKHdpZHRoKS5kZWZhdWx0KGRlZmF1bHRWYWx1ZSk7XG4gICAgY29uc3Qgc3ZnID0gZDMuY3JlYXRlKFwic3ZnXCIpLmF0dHIoXCJ3aWR0aFwiLCB3aWR0aCArIDUwKS5hdHRyKFwiaGVpZ2h0XCIsIDYwKTtcbiAgICBjb25zdCBnID0gc3ZnLmFwcGVuZChcImdcIikuYXR0cihcInRyYW5zZm9ybVwiLCBcInRyYW5zbGF0ZSgyNSwyMClcIik7XG4gICAgZy5jYWxsKHNsaWRlcik7XG4gICAgc3ZnLmFwcGVuZChcInRleHRcIikuYXR0cihcInhcIiwgKHdpZHRoICsgNTApIC8gMikuYXR0cihcInlcIiwgMTApXG4gICAgICAgLmF0dHIoXCJ0ZXh0LWFuY2hvclwiLCBcIm1pZGRsZVwiKS5zdHlsZShcImZvbnQtc2l6ZVwiLCBcIjEycHhcIikudGV4dChsYWJlbCk7XG4gICAgcmV0dXJuIHsgbm9kZTogc3ZnLm5vZGUoKSwgc2xpZGVyOiBzbGlkZXIgfTtcbiAgfVxuXG4gIGNvbnN0IGJhbmtTbGlkZXJPYmogPSBjcmVhdGVXZWlnaHRTbGlkZXIoMCwgMSwgMC4wMSwgMTIwLCAxLjAsIFwiQmFuayB3ZWlnaHRcIik7XG4gIGNvbnN0IG1vbmV5U2xpZGVyT2JqID0gY3JlYXRlV2VpZ2h0U2xpZGVyKDAsIDEsIDAuMDEsIDEyMCwgMC4wLCBcIk1vbmV5IHdlaWdodFwiKTtcbiAgY29uc3Qgcml2ZXJTbGlkZXJPYmogPSBjcmVhdGVXZWlnaHRTbGlkZXIoMCwgMSwgMC4wMSwgMTIwLCAwLjAsIFwiUml2ZXIgd2VpZ2h0XCIpO1xuXG4gIGNvbnN0IGNvbnRleHRXb3JkcyA9IFtcImJhbmtcIiwgXCJtb25leVwiLCBcInJpdmVyXCJdO1xuICBjb25zdCBjb250ZXh0RW1iZWRkaW5ncyA9IFtcbiAgICBbMC4wLCAwLjBdLFxuICAgIFstMS42LCAtMC42XSxcbiAgICBbMS40LCAtMS4wXVxuICBdO1xuXG4gIGNvbnN0IHBsb3RDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuXG4gIGZ1bmN0aW9uIHVwZGF0ZSgpIHtcbiAgICBjb25zdCBiYW5rV2VpZ2h0ID0gYmFua1NsaWRlck9iai5zbGlkZXIudmFsdWUoKTtcbiAgICBjb25zdCBtb25leVdlaWdodCA9IG1vbmV5U2xpZGVyT2JqLnNsaWRlci52YWx1ZSgpO1xuICAgIGNvbnN0IHJpdmVyV2VpZ2h0ID0gcml2ZXJTbGlkZXJPYmouc2xpZGVyLnZhbHVlKCk7XG5cbiAgICBjb25zdCB3ZWlnaHRzID0gW2JhbmtXZWlnaHQsIG1vbmV5V2VpZ2h0LCByaXZlcldlaWdodF07XG4gICAgY29uc3QgdG90YWwgPSB3ZWlnaHRzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApO1xuICAgIGNvbnN0IG5vcm1hbGl6ZWRXZWlnaHRzID0gdG90YWwgPiAwID8gd2VpZ2h0cy5tYXAodyA9PiB3IC8gdG90YWwpIDogWzAsIDAsIDBdO1xuXG4gICAgY29uc3QgbmV3VmVjID0gW1xuICAgICAgbm9ybWFsaXplZFdlaWdodHNbMF0gKiBjb250ZXh0RW1iZWRkaW5nc1swXVswXSArXG4gICAgICBub3JtYWxpemVkV2VpZ2h0c1sxXSAqIGNvbnRleHRFbWJlZGRpbmdzWzFdWzBdICtcbiAgICAgIG5vcm1hbGl6ZWRXZWlnaHRzWzJdICogY29udGV4dEVtYmVkZGluZ3NbMl1bMF0sXG4gICAgICBub3JtYWxpemVkV2VpZ2h0c1swXSAqIGNvbnRleHRFbWJlZGRpbmdzWzBdWzFdICtcbiAgICAgIG5vcm1hbGl6ZWRXZWlnaHRzWzFdICogY29udGV4dEVtYmVkZGluZ3NbMV1bMV0gK1xuICAgICAgbm9ybWFsaXplZFdlaWdodHNbMl0gKiBjb250ZXh0RW1iZWRkaW5nc1syXVsxXVxuICAgIF07XG5cbiAgICBjb25zdCBvcmlnaW5hbERhdGEgPSBjb250ZXh0V29yZHMubWFwKCh3b3JkLCBpKSA9PiAoe1xuICAgICAgd29yZDogd29yZCxcbiAgICAgIHg6IGNvbnRleHRFbWJlZGRpbmdzW2ldWzBdLFxuICAgICAgeTogY29udGV4dEVtYmVkZGluZ3NbaV1bMV0sXG4gICAgICB0eXBlOiBcIk9yaWdpbmFsXCJcbiAgICB9KSk7XG5cbiAgICBjb25zdCBjb250ZXh0dWFsaXplZERhdGEgPSBbe1xuICAgICAgd29yZDogXCJiYW5rIChuZXcpXCIsXG4gICAgICB4OiBuZXdWZWNbMF0sXG4gICAgICB5OiBuZXdWZWNbMV0sXG4gICAgICB0eXBlOiBcIkNvbnRleHR1YWxpemVkXCJcbiAgICB9XTtcblxuICAgIGNvbnN0IGRhdGEgPSBbLi4ub3JpZ2luYWxEYXRhLCAuLi5jb250ZXh0dWFsaXplZERhdGFdO1xuXG4gICAgZDMuc2VsZWN0KHBsb3RDb250YWluZXIpLnNlbGVjdEFsbChcIipcIikucmVtb3ZlKCk7XG5cbiAgICBjb25zdCBwbG90ID0gUGxvdC5wbG90KHtcbiAgICAgIHdpZHRoOiAzMDAsXG4gICAgICBoZWlnaHQ6IDMwMCxcbiAgICAgIG1hcmdpblRvcDogNjAsXG4gICAgICBtYXJnaW5SaWdodDogMjAsXG4gICAgICBtYXJnaW5Cb3R0b206IDUwLFxuICAgICAgbWFyZ2luTGVmdDogNjAsXG4gICAgICBzdHlsZToge1xuICAgICAgICBiYWNrZ3JvdW5kOiBcIndoaXRlXCIsXG4gICAgICAgIGNvbG9yOiBcImJsYWNrXCJcbiAgICAgIH0sXG4gICAgICB4OiB7XG4gICAgICAgIGRvbWFpbjogWy0yLCAyXSxcbiAgICAgICAgbGFiZWw6IFwiRGltZW5zaW9uIDFcIixcbiAgICAgICAgZ3JpZDogdHJ1ZSxcbiAgICAgICAgdGlja3M6IDEwXG4gICAgICB9LFxuICAgICAgeToge1xuICAgICAgICBkb21haW46IFstMiwgMl0sXG4gICAgICAgIGxhYmVsOiBcIkRpbWVuc2lvbiAyXCIsXG4gICAgICAgIGdyaWQ6IHRydWUsXG4gICAgICAgIHRpY2tzOiAxMFxuICAgICAgfSxcbiAgICAgIGNvbG9yOiB7XG4gICAgICAgIGRvbWFpbjogW1wiT3JpZ2luYWxcIiwgXCJDb250ZXh0dWFsaXplZFwiXSxcbiAgICAgICAgcmFuZ2U6IFtcIiNkYWRhZGFcIiwgXCIjZmY3ZjBlXCJdXG4gICAgICB9LFxuICAgICAgbWFya3M6IFtcbiAgICAgICAgUGxvdC5kb3QoZGF0YSwge1xuICAgICAgICAgIHg6IFwieFwiLFxuICAgICAgICAgIHk6IFwieVwiLFxuICAgICAgICAgIGZpbGw6IFwidHlwZVwiLFxuICAgICAgICAgIHI6IDgsXG4gICAgICAgICAgdGlwOiB0cnVlXG4gICAgICAgIH0pLFxuICAgICAgICBQbG90LnRleHQoZGF0YSwge1xuICAgICAgICAgIHg6IFwieFwiLFxuICAgICAgICAgIHk6IFwieVwiLFxuICAgICAgICAgIHRleHQ6IFwid29yZFwiLFxuICAgICAgICAgIGR5OiAtMTUsXG4gICAgICAgICAgZm9udFNpemU6IDgsXG4gICAgICAgICAgZm9udFdlaWdodDogXCJib2xkXCIsXG4gICAgICAgICAgZmlsbDogXCJibGFja1wiXG4gICAgICAgIH0pLFxuICAgICAgICBQbG90LnRleHQoW3t4OiAwLCB5OiAyLjN9XSwge1xuICAgICAgICAgIHg6IFwieFwiLFxuICAgICAgICAgIHk6IFwieVwiLFxuICAgICAgICAgIHRleHQ6ICgpID0+IGBXZWlnaHRzOiBCYW5rPSR7bm9ybWFsaXplZFdlaWdodHNbMF0udG9GaXhlZCgyKX0sIE1vbmV5PSR7bm9ybWFsaXplZFdlaWdodHNbMV0udG9GaXhlZCgyKX0sIFJpdmVyPSR7bm9ybWFsaXplZFdlaWdodHNbMl0udG9GaXhlZCgyKX1gLFxuICAgICAgICAgIGZvbnRTaXplOiAxMSxcbiAgICAgICAgICBmaWxsOiBcImJsYWNrXCJcbiAgICAgICAgfSksXG4gICAgICAgIFBsb3QuZG90KFt7eDogLTAuOCwgeTogMi43LCBjb2xvcjogXCIjZGFkYWRhXCJ9LCB7eDogMC44LCB5OiAyLjcsIGNvbG9yOiBcIiNmZjdmMGVcIn1dLCB7XG4gICAgICAgICAgeDogXCJ4XCIsXG4gICAgICAgICAgeTogXCJ5XCIsXG4gICAgICAgICAgZmlsbDogXCJjb2xvclwiLFxuICAgICAgICAgIHI6IDZcbiAgICAgICAgfSksXG4gICAgICAgIFBsb3QudGV4dChbe3g6IC0wLjUsIHk6IDIuNywgbGFiZWw6IFwiT3JpZ2luYWxcIn0sIHt4OiAxLjEsIHk6IDIuNywgbGFiZWw6IFwiQ29udGV4dHVhbGl6ZWRcIn1dLCB7XG4gICAgICAgICAgeDogXCJ4XCIsXG4gICAgICAgICAgeTogXCJ5XCIsXG4gICAgICAgICAgdGV4dDogXCJsYWJlbFwiLFxuICAgICAgICAgIGZvbnRTaXplOiAxMCxcbiAgICAgICAgICBmaWxsOiBcImJsYWNrXCIsXG4gICAgICAgICAgdGV4dEFuY2hvcjogXCJzdGFydFwiXG4gICAgICAgIH0pXG4gICAgICBdXG4gICAgfSk7XG5cbiAgICBkMy5zZWxlY3QocGxvdENvbnRhaW5lcikubm9kZSgpLmFwcGVuZENoaWxkKHBsb3QpO1xuICB9XG5cbiAgYmFua1NsaWRlck9iai5zbGlkZXIub24oXCJvbmNoYW5nZVwiLCB1cGRhdGUpO1xuICBtb25leVNsaWRlck9iai5zbGlkZXIub24oXCJvbmNoYW5nZVwiLCB1cGRhdGUpO1xuICByaXZlclNsaWRlck9iai5zbGlkZXIub24oXCJvbmNoYW5nZVwiLCB1cGRhdGUpO1xuXG4gIHVwZGF0ZSgpO1xuXG4gIHJldHVybiBodG1sYDxkaXYgc3R5bGU9XCJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBnYXA6IDQwcHg7IGp1c3RpZnktY29udGVudDogY2VudGVyO1wiPlxuICAgIDxkaXYgc3R5bGU9XCJkaXNwbGF5OiBmbGV4OyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOyBnYXA6IDEwcHg7XCI+XG4gICAgICAke2JhbmtTbGlkZXJPYmoubm9kZX1cbiAgICAgICR7bW9uZXlTbGlkZXJPYmoubm9kZX1cbiAgICAgICR7cml2ZXJTbGlkZXJPYmoubm9kZX1cbiAgICA8L2Rpdj5cbiAgICA8ZGl2PlxuICAgICAgJHtwbG90Q29udGFpbmVyfVxuICAgIDwvZGl2PlxuICA8L2Rpdj5gO1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC00IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiZnVuY3Rpb24gY3JlYXRlUUtWU2xpZGVyKG1pbiwgbWF4LCBzdGVwLCB3aWR0aCwgZGVmYXVsdFZhbHVlLCBsYWJlbCwgdmFsdWVTZXR0ZXIpIHtcbiAgY29uc3Qgc2xpZGVyID0gZDMuc2xpZGVyQm90dG9tKClcbiAgICAubWluKG1pbikubWF4KG1heCkuc3RlcChzdGVwKS53aWR0aCh3aWR0aCkuZGVmYXVsdChkZWZhdWx0VmFsdWUpXG4gICAgLm9uKCdvbmNoYW5nZScsIHZhbCA9PiB2YWx1ZVNldHRlcih2YWwpKTtcbiAgY29uc3Qgc3ZnID0gZDMuY3JlYXRlKFwic3ZnXCIpLmF0dHIoXCJ3aWR0aFwiLCB3aWR0aCArIDQwKS5hdHRyKFwiaGVpZ2h0XCIsIDUwKTtcbiAgY29uc3QgZyA9IHN2Zy5hcHBlbmQoXCJnXCIpLmF0dHIoXCJ0cmFuc2Zvcm1cIiwgXCJ0cmFuc2xhdGUoMjAsMTUpXCIpO1xuICBnLmNhbGwoc2xpZGVyKTtcbiAgc3ZnLmFwcGVuZChcInRleHRcIikuYXR0cihcInhcIiwgKHdpZHRoICsgNDApIC8gMikuYXR0cihcInlcIiwgMTApXG4gICAgIC5hdHRyKFwidGV4dC1hbmNob3JcIiwgXCJtaWRkbGVcIikuc3R5bGUoXCJmb250LXNpemVcIiwgXCIxMXB4XCIpLnRleHQobGFiZWwpO1xuICByZXR1cm4geyBub2RlOiBzdmcubm9kZSgpLCBzbGlkZXI6IHNsaWRlciB9O1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC01IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoibXV0YWJsZSBxU2NhbGVYVmFsdWUgPSAxLjBcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNiIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Im11dGFibGUgcVNjYWxlWVZhbHVlID0gMS4wXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTciLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJtdXRhYmxlIHFSb3RhdGVWYWx1ZSA9IDBcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtOCIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Im11dGFibGUga1NjYWxlWFZhbHVlID0gMS4wXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTkiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJtdXRhYmxlIGtTY2FsZVlWYWx1ZSA9IDEuMFxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xMCIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Im11dGFibGUga1JvdGF0ZVZhbHVlID0gMFxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xMSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6InFTY2FsZVhTbGlkZXIgPSBjcmVhdGVRS1ZTbGlkZXIoMC4xLCAyLCAwLjEsIDE1MCwgMS4wLCBcIlEgU2NhbGUgWFwiLCB2YWwgPT4gbXV0YWJsZSBxU2NhbGVYVmFsdWUgPSB2YWwpXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTEyIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoicVNjYWxlWVNsaWRlciA9IGNyZWF0ZVFLVlNsaWRlcigwLjEsIDIsIDAuMSwgMTUwLCAxLjAsIFwiUSBTY2FsZSBZXCIsIHZhbCA9PiBtdXRhYmxlIHFTY2FsZVlWYWx1ZSA9IHZhbClcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTMiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJxUm90YXRlU2xpZGVyID0gY3JlYXRlUUtWU2xpZGVyKC0xODAsIDE4MCwgNSwgMTUwLCAwLCBcIlEgUm90YXRlIChkZWcpXCIsIHZhbCA9PiBtdXRhYmxlIHFSb3RhdGVWYWx1ZSA9IHZhbClcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTQiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJrU2NhbGVYU2xpZGVyID0gY3JlYXRlUUtWU2xpZGVyKDAuMSwgMiwgMC4xLCAxNTAsIDEuMCwgXCJLIFNjYWxlIFhcIiwgdmFsID0+IG11dGFibGUga1NjYWxlWFZhbHVlID0gdmFsKVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xNSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6ImtTY2FsZVlTbGlkZXIgPSBjcmVhdGVRS1ZTbGlkZXIoMC4xLCAyLCAwLjEsIDE1MCwgMS4wLCBcIksgU2NhbGUgWVwiLCB2YWwgPT4gbXV0YWJsZSBrU2NhbGVZVmFsdWUgPSB2YWwpXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTE2IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoia1JvdGF0ZVNsaWRlciA9IGNyZWF0ZVFLVlNsaWRlcigtMTgwLCAxODAsIDUsIDE1MCwgMCwgXCJLIFJvdGF0ZSAoZGVnKVwiLCB2YWwgPT4gbXV0YWJsZSBrUm90YXRlVmFsdWUgPSB2YWwpXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTE3IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoicWt2VmlzdWFsaXphdGlvbiA9IHtcbiAgY29uc3Qgb3JpZ2luYWxWZWN0b3JzID0gW1xuICAgIHsgbmFtZTogXCJiYW5rXCIsIHZlY3RvcjogWzEuNSwgMC41XSB9LFxuICAgIHsgbmFtZTogXCJtb25leVwiLCB2ZWN0b3I6IFsxLjgsIDAuOF0gfSxcbiAgICB7IG5hbWU6IFwicml2ZXJcIiwgdmVjdG9yOiBbMC41LCAxLjVdIH1cbiAgXTtcblxuICBjb25zdCBxUGxvdENvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gIGNvbnN0IGtQbG90Q29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcblxuICBmdW5jdGlvbiB0cmFuc2Zvcm1WZWN0b3IodmVjLCBzY2FsZVgsIHNjYWxlWSwgcm90YXRlRGVnKSB7XG4gICAgY29uc3QgdGhldGEgPSAocm90YXRlRGVnICogTWF0aC5QSSkgLyAxODA7XG4gICAgY29uc3QgY29zID0gTWF0aC5jb3ModGhldGEpO1xuICAgIGNvbnN0IHNpbiA9IE1hdGguc2luKHRoZXRhKTtcbiAgICBjb25zdCBzY2FsZWRYID0gdmVjWzBdICogc2NhbGVYO1xuICAgIGNvbnN0IHNjYWxlZFkgPSB2ZWNbMV0gKiBzY2FsZVk7XG4gICAgcmV0dXJuIFtcbiAgICAgIHNjYWxlZFggKiBjb3MgLSBzY2FsZWRZICogc2luLFxuICAgICAgc2NhbGVkWCAqIHNpbiArIHNjYWxlZFkgKiBjb3NcbiAgICBdO1xuICB9XG5cbiAgY29uc3QgcVNjYWxlWCA9IHFTY2FsZVhWYWx1ZTtcbiAgY29uc3QgcVNjYWxlWSA9IHFTY2FsZVlWYWx1ZTtcbiAgY29uc3QgcVJvdGF0ZSA9IHFSb3RhdGVWYWx1ZTtcbiAgY29uc3Qga1NjYWxlWCA9IGtTY2FsZVhWYWx1ZTtcbiAgY29uc3Qga1NjYWxlWSA9IGtTY2FsZVlWYWx1ZTtcbiAgY29uc3Qga1JvdGF0ZSA9IGtSb3RhdGVWYWx1ZTtcblxuICBjb25zdCBvcmlnaW5hbERhdGEgPSBvcmlnaW5hbFZlY3RvcnMubWFwKGl0ZW0gPT4gKHtcbiAgICBuYW1lOiBpdGVtLm5hbWUsXG4gICAgeDogaXRlbS52ZWN0b3JbMF0sXG4gICAgeTogaXRlbS52ZWN0b3JbMV0sXG4gICAgdHlwZTogXCJPcmlnaW5hbFwiXG4gIH0pKTtcblxuICBjb25zdCBxRGF0YSA9IG9yaWdpbmFsVmVjdG9ycy5tYXAoaXRlbSA9PiB7XG4gICAgY29uc3QgcVZlYyA9IHRyYW5zZm9ybVZlY3RvcihpdGVtLnZlY3RvciwgcVNjYWxlWCwgcVNjYWxlWSwgcVJvdGF0ZSk7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWU6IGBxXyR7aXRlbS5uYW1lfWAsXG4gICAgICB4OiBxVmVjWzBdLFxuICAgICAgeTogcVZlY1sxXSxcbiAgICAgIHR5cGU6IFwiUXVlcnlcIlxuICAgIH07XG4gIH0pO1xuXG4gIGNvbnN0IGtEYXRhID0gb3JpZ2luYWxWZWN0b3JzLm1hcChpdGVtID0+IHtcbiAgICBjb25zdCBrVmVjID0gdHJhbnNmb3JtVmVjdG9yKGl0ZW0udmVjdG9yLCBrU2NhbGVYLCBrU2NhbGVZLCBrUm90YXRlKTtcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogYGtfJHtpdGVtLm5hbWV9YCxcbiAgICAgIHg6IGtWZWNbMF0sXG4gICAgICB5OiBrVmVjWzFdLFxuICAgICAgdHlwZTogXCJLZXlcIlxuICAgIH07XG4gIH0pO1xuXG4gIGNvbnN0IHFQbG90ID0gUGxvdC5wbG90KHtcbiAgICB3aWR0aDogMjUwLFxuICAgIGhlaWdodDogMjUwLFxuICAgIG1hcmdpblRvcDogNDAsXG4gICAgbWFyZ2luUmlnaHQ6IDIwLFxuICAgIG1hcmdpbkJvdHRvbTogNTAsXG4gICAgbWFyZ2luTGVmdDogNjAsXG4gICAgc3R5bGU6IHtcbiAgICAgIGJhY2tncm91bmQ6IFwid2hpdGVcIixcbiAgICAgIGNvbG9yOiBcImJsYWNrXCJcbiAgICB9LFxuICAgIHg6IHtcbiAgICAgIGRvbWFpbjogWy0zLCAzXSxcbiAgICAgIGxhYmVsOiBcIkRpbWVuc2lvbiAxXCIsXG4gICAgICBncmlkOiB0cnVlLFxuICAgICAgdGlja3M6IDEwXG4gICAgfSxcbiAgICB5OiB7XG4gICAgICBkb21haW46IFstMywgM10sXG4gICAgICBsYWJlbDogXCJEaW1lbnNpb24gMlwiLFxuICAgICAgZ3JpZDogdHJ1ZSxcbiAgICAgIHRpY2tzOiAxMFxuICAgIH0sXG4gICAgbWFya3M6IFtcbiAgICAgIFBsb3QuZG90KFt7eDogMCwgeTogMH1dLCB7XG4gICAgICAgIHg6IFwieFwiLFxuICAgICAgICB5OiBcInlcIixcbiAgICAgICAgcjogMyxcbiAgICAgICAgZmlsbDogXCJibGFja1wiXG4gICAgICB9KSxcbiAgICAgIFBsb3QuYXJyb3coWy4uLm9yaWdpbmFsRGF0YSwgLi4ucURhdGFdLCB7XG4gICAgICAgIHgxOiAwLFxuICAgICAgICB5MTogMCxcbiAgICAgICAgeDI6IFwieFwiLFxuICAgICAgICB5MjogXCJ5XCIsXG4gICAgICAgIHN0cm9rZTogXCJ0eXBlXCIsXG4gICAgICAgIHN0cm9rZVdpZHRoOiAyLFxuICAgICAgICBoZWFkTGVuZ3RoOiA4XG4gICAgICB9KSxcbiAgICAgIFBsb3QuZG90KFsuLi5vcmlnaW5hbERhdGEsIC4uLnFEYXRhXSwge1xuICAgICAgICB4OiBcInhcIixcbiAgICAgICAgeTogXCJ5XCIsXG4gICAgICAgIGZpbGw6IFwidHlwZVwiLFxuICAgICAgICByOiA1LFxuICAgICAgICB0aXA6IHRydWVcbiAgICAgIH0pLFxuICAgICAgUGxvdC50ZXh0KFsuLi5vcmlnaW5hbERhdGEsIC4uLnFEYXRhXSwge1xuICAgICAgICB4OiBcInhcIixcbiAgICAgICAgeTogXCJ5XCIsXG4gICAgICAgIHRleHQ6IFwibmFtZVwiLFxuICAgICAgICBkeTogLTEyLFxuICAgICAgICBmb250U2l6ZTogOSxcbiAgICAgICAgZm9udFdlaWdodDogXCJib2xkXCIsXG4gICAgICAgIGZpbGw6IFwiYmxhY2tcIlxuICAgICAgfSksXG4gICAgICBQbG90LnRleHQoW3sgeDogMCwgeTogMy40IH1dLCB7XG4gICAgICAgIHg6IFwieFwiLFxuICAgICAgICB5OiBcInlcIixcbiAgICAgICAgdGV4dDogKCkgPT4gXCJRdWVyeSBTcGFjZVwiLFxuICAgICAgICBmb250U2l6ZTogMTIsXG4gICAgICAgIGZvbnRXZWlnaHQ6IFwiYm9sZFwiLFxuICAgICAgICBmaWxsOiBcImJsYWNrXCJcbiAgICAgIH0pXG4gICAgXSxcbiAgICBjb2xvcjoge1xuICAgICAgZG9tYWluOiBbXCJPcmlnaW5hbFwiLCBcIlF1ZXJ5XCJdLFxuICAgICAgcmFuZ2U6IFtcIiM2NjY2NjZcIiwgXCIjNDY4MmI0XCJdXG4gICAgfVxuICB9KTtcblxuICBjb25zdCBrUGxvdCA9IFBsb3QucGxvdCh7XG4gICAgd2lkdGg6IDI1MCxcbiAgICBoZWlnaHQ6IDI1MCxcbiAgICBtYXJnaW5Ub3A6IDQwLFxuICAgIG1hcmdpblJpZ2h0OiAyMCxcbiAgICBtYXJnaW5Cb3R0b206IDUwLFxuICAgIG1hcmdpbkxlZnQ6IDYwLFxuICAgIHN0eWxlOiB7XG4gICAgICBiYWNrZ3JvdW5kOiBcIndoaXRlXCIsXG4gICAgICBjb2xvcjogXCJibGFja1wiXG4gICAgfSxcbiAgICB4OiB7XG4gICAgICBkb21haW46IFstMywgM10sXG4gICAgICBsYWJlbDogXCJEaW1lbnNpb24gMVwiLFxuICAgICAgZ3JpZDogdHJ1ZSxcbiAgICAgIHRpY2tzOiAxMFxuICAgIH0sXG4gICAgeToge1xuICAgICAgZG9tYWluOiBbLTMsIDNdLFxuICAgICAgbGFiZWw6IFwiRGltZW5zaW9uIDJcIixcbiAgICAgIGdyaWQ6IHRydWUsXG4gICAgICB0aWNrczogMTBcbiAgICB9LFxuICAgIG1hcmtzOiBbXG4gICAgICBQbG90LmRvdChbe3g6IDAsIHk6IDB9XSwge1xuICAgICAgICB4OiBcInhcIixcbiAgICAgICAgeTogXCJ5XCIsXG4gICAgICAgIHI6IDMsXG4gICAgICAgIGZpbGw6IFwiYmxhY2tcIlxuICAgICAgfSksXG4gICAgICBQbG90LmFycm93KFsuLi5vcmlnaW5hbERhdGEsIC4uLmtEYXRhXSwge1xuICAgICAgICB4MTogMCxcbiAgICAgICAgeTE6IDAsXG4gICAgICAgIHgyOiBcInhcIixcbiAgICAgICAgeTI6IFwieVwiLFxuICAgICAgICBzdHJva2U6IFwidHlwZVwiLFxuICAgICAgICBzdHJva2VXaWR0aDogMixcbiAgICAgICAgaGVhZExlbmd0aDogOFxuICAgICAgfSksXG4gICAgICBQbG90LmRvdChbLi4ub3JpZ2luYWxEYXRhLCAuLi5rRGF0YV0sIHtcbiAgICAgICAgeDogXCJ4XCIsXG4gICAgICAgIHk6IFwieVwiLFxuICAgICAgICBmaWxsOiBcInR5cGVcIixcbiAgICAgICAgcjogNSxcbiAgICAgICAgdGlwOiB0cnVlXG4gICAgICB9KSxcbiAgICAgIFBsb3QudGV4dChbLi4ub3JpZ2luYWxEYXRhLCAuLi5rRGF0YV0sIHtcbiAgICAgICAgeDogXCJ4XCIsXG4gICAgICAgIHk6IFwieVwiLFxuICAgICAgICB0ZXh0OiBcIm5hbWVcIixcbiAgICAgICAgZHk6IC0xMixcbiAgICAgICAgZm9udFNpemU6IDksXG4gICAgICAgIGZvbnRXZWlnaHQ6IFwiYm9sZFwiLFxuICAgICAgICBmaWxsOiBcImJsYWNrXCJcbiAgICAgIH0pLFxuICAgICAgUGxvdC50ZXh0KFt7IHg6IDAsIHk6IDMuNCB9XSwge1xuICAgICAgICB4OiBcInhcIixcbiAgICAgICAgeTogXCJ5XCIsXG4gICAgICAgIHRleHQ6ICgpID0+IFwiS2V5IFNwYWNlXCIsXG4gICAgICAgIGZvbnRTaXplOiAxMixcbiAgICAgICAgZm9udFdlaWdodDogXCJib2xkXCIsXG4gICAgICAgIGZpbGw6IFwiYmxhY2tcIlxuICAgICAgfSlcbiAgICBdLFxuICAgIGNvbG9yOiB7XG4gICAgICBkb21haW46IFtcIk9yaWdpbmFsXCIsIFwiS2V5XCJdLFxuICAgICAgcmFuZ2U6IFtcIiM2NjY2NjZcIiwgXCIjMmU4YjU3XCJdXG4gICAgfVxuICB9KTtcblxuICBkMy5zZWxlY3QocVBsb3RDb250YWluZXIpLm5vZGUoKS5hcHBlbmRDaGlsZChxUGxvdCk7XG4gIGQzLnNlbGVjdChrUGxvdENvbnRhaW5lcikubm9kZSgpLmFwcGVuZENoaWxkKGtQbG90KTtcblxuICByZXR1cm4gaHRtbGA8ZGl2IHN0eWxlPVwiZGlzcGxheTogZmxleDsganVzdGlmeS1jb250ZW50OiBjZW50ZXI7IGdhcDogNDBweDtcIj5cbiAgICA8ZGl2IHN0eWxlPVwiZGlzcGxheTogZmxleDsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsgZ2FwOiAyMHB4O1wiPlxuICAgICAgPGRpdiBzdHlsZT1cImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGdhcDogMjBweDtcIj5cbiAgICAgICAgPGRpdiBzdHlsZT1cImRpc3BsYXk6IGZsZXg7IGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47IGdhcDogOHB4O1wiPlxuICAgICAgICAgIDxkaXYgc3R5bGU9XCJmb250LXdlaWdodDogYm9sZDsgbWFyZ2luLWJvdHRvbTogM3B4O1wiPlF1ZXJ5IChXX1EpPC9kaXY+XG4gICAgICAgICAgJHtxU2NhbGVYU2xpZGVyLm5vZGV9XG4gICAgICAgICAgJHtxU2NhbGVZU2xpZGVyLm5vZGV9XG4gICAgICAgICAgJHtxUm90YXRlU2xpZGVyLm5vZGV9XG4gICAgICAgIDwvZGl2PlxuICAgICAgICAke3FQbG90Q29udGFpbmVyfVxuICAgICAgPC9kaXY+XG4gICAgICA8ZGl2IHN0eWxlPVwiZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZ2FwOiAyMHB4O1wiPlxuICAgICAgICA8ZGl2IHN0eWxlPVwiZGlzcGxheTogZmxleDsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsgZ2FwOiA4cHg7XCI+XG4gICAgICAgICAgPGRpdiBzdHlsZT1cImZvbnQtd2VpZ2h0OiBib2xkOyBtYXJnaW4tYm90dG9tOiAzcHg7XCI+S2V5IChXX0spPC9kaXY+XG4gICAgICAgICAgJHtrU2NhbGVYU2xpZGVyLm5vZGV9XG4gICAgICAgICAgJHtrU2NhbGVZU2xpZGVyLm5vZGV9XG4gICAgICAgICAgJHtrUm90YXRlU2xpZGVyLm5vZGV9XG4gICAgICAgIDwvZGl2PlxuICAgICAgICAke2tQbG90Q29udGFpbmVyfVxuICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG4gIDwvZGl2PmA7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTE4IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiYXR0ZW50aW9uSGVhdG1hcCA9IHtcbiAgY29uc3QgYXR0ZW50aW9uV29yZHMgPSBbXCJiYW5rXCIsIFwibW9uZXlcIiwgXCJyaXZlclwiXTtcbiAgY29uc3QgYXR0ZW50aW9uRW1iZWRkaW5ncyA9IFtcbiAgICBbMS41LCAwLjVdLFxuICAgIFsxLjgsIDAuOF0sXG4gICAgWzAuNSwgMS41XVxuICBdO1xuXG4gIGZ1bmN0aW9uIHRyYW5zZm9ybVZlY3Rvcih2ZWMsIHNjYWxlWCwgc2NhbGVZLCByb3RhdGVEZWcpIHtcbiAgICBjb25zdCB0aGV0YSA9IChyb3RhdGVEZWcgKiBNYXRoLlBJKSAvIDE4MDtcbiAgICBjb25zdCBjb3MgPSBNYXRoLmNvcyh0aGV0YSk7XG4gICAgY29uc3Qgc2luID0gTWF0aC5zaW4odGhldGEpO1xuICAgIGNvbnN0IHNjYWxlZFggPSB2ZWNbMF0gKiBzY2FsZVg7XG4gICAgY29uc3Qgc2NhbGVkWSA9IHZlY1sxXSAqIHNjYWxlWTtcbiAgICByZXR1cm4gW1xuICAgICAgc2NhbGVkWCAqIGNvcyAtIHNjYWxlZFkgKiBzaW4sXG4gICAgICBzY2FsZWRYICogc2luICsgc2NhbGVkWSAqIGNvc1xuICAgIF07XG4gIH1cblxuICBjb25zdCBxU2NhbGVYID0gcVNjYWxlWFZhbHVlO1xuICBjb25zdCBxU2NhbGVZID0gcVNjYWxlWVZhbHVlO1xuICBjb25zdCBxUm90YXRlID0gcVJvdGF0ZVZhbHVlO1xuICBjb25zdCBrU2NhbGVYID0ga1NjYWxlWFZhbHVlO1xuICBjb25zdCBrU2NhbGVZID0ga1NjYWxlWVZhbHVlO1xuICBjb25zdCBrUm90YXRlID0ga1JvdGF0ZVZhbHVlO1xuXG4gIGNvbnN0IFEgPSBhdHRlbnRpb25FbWJlZGRpbmdzLm1hcCh2ZWMgPT5cbiAgICB0cmFuc2Zvcm1WZWN0b3IodmVjLCBxU2NhbGVYLCBxU2NhbGVZLCBxUm90YXRlKVxuICApO1xuICBjb25zdCBLID0gYXR0ZW50aW9uRW1iZWRkaW5ncy5tYXAodmVjID0+XG4gICAgdHJhbnNmb3JtVmVjdG9yKHZlYywga1NjYWxlWCwga1NjYWxlWSwga1JvdGF0ZSlcbiAgKTtcblxuICBjb25zdCBzY29yZXMgPSBRLm1hcChxID0+IEsubWFwKGsgPT4gcVswXSAqIGtbMF0gKyBxWzFdICoga1sxXSkpO1xuXG4gIGNvbnN0IGF0dGVudGlvbldlaWdodHMgPSBzY29yZXMubWFwKHJvdyA9PiB7XG4gICAgY29uc3QgbWF4U2NvcmUgPSBNYXRoLm1heCguLi5yb3cpO1xuICAgIGNvbnN0IGV4cFNjb3JlcyA9IHJvdy5tYXAocyA9PiBNYXRoLmV4cChzIC0gbWF4U2NvcmUpKTtcbiAgICBjb25zdCBzdW1FeHAgPSBleHBTY29yZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7XG4gICAgcmV0dXJuIGV4cFNjb3Jlcy5tYXAoZSA9PiBlIC8gc3VtRXhwKTtcbiAgfSk7XG5cbiAgY29uc3QgaGVhdG1hcERhdGEgPSAoKCkgPT4ge1xuICAgIGNvbnN0IGRhdGEgPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGF0dGVudGlvbldvcmRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGF0dGVudGlvbldvcmRzLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIGRhdGEucHVzaCh7XG4gICAgICAgICAgUXVlcnk6IGF0dGVudGlvbldvcmRzW2ldLFxuICAgICAgICAgIEtleTogYXR0ZW50aW9uV29yZHNbal0sXG4gICAgICAgICAgV2VpZ2h0OiBhdHRlbnRpb25XZWlnaHRzW2ldW2pdXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZGF0YTtcbiAgfSkoKTtcblxuICBjb25zdCBoZWF0bWFwUGxvdCA9IFBsb3QucGxvdCh7XG4gICAgd2lkdGg6IDMyMCxcbiAgICBoZWlnaHQ6IDMyMCxcbiAgICBtYXJnaW5Ub3A6IDUwLFxuICAgIG1hcmdpbkJvdHRvbTogNTAsXG4gICAgbWFyZ2luTGVmdDogNzAsXG4gICAgbWFyZ2luUmlnaHQ6IDgwLFxuICAgIHN0eWxlOiB7XG4gICAgICBiYWNrZ3JvdW5kOiBcIndoaXRlXCIsXG4gICAgICBjb2xvcjogXCJibGFja1wiXG4gICAgfSxcbiAgICB4OiB7XG4gICAgICBsYWJlbDogXCJLZXkgV29yZFwiLFxuICAgICAgZG9tYWluOiBhdHRlbnRpb25Xb3Jkc1xuICAgIH0sXG4gICAgeToge1xuICAgICAgbGFiZWw6IFwiUXVlcnkgV29yZFwiLFxuICAgICAgZG9tYWluOiBhdHRlbnRpb25Xb3Jkc1xuICAgIH0sXG4gICAgY29sb3I6IHtcbiAgICAgIHNjaGVtZTogXCJCbHVlc1wiLFxuICAgICAgbGFiZWw6IFwiQXR0ZW50aW9uXCIsXG4gICAgICBsZWdlbmQ6IHRydWVcbiAgICB9LFxuICAgIG1hcmtzOiBbXG4gICAgICBQbG90LmNlbGwoaGVhdG1hcERhdGEsIHtcbiAgICAgICAgeDogXCJLZXlcIixcbiAgICAgICAgeTogXCJRdWVyeVwiLFxuICAgICAgICBmaWxsOiBcIldlaWdodFwiLFxuICAgICAgICB0aXA6IHRydWVcbiAgICAgIH0pLFxuICAgICAgUGxvdC50ZXh0KGhlYXRtYXBEYXRhLCB7XG4gICAgICAgIHg6IFwiS2V5XCIsXG4gICAgICAgIHk6IFwiUXVlcnlcIixcbiAgICAgICAgdGV4dDogZCA9PiBkLldlaWdodC50b0ZpeGVkKDIpLFxuICAgICAgICBmaWxsOiBkID0+IGQuV2VpZ2h0ID4gMC4zNSA/IFwid2hpdGVcIiA6IFwiYmxhY2tcIixcbiAgICAgICAgZm9udFNpemU6IDExXG4gICAgICB9KSxcbiAgICAgIFBsb3QudGV4dChbeyB4OiAwLCB5OiAwIH1dLCB7XG4gICAgICAgIHg6ICgpID0+IGF0dGVudGlvbldvcmRzLmxlbmd0aCAvIDIgLSAwLjUsXG4gICAgICAgIHk6ICgpID0+IC0wLjgsXG4gICAgICAgIHRleHQ6ICgpID0+IFwiQXR0ZW50aW9uIFdlaWdodHMgKFNvZnRtYXgpXCIsXG4gICAgICAgIGZvbnRTaXplOiAxMixcbiAgICAgICAgZm9udFdlaWdodDogXCJib2xkXCIsXG4gICAgICAgIGZyYW1lQW5jaG9yOiBcInRvcFwiLFxuICAgICAgICBmaWxsOiBcImJsYWNrXCJcbiAgICAgIH0pXG4gICAgXVxuICB9KTtcblxuICByZXR1cm4gaHRtbGA8ZGl2IHN0eWxlPVwiZGlzcGxheTogZmxleDsganVzdGlmeS1jb250ZW50OiBjZW50ZXI7XCI+XG4gICAgJHtoZWF0bWFwUGxvdH1cbiAgPC9kaXY+YDtcbn1cbiJ9XX0=
</script>
<script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../../m04-text";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "..";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../m04-text/tokenization.html" class="pagination-link" aria-label="Tokenization: Unboxing How LLMs Read Text">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Tokenization: Unboxing How LLMs Read Text</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../m04-text/bert-gpt.html" class="pagination-link" aria-label="BERT &amp; GPT">
        <span class="nav-page-text">BERT &amp; GPT</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2025, Sadamori Kojaku</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/skojaku/applied-soft-comp">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>
<script src="../assets/breadcrumb-toc.js"></script>




</body></html>