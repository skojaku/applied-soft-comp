<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sadamori Kojaku">
<meta name="dcterms.date" content="2025-11-24">

<title>Transformers – Applied Soft Computing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../m03-text/word-embeddings.html" rel="next">
<link href="../m03-text/tokenization.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-0348920b7671f696dc9078d39bff215e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-f8b3ee0b8591417f08754123bc653639.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "|"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script type="module" src="../site_libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="../site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../assets/custom.css">
</head>

<body class="nav-sidebar docked nav-fixed slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../logo.jpg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Applied Soft Computing</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-toolkit--workflow" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Toolkit &amp; Workflow</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-toolkit--workflow">    
        <li class="dropdown-header">─── Module 1 ───</li>
        <li>
    <a class="dropdown-item" href="../m01-toolkit/overview.html">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m01-toolkit/git-github.html">
 <span class="dropdown-text">Git &amp; GitHub</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m01-toolkit/tidy-data.html">
 <span class="dropdown-text">Tidy Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m01-toolkit/data-provenance.html">
 <span class="dropdown-text">Data Provenance</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m01-toolkit/environments.qmd">
 <span class="dropdown-text">Environments</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-visualization" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Visualization</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-visualization">    
        <li class="dropdown-header">─── Module 2 ───</li>
        <li>
    <a class="dropdown-item" href="../m02-visualization/overview.html">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m02-visualization/principles.html">
 <span class="dropdown-text">Principles</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m02-visualization/dimensionality-reduction.html">
 <span class="dropdown-text">High-Dimensional Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m02-visualization/networks.html">
 <span class="dropdown-text">Networks</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m02-visualization/time-series.html">
 <span class="dropdown-text">Time-Series</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-deep-learning" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Deep Learning</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-deep-learning">    
        <li class="dropdown-header">─── Module 3: Text ───</li>
        <li>
    <a class="dropdown-item" href="../m03-text/overview.html">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m03-text/word2vec.md">
 <span class="dropdown-text">Word2Vec</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m03-text/lstm.md">
 <span class="dropdown-text">RNNs &amp; LSTMs</span></a>
  </li>  
        <li class="dropdown-header">─── Module 4: Images ───</li>
        <li>
    <a class="dropdown-item" href="../m04-images/overview.html">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m04-images/cnn.md">
 <span class="dropdown-text">CNNs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m04-images/resnet.md">
 <span class="dropdown-text">ResNet</span></a>
  </li>  
        <li class="dropdown-header">─── Module 5: Graphs ───</li>
        <li>
    <a class="dropdown-item" href="../m05-graphs/overview.html">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m05-graphs/graph-embedding-w-word2vec.html">
 <span class="dropdown-text">Graph Embeddings</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m05-graphs/graph-convolutional-network.html">
 <span class="dropdown-text">GNNs</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-advanced-topics" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Advanced Topics</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-advanced-topics">    
        <li class="dropdown-header">─── Module 6: LLMs ───</li>
        <li>
    <a class="dropdown-item" href="../m06-llms/overview.html">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m06-llms/transformers.md">
 <span class="dropdown-text">Transformers</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m06-llms/scaling-emergence.html">
 <span class="dropdown-text">Scaling &amp; Emergence</span></a>
  </li>  
        <li class="dropdown-header">─── Module 7: Self-Supervised ───</li>
        <li>
    <a class="dropdown-item" href="../m07-self-supervised/overview.html">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m07-self-supervised/contrastive-learning.html">
 <span class="dropdown-text">Contrastive Learning</span></a>
  </li>  
        <li class="dropdown-header">─── Module 8: Explainability ───</li>
        <li>
    <a class="dropdown-item" href="../m08-explainability/overview.html">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../m08-explainability/fairness.html">
 <span class="dropdown-text">Fairness &amp; Ethics</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../m03-text/overview.html">Module 3: Deep Learning for Text</a></li><li class="breadcrumb-item"><a href="../m03-text/transformers.html">Transformers: The Architecture Behind the Magic</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">Course Information</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course/welcome.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course/about.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About Us</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course/why-applied-soft-computing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Why applied soft computing?</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course/discord.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Discord</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course/setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Setup</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course/minidora-usage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using Minidora</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course/how-to-submit-assignment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How to submit assignment</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course/deliverables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Deliverables</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Module 1: The Data Scientist’s Toolkit</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m01-toolkit/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m01-toolkit/git-github.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Version Control with Git &amp; GitHub</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m01-toolkit/tidy-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The Tidy Data Philosophy</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m01-toolkit/data-provenance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Provenance</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m01-toolkit/reproduceability.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reproducibility</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Module 2: Visualizing Complexity</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m02-visualization/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m02-visualization/principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Principles of Effective Visualization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m02-visualization/1d-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualizing 1D Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m02-visualization/2d-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualizing 2D Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m02-visualization/highd-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualizing High-Dimensional Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m02-visualization/networks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualizing Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m02-visualization/time-series.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualizing Time-Series</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Module 3: Deep Learning for Text</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m03-text/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m03-text/llm-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Large Language Models in Practice</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m03-text/prompt-engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prompt Engineering for Research</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m03-text/embeddings-concepts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Embeddings: How Machines Understand Meaning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m03-text/tokenization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tokenization: Unboxing How LLMs Read Text</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m03-text/transformers.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Transformers: The Architecture Behind the Magic</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m03-text/word-embeddings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Word Embeddings: Where It Started</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m03-text/text-fundamentals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text Fundamentals: The Full Picture</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m03-text/semantic-research.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Semantic Analysis for Research</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false">
 <span class="menu-text">Module 4: Deep Learning for Images</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-images/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-images/image-processing.md" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Image Processing Fundamentals</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-images/cnn.md" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Convolutional Neural Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-images/lenet.md" class="sidebar-item-text sidebar-link">
 <span class="menu-text">LeNet Architecture</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-images/alexnet.md" class="sidebar-item-text sidebar-link">
 <span class="menu-text">AlexNet: Deep CNN Revolution</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-images/vgg.md" class="sidebar-item-text sidebar-link">
 <span class="menu-text">VGG Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-images/inception.md" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Inception &amp; Multi-Scale Features</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-images/batch-normalization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Batch Normalization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-images/resnet.md" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ResNet &amp; Skip Connections</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false">
 <span class="menu-text">Module 5: Deep Learning for Graphs</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m05-graphs/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m05-graphs/spectral-embedding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spectral Graph Embedding</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m05-graphs/graph-embedding-w-word2vec.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Graph Embeddings with Word2Vec</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m05-graphs/spectral-vs-neural-embedding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spectral vs.&nbsp;Neural Embeddings</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m05-graphs/from-image-to-graph.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">From Images to Graphs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m05-graphs/graph-convolutional-network.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Graph Convolutional Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m05-graphs/popular-gnn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Popular GNN Architectures</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m05-graphs/software.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GNN Software &amp; Tools</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false">
 <span class="menu-text">Module 6: Large Language Models &amp; Emergent Behavior</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m06-llms/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m06-llms/transformers.md" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The Transformer Architecture</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m06-llms/bert.md" class="sidebar-item-text sidebar-link">
 <span class="menu-text">BERT &amp; Contextual Embeddings</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m06-llms/sentence-bert.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sentence-BERT for Semantic Similarity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m06-llms/gpt.md" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GPT &amp; Generative Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m06-llms/from-language-model-to-instruction-following.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">From Language Models to Instruction Following</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m06-llms/prompt-tuning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prompt Engineering &amp; In-Context Learning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m06-llms/scaling-emergence.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scaling Laws &amp; Emergent Abilities</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m06-llms/llms-as-complex-systems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">LLMs as Complex Systems</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false">
 <span class="menu-text">Module 7: Self-Supervised Learning</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m07-self-supervised/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m07-self-supervised/paradigm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The Self-Supervised Paradigm</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m07-self-supervised/contrastive-learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contrastive Learning (SimCLR)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m07-self-supervised/graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Self-Supervised Learning for Graphs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m07-self-supervised/time-series.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Self-Supervised Learning for Time-Series</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false">
 <span class="menu-text">Module 8: Explainability &amp; Ethics</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m08-explainability/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m08-explainability/need.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The Need for Explainability</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m08-explainability/attention.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Attention Visualization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m08-explainability/lime-shap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">LIME &amp; SHAP</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m08-explainability/fairness.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Algorithmic Fairness &amp; Bias</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m08-explainability/causality.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Causality vs.&nbsp;Correlation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false">
 <span class="menu-text">Legacy Materials</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m03-text/what-to-learn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Word &amp; Document Embeddings</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m03-text/what-to-learn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Recurrent Neural Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../m04-images/what-to-learn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Image Processing (CNNs)</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../m03-text/overview.html">Module 3: Deep Learning for Text</a></li><li class="breadcrumb-item"><a href="../m03-text/transformers.html">Transformers: The Architecture Behind the Magic</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Transformers</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sadamori Kojaku </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 24, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p><strong>The Spoiler:</strong> The entire transformer revolution boils down to this—static embeddings assign one vector per word, ignoring that “bank” near “river” is mathematically different from “bank” near “money.” Transformers solve this by computing context-aware representations through weighted mixing, and the weights themselves emerge from learned comparisons (Query × Key) between words. The result: machines finally understand that meaning isn’t in the word; it’s in the <em>distribution</em> of words around it.</p>
<section id="one-word-one-vector-is-not-enough" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="one-word-one-vector-is-not-enough"><span class="header-section-number">1</span> One word, one vector is not enough</h2>
<p>For many years, natural language processing treated words as having fixed meanings. We represented each word—like “bank”—as a single vector of numbers, called <strong>static embeddings</strong>.</p>
<p>But there’s a hidden catch in this “one meaning per word” mindset: with just a single fixed entry in the dictionary, “bank” means exactly the same thing in “I deposited money at the bank” as in “We had a picnic by the bank.” Every possible meaning gets mashed into a one-size-fits-all average—like describing the population by its <em>average</em> height and pretending that nobody’s any shorter or taller. The interesting details—the outliers, the context clues—vanish in the mix.</p>
<p>The naive hypothesis went like this: what if we just <em>mix</em> the target word with its neighbors? For the sentence “I deposited money at the bank,” we could compute a <em>contextualized representation</em> as:</p>
<p><span class="math display">
\vec{v}_{\text{bank (new)}} = w_1 \cdot \vec{v}_{\text{bank}} + w_2 \cdot \vec{v}_{\text{deposited}} + w_3 \cdot \vec{v}_{\text{money}} + \cdots
</span></p>
<p>where <span class="math inline">w_i</span> are weights and <span class="math inline">\vec{v}_i</span> are word embeddings.</p>
<p>Consider the following example. Notice that “bank” sits neutrally between financial terms (money) and geographical terms (river). Now try manually adjusting the weights to contextualize “bank”:</p>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb1" data-startfrom="28" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 27;"><span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>d3 <span class="op">=</span> <span class="pp">require</span>(<span class="st">"d3@7"</span><span class="op">,</span> <span class="st">"d3-simple-slider@1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb2" data-startfrom="33" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 32;"><span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sliderWithLabel</span>(min<span class="op">,</span> max<span class="op">,</span> step<span class="op">,</span> width<span class="op">,</span> defaultValue<span class="op">,</span> label) {</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> slider <span class="op">=</span> d3<span class="op">.</span><span class="fu">sliderBottom</span>()</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">min</span>(min)<span class="op">.</span><span class="fu">max</span>(max)<span class="op">.</span><span class="fu">step</span>(step)<span class="op">.</span><span class="fu">width</span>(width)<span class="op">.</span><span class="fu">default</span>(defaultValue)<span class="op">;</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width <span class="op">+</span> <span class="dv">50</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> <span class="dv">60</span>)<span class="op">;</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="st">"translate(25,20)"</span>)<span class="op">.</span><span class="fu">call</span>(slider)<span class="op">;</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (width <span class="op">+</span> <span class="dv">50</span>) <span class="op">/</span> <span class="dv">2</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"5px"</span>)<span class="op">.</span><span class="fu">text</span>(label)<span class="op">;</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> svg<span class="op">.</span><span class="fu">node</span>()<span class="op">;</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb3" data-startfrom="45" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 44;"><span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create slider function that returns both the element and a reactive value</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">createWeightSlider</span>(min<span class="op">,</span> max<span class="op">,</span> step<span class="op">,</span> width<span class="op">,</span> defaultValue<span class="op">,</span> label) {</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> slider <span class="op">=</span> d3<span class="op">.</span><span class="fu">sliderBottom</span>()</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">min</span>(min)<span class="op">.</span><span class="fu">max</span>(max)<span class="op">.</span><span class="fu">step</span>(step)<span class="op">.</span><span class="fu">width</span>(width)<span class="op">.</span><span class="fu">default</span>(defaultValue)<span class="op">;</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width <span class="op">+</span> <span class="dv">50</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> <span class="dv">60</span>)<span class="op">;</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> g <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="st">"translate(25,20)"</span>)<span class="op">;</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    g<span class="op">.</span><span class="fu">call</span>(slider)<span class="op">;</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (width <span class="op">+</span> <span class="dv">50</span>) <span class="op">/</span> <span class="dv">2</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>       <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"12px"</span>)<span class="op">.</span><span class="fu">text</span>(label)<span class="op">;</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="dt">node</span><span class="op">:</span> svg<span class="op">.</span><span class="fu">node</span>()<span class="op">,</span> <span class="dt">slider</span><span class="op">:</span> slider }<span class="op">;</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create sliders</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> bankSliderObj <span class="op">=</span> <span class="fu">createWeightSlider</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="fl">0.01</span><span class="op">,</span> <span class="dv">120</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="st">"Bank weight"</span>)<span class="op">;</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> moneySliderObj <span class="op">=</span> <span class="fu">createWeightSlider</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="fl">0.01</span><span class="op">,</span> <span class="dv">120</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="st">"Money weight"</span>)<span class="op">;</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> riverSliderObj <span class="op">=</span> <span class="fu">createWeightSlider</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="fl">0.01</span><span class="op">,</span> <span class="dv">120</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="st">"River weight"</span>)<span class="op">;</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Word embeddings in 2D space</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> contextWords <span class="op">=</span> [<span class="st">"bank"</span><span class="op">,</span> <span class="st">"money"</span><span class="op">,</span> <span class="st">"river"</span>]<span class="op">;</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> contextEmbeddings <span class="op">=</span> [</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span>]<span class="op">,</span>   <span class="co">// bank (center)</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>    [<span class="op">-</span><span class="fl">1.6</span><span class="op">,</span> <span class="op">-</span><span class="fl">0.6</span>]<span class="op">,</span> <span class="co">// money (financial, left)</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">1.4</span><span class="op">,</span> <span class="op">-</span><span class="fl">1.0</span>]   <span class="co">// river (geographical, right)</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create plot container</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> plotContainer <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">"div"</span>)<span class="op">;</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Function to update visualization</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">update</span>() {</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get current slider values</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> bankWeight <span class="op">=</span> bankSliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">value</span>()<span class="op">;</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> moneyWeight <span class="op">=</span> moneySliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">value</span>()<span class="op">;</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> riverWeight <span class="op">=</span> riverSliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">value</span>()<span class="op">;</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calculate weighted average</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> weights <span class="op">=</span> [bankWeight<span class="op">,</span> moneyWeight<span class="op">,</span> riverWeight]<span class="op">;</span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> total <span class="op">=</span> weights<span class="op">.</span><span class="fu">reduce</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a <span class="op">+</span> b<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> normalizedWeights <span class="op">=</span> total <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> weights<span class="op">.</span><span class="fu">map</span>(w <span class="kw">=&gt;</span> w <span class="op">/</span> total) <span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> newVec <span class="op">=</span> [</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">0</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">1</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">1</span>][<span class="dv">0</span>] <span class="op">+</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">2</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">2</span>][<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">0</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">+</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">1</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">1</span>][<span class="dv">1</span>] <span class="op">+</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">2</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">2</span>][<span class="dv">1</span>]</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Prepare data for visualization</span></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> originalData <span class="op">=</span> contextWords<span class="op">.</span><span class="fu">map</span>((word<span class="op">,</span> i) <span class="kw">=&gt;</span> ({</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>      <span class="dt">word</span><span class="op">:</span> word<span class="op">,</span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> contextEmbeddings[i][<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> contextEmbeddings[i][<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">"Original"</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> contextualizedData <span class="op">=</span> [{</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>      <span class="dt">word</span><span class="op">:</span> <span class="st">"bank (new)"</span><span class="op">,</span></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> newVec[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> newVec[<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">"Contextualized"</span></span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>    }]<span class="op">;</span></span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> [<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>contextualizedData]<span class="op">;</span></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clear and update plot</span></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>    d3<span class="op">.</span><span class="fu">select</span>(plotContainer)<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create visualization</span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> plot <span class="op">=</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>      <span class="dt">width</span><span class="op">:</span> <span class="dv">300</span><span class="op">,</span></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>      <span class="dt">height</span><span class="op">:</span> <span class="dv">300</span><span class="op">,</span></span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>      <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>        <span class="dt">background</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span></span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>        <span class="dt">color</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>        <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">2</span>]<span class="op">,</span></span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>        <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 1"</span><span class="op">,</span></span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>        <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>        <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>        <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">2</span>]<span class="op">,</span></span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>        <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 2"</span><span class="op">,</span></span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>        <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>        <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>        <span class="dt">domain</span><span class="op">:</span> [<span class="st">"Original"</span><span class="op">,</span> <span class="st">"Contextualized"</span>]<span class="op">,</span></span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>        <span class="dt">range</span><span class="op">:</span> [<span class="st">"#dadada"</span><span class="op">,</span> <span class="st">"#ff7f0e"</span>]</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">dot</span>(data<span class="op">,</span> {</span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"type"</span><span class="op">,</span></span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a>          <span class="dt">r</span><span class="op">:</span> <span class="dv">8</span><span class="op">,</span></span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a>          <span class="dt">tip</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">text</span>(data<span class="op">,</span> {</span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>          <span class="dt">text</span><span class="op">:</span> <span class="st">"word"</span><span class="op">,</span></span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a>          <span class="dt">dy</span><span class="op">:</span> <span class="op">-</span><span class="dv">15</span><span class="op">,</span></span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">8</span><span class="op">,</span></span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">text</span>([{<span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">2.3</span>}]<span class="op">,</span> {</span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a>          <span class="dt">text</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="vs">`Weights: Bank=</span><span class="sc">${</span>normalizedWeights[<span class="dv">0</span>]<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">, Money=</span><span class="sc">${</span>normalizedWeights[<span class="dv">1</span>]<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">, River=</span><span class="sc">${</span>normalizedWeights[<span class="dv">2</span>]<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">11</span><span class="op">,</span></span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Custom legend at top center</span></span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">dot</span>([{<span class="dt">x</span><span class="op">:</span> <span class="op">-</span><span class="fl">0.8</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">2.7</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span> <span class="st">"#dadada"</span>}<span class="op">,</span> {<span class="dt">x</span><span class="op">:</span> <span class="fl">0.8</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">2.7</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span> <span class="st">"#ff7f0e"</span>}]<span class="op">,</span> {</span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"color"</span><span class="op">,</span></span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a>          <span class="dt">r</span><span class="op">:</span> <span class="dv">6</span></span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">text</span>([{<span class="dt">x</span><span class="op">:</span> <span class="op">-</span><span class="fl">0.5</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">2.7</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Original"</span>}<span class="op">,</span> {<span class="dt">x</span><span class="op">:</span> <span class="fl">1.1</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">2.7</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Contextualized"</span>}]<span class="op">,</span> {</span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a>          <span class="dt">text</span><span class="op">:</span> <span class="st">"label"</span><span class="op">,</span></span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a>          <span class="dt">textAnchor</span><span class="op">:</span> <span class="st">"start"</span></span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a>    d3<span class="op">.</span><span class="fu">select</span>(plotContainer)<span class="op">.</span><span class="fu">node</span>()<span class="op">.</span><span class="fu">appendChild</span>(plot)<span class="op">;</span></span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add event listeners to sliders</span></span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a>  bankSliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">on</span>(<span class="st">"onchange"</span><span class="op">,</span> update)<span class="op">;</span></span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a>  moneySliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">on</span>(<span class="st">"onchange"</span><span class="op">,</span> update)<span class="op">;</span></span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a>  riverSliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">on</span>(<span class="st">"onchange"</span><span class="op">,</span> update)<span class="op">;</span></span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initial render</span></span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>()<span class="op">;</span></span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div style="display: flex; align-items: center; gap: 40px; justify-content: center;"&gt;</span></span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="display: flex; flex-direction: column; gap: 10px;"&gt;</span></span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>bankSliderObj<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>moneySliderObj<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>riverSliderObj<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/div&gt;</span></span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div&gt;</span></span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>plotContainer<span class="sc">}</span></span>
<span id="cb3-204"><a href="#cb3-204" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/div&gt;</span></span>
<span id="cb3-205"><a href="#cb3-205" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb3-206"><a href="#cb3-206" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-3" data-nodetype="expression">

</div>
</div>
</div>
<p>By changing the weights, we can see that the vector for “bank” can lean more towards the financial terms or the geographical terms. So how can we determine the weights?</p>
<p>The simplest idea is to give each word an equal weight: <span class="math inline">w_i = 1/N</span>. This creates a basic “bag-of-words” average. But sentences aren’t actually this fair—some words are much more important than others. For example, in “I deposited money at the bank,” the words “deposited” and “money” are key, while “I,” “at,” and “the” add little meaning. If we treat all words the same, we lose the details that matter. We need a way to highlight the important words and downplay the rest.</p>
</section>
<section id="attention-mechanism" class="level2 page-columns page-full" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="attention-mechanism"><span class="header-section-number">2</span> Attention mechanism</h2>
<p>Let’s walk through how transformers identify the surrounding words that are relevant to a focal word to be contextualized, which is called the <strong>attention mechanism</strong>. Before we dive into the attention mechanism, let’s first prepare some terminology.</p>
<p>Suppose we have a sentence “I deposited money at the bank”. Given a word “bank”, we want to determine the weights <span class="math inline">w_i</span> for the surrounding words “I”, “deposited”, “money”, and “at”. We call the word “bank” the <strong>query</strong> word, and the surrounding words the <strong>key</strong> words. At a high level, we want to compute the weights <span class="math inline">w_i</span> for each query and key pair, and then average them.</p>
<p><span class="math display">
\vec{v}_{\text{query}} ^{\text{c}} = \sum_{i=1}^N w_i \cdot \vec{v}_{i}
</span></p>
<p>with weights <span class="math inline">w_i</span> being determined by the query and key vectors <span class="math inline">w_{i}:=f(\vec{v}_{\text{query}}, \vec{v}_{i})</span>. This function, <span class="math inline">f</span>, is calle the <strong>attention score function</strong>.</p>
<p>In transformers, the attention score function <span class="math inline">f</span> is implemented as follows. Given the original vector for a word (regardless of whether it is the query word or the key word), we linearly transform it into three vectors: Query, Key, and Value.</p>
<p><span class="math display">
\begin{align}
\vec{q}_i &amp;= W_Q \vec{x}_i\\
\vec{k}_i &amp;= W_K \vec{x}_i\\
\vec{v}_i &amp;= W_V \vec{x}_i
\end{align}
</span></p>
<p>Why do we need three different vectors? Imagine you are participating in a dinner party. You want to identify the people who are talking about a topic you care about. You listen to the surrounding people, playing as a ‘listener’. At the same time, you also broadcast your own interests, playing as a ‘speaker’. The query vector is representing you as a listener, the key vector is representing the people as speakers. And the value vector is representing the content of the conversation.</p>
<p>Once we have the query, key, and value vectors, we can compute the attention scores between the query and key vector as follows:</p>
<p><span class="math display">
w_{ij} = \frac{\exp(\vec{q}_i \cdot \vec{k}_j / \sqrt{d})}{\sum_{\ell} \exp(\vec{q}_i \cdot \vec{k}_\ell / \sqrt{d})},
</span></p>
<p>where <span class="math inline">\vec{q}_i \cdot \vec{k}_j</span> is the dot product between the query and key vectors, which is larger when the query and key vectors are <em>similar</em> (e.g., pointing to a similar direction). The division by <span class="math inline">\sqrt{d}</span> (where <span class="math inline">d</span> is the embedding dimension) is a scaling factor that prevents vanishing gradients during training. Finally, compute the <strong>contextualized representation</strong> as a weighted sum: <span class="math inline">\text{contextualized}_i = \sum_j w_{ij} \vec{v}_j</span>.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>What is the vanishing gradient problem? It is a problem that the gradients of the loss function with respect to the weights become too small to be effective during training.</p>
</div></div><p>Explore how different Query and Key transformations produce different attention patterns. First, let us create the key, query, and value vectors. In 2d, the linear transformation is just a scaling and a rotation.</p>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb4" data-startfrom="259" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 258;"><span id="cb4-259"><a href="#cb4-259" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">createQKVSlider</span>(min<span class="op">,</span> max<span class="op">,</span> step<span class="op">,</span> width<span class="op">,</span> defaultValue<span class="op">,</span> label<span class="op">,</span> valueSetter) {</span>
<span id="cb4-260"><a href="#cb4-260" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> slider <span class="op">=</span> d3<span class="op">.</span><span class="fu">sliderBottom</span>()</span>
<span id="cb4-261"><a href="#cb4-261" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">min</span>(min)<span class="op">.</span><span class="fu">max</span>(max)<span class="op">.</span><span class="fu">step</span>(step)<span class="op">.</span><span class="fu">width</span>(width)<span class="op">.</span><span class="fu">default</span>(defaultValue)</span>
<span id="cb4-262"><a href="#cb4-262" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">on</span>(<span class="st">'onchange'</span><span class="op">,</span> val <span class="kw">=&gt;</span> <span class="fu">valueSetter</span>(val))<span class="op">;</span></span>
<span id="cb4-263"><a href="#cb4-263" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width <span class="op">+</span> <span class="dv">40</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> <span class="dv">50</span>)<span class="op">;</span></span>
<span id="cb4-264"><a href="#cb4-264" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> g <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="st">"translate(20,15)"</span>)<span class="op">;</span></span>
<span id="cb4-265"><a href="#cb4-265" aria-hidden="true" tabindex="-1"></a>  g<span class="op">.</span><span class="fu">call</span>(slider)<span class="op">;</span></span>
<span id="cb4-266"><a href="#cb4-266" aria-hidden="true" tabindex="-1"></a>  svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (width <span class="op">+</span> <span class="dv">40</span>) <span class="op">/</span> <span class="dv">2</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb4-267"><a href="#cb4-267" aria-hidden="true" tabindex="-1"></a>     <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"11px"</span>)<span class="op">.</span><span class="fu">text</span>(label)<span class="op">;</span></span>
<span id="cb4-268"><a href="#cb4-268" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> { <span class="dt">node</span><span class="op">:</span> svg<span class="op">.</span><span class="fu">node</span>()<span class="op">,</span> <span class="dt">slider</span><span class="op">:</span> slider }<span class="op">;</span></span>
<span id="cb4-269"><a href="#cb4-269" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb5" data-startfrom="274" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 273;"><span id="cb5-274"><a href="#cb5-274" aria-hidden="true" tabindex="-1"></a>mutable qScaleXValue <span class="op">=</span> <span class="fl">1.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-5" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb6" data-startfrom="279" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 278;"><span id="cb6-279"><a href="#cb6-279" aria-hidden="true" tabindex="-1"></a>mutable qScaleYValue <span class="op">=</span> <span class="fl">1.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-6" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb7" data-startfrom="284" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 283;"><span id="cb7-284"><a href="#cb7-284" aria-hidden="true" tabindex="-1"></a>mutable qRotateValue <span class="op">=</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-7" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb8" data-startfrom="289" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 288;"><span id="cb8-289"><a href="#cb8-289" aria-hidden="true" tabindex="-1"></a>mutable kScaleXValue <span class="op">=</span> <span class="fl">1.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-8" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb9" data-startfrom="294" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 293;"><span id="cb9-294"><a href="#cb9-294" aria-hidden="true" tabindex="-1"></a>mutable kScaleYValue <span class="op">=</span> <span class="fl">1.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-9" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb10" data-startfrom="299" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 298;"><span id="cb10-299"><a href="#cb10-299" aria-hidden="true" tabindex="-1"></a>mutable kRotateValue <span class="op">=</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-10" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb11" data-startfrom="304" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 303;"><span id="cb11-304"><a href="#cb11-304" aria-hidden="true" tabindex="-1"></a>qScaleXSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="fl">0.1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="st">"Q Scale X"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable qScaleXValue <span class="op">=</span> val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-11" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb12" data-startfrom="309" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 308;"><span id="cb12-309"><a href="#cb12-309" aria-hidden="true" tabindex="-1"></a>qScaleYSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="fl">0.1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="st">"Q Scale Y"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable qScaleYValue <span class="op">=</span> val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-12" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb13" data-startfrom="314" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 313;"><span id="cb13-314"><a href="#cb13-314" aria-hidden="true" tabindex="-1"></a>qRotateSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="op">-</span><span class="dv">180</span><span class="op">,</span> <span class="dv">180</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="st">"Q Rotate (deg)"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable qRotateValue <span class="op">=</span> val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-13" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb14" data-startfrom="319" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 318;"><span id="cb14-319"><a href="#cb14-319" aria-hidden="true" tabindex="-1"></a>kScaleXSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="fl">0.1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="st">"K Scale X"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable kScaleXValue <span class="op">=</span> val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-14" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb15" data-startfrom="324" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 323;"><span id="cb15-324"><a href="#cb15-324" aria-hidden="true" tabindex="-1"></a>kScaleYSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="fl">0.1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="st">"K Scale Y"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable kScaleYValue <span class="op">=</span> val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-15" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb16" data-startfrom="329" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 328;"><span id="cb16-329"><a href="#cb16-329" aria-hidden="true" tabindex="-1"></a>kRotateSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="op">-</span><span class="dv">180</span><span class="op">,</span> <span class="dv">180</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="st">"K Rotate (deg)"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable kRotateValue <span class="op">=</span> val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-16" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb17" data-startfrom="334" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 333;"><span id="cb17-334"><a href="#cb17-334" aria-hidden="true" tabindex="-1"></a>qkvVisualization <span class="op">=</span> {</span>
<span id="cb17-335"><a href="#cb17-335" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Original word vectors (bank, money, river)</span></span>
<span id="cb17-336"><a href="#cb17-336" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> originalVectors <span class="op">=</span> [</span>
<span id="cb17-337"><a href="#cb17-337" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">name</span><span class="op">:</span> <span class="st">"bank"</span><span class="op">,</span> <span class="dt">vector</span><span class="op">:</span> [<span class="fl">1.5</span><span class="op">,</span> <span class="fl">0.5</span>] }<span class="op">,</span></span>
<span id="cb17-338"><a href="#cb17-338" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">name</span><span class="op">:</span> <span class="st">"money"</span><span class="op">,</span> <span class="dt">vector</span><span class="op">:</span> [<span class="fl">1.8</span><span class="op">,</span> <span class="fl">0.8</span>] }<span class="op">,</span></span>
<span id="cb17-339"><a href="#cb17-339" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">name</span><span class="op">:</span> <span class="st">"river"</span><span class="op">,</span> <span class="dt">vector</span><span class="op">:</span> [<span class="fl">0.5</span><span class="op">,</span> <span class="fl">1.5</span>] }</span>
<span id="cb17-340"><a href="#cb17-340" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb17-341"><a href="#cb17-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-342"><a href="#cb17-342" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create plot containers</span></span>
<span id="cb17-343"><a href="#cb17-343" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qPlotContainer <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">"div"</span>)<span class="op">;</span></span>
<span id="cb17-344"><a href="#cb17-344" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kPlotContainer <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">"div"</span>)<span class="op">;</span></span>
<span id="cb17-345"><a href="#cb17-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-346"><a href="#cb17-346" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Function to transform vector</span></span>
<span id="cb17-347"><a href="#cb17-347" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">transformVector</span>(vec<span class="op">,</span> scaleX<span class="op">,</span> scaleY<span class="op">,</span> rotateDeg) {</span>
<span id="cb17-348"><a href="#cb17-348" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> theta <span class="op">=</span> (rotateDeg <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span>) <span class="op">/</span> <span class="dv">180</span><span class="op">;</span></span>
<span id="cb17-349"><a href="#cb17-349" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cos <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">cos</span>(theta)<span class="op">;</span></span>
<span id="cb17-350"><a href="#cb17-350" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sin <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(theta)<span class="op">;</span></span>
<span id="cb17-351"><a href="#cb17-351" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> scaledX <span class="op">=</span> vec[<span class="dv">0</span>] <span class="op">*</span> scaleX<span class="op">;</span></span>
<span id="cb17-352"><a href="#cb17-352" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> scaledY <span class="op">=</span> vec[<span class="dv">1</span>] <span class="op">*</span> scaleY<span class="op">;</span></span>
<span id="cb17-353"><a href="#cb17-353" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [</span>
<span id="cb17-354"><a href="#cb17-354" aria-hidden="true" tabindex="-1"></a>      scaledX <span class="op">*</span> cos <span class="op">-</span> scaledY <span class="op">*</span> sin<span class="op">,</span></span>
<span id="cb17-355"><a href="#cb17-355" aria-hidden="true" tabindex="-1"></a>      scaledX <span class="op">*</span> sin <span class="op">+</span> scaledY <span class="op">*</span> cos</span>
<span id="cb17-356"><a href="#cb17-356" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb17-357"><a href="#cb17-357" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-358"><a href="#cb17-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-359"><a href="#cb17-359" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get current slider values from mutable variables (creates reactive dependency)</span></span>
<span id="cb17-360"><a href="#cb17-360" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qScaleX <span class="op">=</span> qScaleXValue<span class="op">;</span></span>
<span id="cb17-361"><a href="#cb17-361" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qScaleY <span class="op">=</span> qScaleYValue<span class="op">;</span></span>
<span id="cb17-362"><a href="#cb17-362" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qRotate <span class="op">=</span> qRotateValue<span class="op">;</span></span>
<span id="cb17-363"><a href="#cb17-363" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kScaleX <span class="op">=</span> kScaleXValue<span class="op">;</span></span>
<span id="cb17-364"><a href="#cb17-364" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kScaleY <span class="op">=</span> kScaleYValue<span class="op">;</span></span>
<span id="cb17-365"><a href="#cb17-365" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kRotate <span class="op">=</span> kRotateValue<span class="op">;</span></span>
<span id="cb17-366"><a href="#cb17-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-367"><a href="#cb17-367" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Prepare data for each plot</span></span>
<span id="cb17-368"><a href="#cb17-368" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> originalData <span class="op">=</span> originalVectors<span class="op">.</span><span class="fu">map</span>(item <span class="kw">=&gt;</span> ({</span>
<span id="cb17-369"><a href="#cb17-369" aria-hidden="true" tabindex="-1"></a>    <span class="dt">name</span><span class="op">:</span> item<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb17-370"><a href="#cb17-370" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> item<span class="op">.</span><span class="at">vector</span>[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb17-371"><a href="#cb17-371" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> item<span class="op">.</span><span class="at">vector</span>[<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb17-372"><a href="#cb17-372" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"Original"</span></span>
<span id="cb17-373"><a href="#cb17-373" aria-hidden="true" tabindex="-1"></a>  }))<span class="op">;</span></span>
<span id="cb17-374"><a href="#cb17-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-375"><a href="#cb17-375" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qData <span class="op">=</span> originalVectors<span class="op">.</span><span class="fu">map</span>(item <span class="kw">=&gt;</span> {</span>
<span id="cb17-376"><a href="#cb17-376" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> qVec <span class="op">=</span> <span class="fu">transformVector</span>(item<span class="op">.</span><span class="at">vector</span><span class="op">,</span> qScaleX<span class="op">,</span> qScaleY<span class="op">,</span> qRotate)<span class="op">;</span></span>
<span id="cb17-377"><a href="#cb17-377" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb17-378"><a href="#cb17-378" aria-hidden="true" tabindex="-1"></a>      <span class="dt">name</span><span class="op">:</span> <span class="vs">`q_</span><span class="sc">${</span>item<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb17-379"><a href="#cb17-379" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> qVec[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb17-380"><a href="#cb17-380" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> qVec[<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb17-381"><a href="#cb17-381" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">"Query"</span></span>
<span id="cb17-382"><a href="#cb17-382" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb17-383"><a href="#cb17-383" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb17-384"><a href="#cb17-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-385"><a href="#cb17-385" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kData <span class="op">=</span> originalVectors<span class="op">.</span><span class="fu">map</span>(item <span class="kw">=&gt;</span> {</span>
<span id="cb17-386"><a href="#cb17-386" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> kVec <span class="op">=</span> <span class="fu">transformVector</span>(item<span class="op">.</span><span class="at">vector</span><span class="op">,</span> kScaleX<span class="op">,</span> kScaleY<span class="op">,</span> kRotate)<span class="op">;</span></span>
<span id="cb17-387"><a href="#cb17-387" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb17-388"><a href="#cb17-388" aria-hidden="true" tabindex="-1"></a>      <span class="dt">name</span><span class="op">:</span> <span class="vs">`k_</span><span class="sc">${</span>item<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb17-389"><a href="#cb17-389" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> kVec[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb17-390"><a href="#cb17-390" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> kVec[<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb17-391"><a href="#cb17-391" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">"Key"</span></span>
<span id="cb17-392"><a href="#cb17-392" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb17-393"><a href="#cb17-393" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb17-394"><a href="#cb17-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-395"><a href="#cb17-395" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create Query plot</span></span>
<span id="cb17-396"><a href="#cb17-396" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qPlot <span class="op">=</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb17-397"><a href="#cb17-397" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb17-398"><a href="#cb17-398" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb17-399"><a href="#cb17-399" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">40</span><span class="op">,</span></span>
<span id="cb17-400"><a href="#cb17-400" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb17-401"><a href="#cb17-401" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb17-402"><a href="#cb17-402" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb17-403"><a href="#cb17-403" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb17-404"><a href="#cb17-404" aria-hidden="true" tabindex="-1"></a>      <span class="dt">background</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span></span>
<span id="cb17-405"><a href="#cb17-405" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb17-406"><a href="#cb17-406" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb17-407"><a href="#cb17-407" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb17-408"><a href="#cb17-408" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">3</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span></span>
<span id="cb17-409"><a href="#cb17-409" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 1"</span><span class="op">,</span></span>
<span id="cb17-410"><a href="#cb17-410" aria-hidden="true" tabindex="-1"></a>      <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb17-411"><a href="#cb17-411" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb17-412"><a href="#cb17-412" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb17-413"><a href="#cb17-413" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb17-414"><a href="#cb17-414" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">3</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span></span>
<span id="cb17-415"><a href="#cb17-415" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 2"</span><span class="op">,</span></span>
<span id="cb17-416"><a href="#cb17-416" aria-hidden="true" tabindex="-1"></a>      <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb17-417"><a href="#cb17-417" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb17-418"><a href="#cb17-418" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb17-419"><a href="#cb17-419" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb17-420"><a href="#cb17-420" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>([{<span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="dv">0</span>}]<span class="op">,</span> {</span>
<span id="cb17-421"><a href="#cb17-421" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-422"><a href="#cb17-422" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-423"><a href="#cb17-423" aria-hidden="true" tabindex="-1"></a>        <span class="dt">r</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb17-424"><a href="#cb17-424" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb17-425"><a href="#cb17-425" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb17-426"><a href="#cb17-426" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">arrow</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>qData]<span class="op">,</span> {</span>
<span id="cb17-427"><a href="#cb17-427" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x1</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb17-428"><a href="#cb17-428" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y1</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb17-429"><a href="#cb17-429" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x2</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-430"><a href="#cb17-430" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y2</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-431"><a href="#cb17-431" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stroke</span><span class="op">:</span> <span class="st">"type"</span><span class="op">,</span></span>
<span id="cb17-432"><a href="#cb17-432" aria-hidden="true" tabindex="-1"></a>        <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb17-433"><a href="#cb17-433" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headLength</span><span class="op">:</span> <span class="dv">8</span></span>
<span id="cb17-434"><a href="#cb17-434" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb17-435"><a href="#cb17-435" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>qData]<span class="op">,</span> {</span>
<span id="cb17-436"><a href="#cb17-436" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-437"><a href="#cb17-437" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-438"><a href="#cb17-438" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"type"</span><span class="op">,</span></span>
<span id="cb17-439"><a href="#cb17-439" aria-hidden="true" tabindex="-1"></a>        <span class="dt">r</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb17-440"><a href="#cb17-440" aria-hidden="true" tabindex="-1"></a>        <span class="dt">tip</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb17-441"><a href="#cb17-441" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb17-442"><a href="#cb17-442" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>qData]<span class="op">,</span> {</span>
<span id="cb17-443"><a href="#cb17-443" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-444"><a href="#cb17-444" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-445"><a href="#cb17-445" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> <span class="st">"name"</span><span class="op">,</span></span>
<span id="cb17-446"><a href="#cb17-446" aria-hidden="true" tabindex="-1"></a>        <span class="dt">dy</span><span class="op">:</span> <span class="op">-</span><span class="dv">12</span><span class="op">,</span></span>
<span id="cb17-447"><a href="#cb17-447" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">9</span><span class="op">,</span></span>
<span id="cb17-448"><a href="#cb17-448" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb17-449"><a href="#cb17-449" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb17-450"><a href="#cb17-450" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb17-451"><a href="#cb17-451" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([{ <span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">3.4</span> }]<span class="op">,</span> {</span>
<span id="cb17-452"><a href="#cb17-452" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-453"><a href="#cb17-453" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-454"><a href="#cb17-454" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="st">"Query Space"</span><span class="op">,</span></span>
<span id="cb17-455"><a href="#cb17-455" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span></span>
<span id="cb17-456"><a href="#cb17-456" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb17-457"><a href="#cb17-457" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb17-458"><a href="#cb17-458" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb17-459"><a href="#cb17-459" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb17-460"><a href="#cb17-460" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb17-461"><a href="#cb17-461" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="st">"Original"</span><span class="op">,</span> <span class="st">"Query"</span>]<span class="op">,</span></span>
<span id="cb17-462"><a href="#cb17-462" aria-hidden="true" tabindex="-1"></a>      <span class="dt">range</span><span class="op">:</span> [<span class="st">"#666666"</span><span class="op">,</span> <span class="st">"#4682b4"</span>]</span>
<span id="cb17-463"><a href="#cb17-463" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-464"><a href="#cb17-464" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb17-465"><a href="#cb17-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-466"><a href="#cb17-466" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create Key plot</span></span>
<span id="cb17-467"><a href="#cb17-467" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kPlot <span class="op">=</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb17-468"><a href="#cb17-468" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb17-469"><a href="#cb17-469" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb17-470"><a href="#cb17-470" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">40</span><span class="op">,</span></span>
<span id="cb17-471"><a href="#cb17-471" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb17-472"><a href="#cb17-472" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb17-473"><a href="#cb17-473" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb17-474"><a href="#cb17-474" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb17-475"><a href="#cb17-475" aria-hidden="true" tabindex="-1"></a>      <span class="dt">background</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span></span>
<span id="cb17-476"><a href="#cb17-476" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb17-477"><a href="#cb17-477" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb17-478"><a href="#cb17-478" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb17-479"><a href="#cb17-479" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">3</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span></span>
<span id="cb17-480"><a href="#cb17-480" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 1"</span><span class="op">,</span></span>
<span id="cb17-481"><a href="#cb17-481" aria-hidden="true" tabindex="-1"></a>      <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb17-482"><a href="#cb17-482" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb17-483"><a href="#cb17-483" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb17-484"><a href="#cb17-484" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb17-485"><a href="#cb17-485" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">3</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span></span>
<span id="cb17-486"><a href="#cb17-486" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 2"</span><span class="op">,</span></span>
<span id="cb17-487"><a href="#cb17-487" aria-hidden="true" tabindex="-1"></a>      <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb17-488"><a href="#cb17-488" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb17-489"><a href="#cb17-489" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb17-490"><a href="#cb17-490" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb17-491"><a href="#cb17-491" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>([{<span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="dv">0</span>}]<span class="op">,</span> {</span>
<span id="cb17-492"><a href="#cb17-492" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-493"><a href="#cb17-493" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-494"><a href="#cb17-494" aria-hidden="true" tabindex="-1"></a>        <span class="dt">r</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb17-495"><a href="#cb17-495" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb17-496"><a href="#cb17-496" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb17-497"><a href="#cb17-497" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">arrow</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>kData]<span class="op">,</span> {</span>
<span id="cb17-498"><a href="#cb17-498" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x1</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb17-499"><a href="#cb17-499" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y1</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb17-500"><a href="#cb17-500" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x2</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-501"><a href="#cb17-501" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y2</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-502"><a href="#cb17-502" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stroke</span><span class="op">:</span> <span class="st">"type"</span><span class="op">,</span></span>
<span id="cb17-503"><a href="#cb17-503" aria-hidden="true" tabindex="-1"></a>        <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb17-504"><a href="#cb17-504" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headLength</span><span class="op">:</span> <span class="dv">8</span></span>
<span id="cb17-505"><a href="#cb17-505" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb17-506"><a href="#cb17-506" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>kData]<span class="op">,</span> {</span>
<span id="cb17-507"><a href="#cb17-507" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-508"><a href="#cb17-508" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-509"><a href="#cb17-509" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"type"</span><span class="op">,</span></span>
<span id="cb17-510"><a href="#cb17-510" aria-hidden="true" tabindex="-1"></a>        <span class="dt">r</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb17-511"><a href="#cb17-511" aria-hidden="true" tabindex="-1"></a>        <span class="dt">tip</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb17-512"><a href="#cb17-512" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb17-513"><a href="#cb17-513" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>kData]<span class="op">,</span> {</span>
<span id="cb17-514"><a href="#cb17-514" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-515"><a href="#cb17-515" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-516"><a href="#cb17-516" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> <span class="st">"name"</span><span class="op">,</span></span>
<span id="cb17-517"><a href="#cb17-517" aria-hidden="true" tabindex="-1"></a>        <span class="dt">dy</span><span class="op">:</span> <span class="op">-</span><span class="dv">12</span><span class="op">,</span></span>
<span id="cb17-518"><a href="#cb17-518" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">9</span><span class="op">,</span></span>
<span id="cb17-519"><a href="#cb17-519" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb17-520"><a href="#cb17-520" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb17-521"><a href="#cb17-521" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb17-522"><a href="#cb17-522" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([{ <span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">3.4</span> }]<span class="op">,</span> {</span>
<span id="cb17-523"><a href="#cb17-523" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb17-524"><a href="#cb17-524" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb17-525"><a href="#cb17-525" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="st">"Key Space"</span><span class="op">,</span></span>
<span id="cb17-526"><a href="#cb17-526" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span></span>
<span id="cb17-527"><a href="#cb17-527" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb17-528"><a href="#cb17-528" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb17-529"><a href="#cb17-529" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb17-530"><a href="#cb17-530" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb17-531"><a href="#cb17-531" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb17-532"><a href="#cb17-532" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="st">"Original"</span><span class="op">,</span> <span class="st">"Key"</span>]<span class="op">,</span></span>
<span id="cb17-533"><a href="#cb17-533" aria-hidden="true" tabindex="-1"></a>      <span class="dt">range</span><span class="op">:</span> [<span class="st">"#666666"</span><span class="op">,</span> <span class="st">"#2e8b57"</span>]</span>
<span id="cb17-534"><a href="#cb17-534" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-535"><a href="#cb17-535" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb17-536"><a href="#cb17-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-537"><a href="#cb17-537" aria-hidden="true" tabindex="-1"></a>  d3<span class="op">.</span><span class="fu">select</span>(qPlotContainer)<span class="op">.</span><span class="fu">node</span>()<span class="op">.</span><span class="fu">appendChild</span>(qPlot)<span class="op">;</span></span>
<span id="cb17-538"><a href="#cb17-538" aria-hidden="true" tabindex="-1"></a>  d3<span class="op">.</span><span class="fu">select</span>(kPlotContainer)<span class="op">.</span><span class="fu">node</span>()<span class="op">.</span><span class="fu">appendChild</span>(kPlot)<span class="op">;</span></span>
<span id="cb17-539"><a href="#cb17-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-540"><a href="#cb17-540" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div style="display: flex; justify-content: center; gap: 40px;"&gt;</span></span>
<span id="cb17-541"><a href="#cb17-541" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="display: flex; flex-direction: column; gap: 20px;"&gt;</span></span>
<span id="cb17-542"><a href="#cb17-542" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div style="display: flex; align-items: center; gap: 20px;"&gt;</span></span>
<span id="cb17-543"><a href="#cb17-543" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style="display: flex; flex-direction: column; gap: 8px;"&gt;</span></span>
<span id="cb17-544"><a href="#cb17-544" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div style="font-weight: bold; margin-bottom: 3px;"&gt;Query (W_Q)&lt;/div&gt;</span></span>
<span id="cb17-545"><a href="#cb17-545" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>qScaleXSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb17-546"><a href="#cb17-546" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>qScaleYSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb17-547"><a href="#cb17-547" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>qRotateSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb17-548"><a href="#cb17-548" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb17-549"><a href="#cb17-549" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span>qPlotContainer<span class="sc">}</span></span>
<span id="cb17-550"><a href="#cb17-550" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb17-551"><a href="#cb17-551" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div style="display: flex; align-items: center; gap: 20px;"&gt;</span></span>
<span id="cb17-552"><a href="#cb17-552" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style="display: flex; flex-direction: column; gap: 8px;"&gt;</span></span>
<span id="cb17-553"><a href="#cb17-553" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div style="font-weight: bold; margin-bottom: 3px;"&gt;Key (W_K)&lt;/div&gt;</span></span>
<span id="cb17-554"><a href="#cb17-554" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>kScaleXSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb17-555"><a href="#cb17-555" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>kScaleYSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb17-556"><a href="#cb17-556" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>kRotateSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb17-557"><a href="#cb17-557" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb17-558"><a href="#cb17-558" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span>kPlotContainer<span class="sc">}</span></span>
<span id="cb17-559"><a href="#cb17-559" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb17-560"><a href="#cb17-560" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/div&gt;</span></span>
<span id="cb17-561"><a href="#cb17-561" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb17-562"><a href="#cb17-562" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-17" data-nodetype="declaration">

</div>
</div>
</div>
<p>Using the transformations above, we can compute the attention weights showing how each word attends to every other word:</p>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb18" data-startfrom="570" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 569;"><span id="cb18-570"><a href="#cb18-570" aria-hidden="true" tabindex="-1"></a>attentionHeatmap <span class="op">=</span> {</span>
<span id="cb18-571"><a href="#cb18-571" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get the original word vectors from the previous visualization</span></span>
<span id="cb18-572"><a href="#cb18-572" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> attentionWords <span class="op">=</span> [<span class="st">"bank"</span><span class="op">,</span> <span class="st">"money"</span><span class="op">,</span> <span class="st">"river"</span>]<span class="op">;</span></span>
<span id="cb18-573"><a href="#cb18-573" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> attentionEmbeddings <span class="op">=</span> [</span>
<span id="cb18-574"><a href="#cb18-574" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">1.5</span><span class="op">,</span> <span class="fl">0.5</span>]<span class="op">,</span></span>
<span id="cb18-575"><a href="#cb18-575" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">1.8</span><span class="op">,</span> <span class="fl">0.8</span>]<span class="op">,</span></span>
<span id="cb18-576"><a href="#cb18-576" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.5</span><span class="op">,</span> <span class="fl">1.5</span>]</span>
<span id="cb18-577"><a href="#cb18-577" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb18-578"><a href="#cb18-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-579"><a href="#cb18-579" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Transform vector function</span></span>
<span id="cb18-580"><a href="#cb18-580" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">transformVector</span>(vec<span class="op">,</span> scaleX<span class="op">,</span> scaleY<span class="op">,</span> rotateDeg) {</span>
<span id="cb18-581"><a href="#cb18-581" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> theta <span class="op">=</span> (rotateDeg <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span>) <span class="op">/</span> <span class="dv">180</span><span class="op">;</span></span>
<span id="cb18-582"><a href="#cb18-582" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cos <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">cos</span>(theta)<span class="op">;</span></span>
<span id="cb18-583"><a href="#cb18-583" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sin <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(theta)<span class="op">;</span></span>
<span id="cb18-584"><a href="#cb18-584" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> scaledX <span class="op">=</span> vec[<span class="dv">0</span>] <span class="op">*</span> scaleX<span class="op">;</span></span>
<span id="cb18-585"><a href="#cb18-585" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> scaledY <span class="op">=</span> vec[<span class="dv">1</span>] <span class="op">*</span> scaleY<span class="op">;</span></span>
<span id="cb18-586"><a href="#cb18-586" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [</span>
<span id="cb18-587"><a href="#cb18-587" aria-hidden="true" tabindex="-1"></a>      scaledX <span class="op">*</span> cos <span class="op">-</span> scaledY <span class="op">*</span> sin<span class="op">,</span></span>
<span id="cb18-588"><a href="#cb18-588" aria-hidden="true" tabindex="-1"></a>      scaledX <span class="op">*</span> sin <span class="op">+</span> scaledY <span class="op">*</span> cos</span>
<span id="cb18-589"><a href="#cb18-589" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb18-590"><a href="#cb18-590" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-591"><a href="#cb18-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-592"><a href="#cb18-592" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get current slider values from mutable variables (creates reactive dependency)</span></span>
<span id="cb18-593"><a href="#cb18-593" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qScaleX <span class="op">=</span> qScaleXValue<span class="op">;</span></span>
<span id="cb18-594"><a href="#cb18-594" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qScaleY <span class="op">=</span> qScaleYValue<span class="op">;</span></span>
<span id="cb18-595"><a href="#cb18-595" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qRotate <span class="op">=</span> qRotateValue<span class="op">;</span></span>
<span id="cb18-596"><a href="#cb18-596" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kScaleX <span class="op">=</span> kScaleXValue<span class="op">;</span></span>
<span id="cb18-597"><a href="#cb18-597" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kScaleY <span class="op">=</span> kScaleYValue<span class="op">;</span></span>
<span id="cb18-598"><a href="#cb18-598" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kRotate <span class="op">=</span> kRotateValue<span class="op">;</span></span>
<span id="cb18-599"><a href="#cb18-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-600"><a href="#cb18-600" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Apply transformations</span></span>
<span id="cb18-601"><a href="#cb18-601" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> Q <span class="op">=</span> attentionEmbeddings<span class="op">.</span><span class="fu">map</span>(vec <span class="kw">=&gt;</span></span>
<span id="cb18-602"><a href="#cb18-602" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transformVector</span>(vec<span class="op">,</span> qScaleX<span class="op">,</span> qScaleY<span class="op">,</span> qRotate)</span>
<span id="cb18-603"><a href="#cb18-603" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb18-604"><a href="#cb18-604" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> K <span class="op">=</span> attentionEmbeddings<span class="op">.</span><span class="fu">map</span>(vec <span class="kw">=&gt;</span></span>
<span id="cb18-605"><a href="#cb18-605" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transformVector</span>(vec<span class="op">,</span> kScaleX<span class="op">,</span> kScaleY<span class="op">,</span> kRotate)</span>
<span id="cb18-606"><a href="#cb18-606" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb18-607"><a href="#cb18-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-608"><a href="#cb18-608" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute attention scores (Q @ K^T)</span></span>
<span id="cb18-609"><a href="#cb18-609" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> scores <span class="op">=</span> Q<span class="op">.</span><span class="fu">map</span>(q <span class="kw">=&gt;</span> K<span class="op">.</span><span class="fu">map</span>(k <span class="kw">=&gt;</span> q[<span class="dv">0</span>] <span class="op">*</span> k[<span class="dv">0</span>] <span class="op">+</span> q[<span class="dv">1</span>] <span class="op">*</span> k[<span class="dv">1</span>]))<span class="op">;</span></span>
<span id="cb18-610"><a href="#cb18-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-611"><a href="#cb18-611" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Apply softmax to each row</span></span>
<span id="cb18-612"><a href="#cb18-612" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> attentionWeights <span class="op">=</span> scores<span class="op">.</span><span class="fu">map</span>(row <span class="kw">=&gt;</span> {</span>
<span id="cb18-613"><a href="#cb18-613" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> maxScore <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(<span class="op">...</span>row)<span class="op">;</span></span>
<span id="cb18-614"><a href="#cb18-614" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> expScores <span class="op">=</span> row<span class="op">.</span><span class="fu">map</span>(s <span class="kw">=&gt;</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">exp</span>(s <span class="op">-</span> maxScore))<span class="op">;</span></span>
<span id="cb18-615"><a href="#cb18-615" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sumExp <span class="op">=</span> expScores<span class="op">.</span><span class="fu">reduce</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a <span class="op">+</span> b<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb18-616"><a href="#cb18-616" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> expScores<span class="op">.</span><span class="fu">map</span>(e <span class="kw">=&gt;</span> e <span class="op">/</span> sumExp)<span class="op">;</span></span>
<span id="cb18-617"><a href="#cb18-617" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb18-618"><a href="#cb18-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-619"><a href="#cb18-619" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Prepare data for heatmap</span></span>
<span id="cb18-620"><a href="#cb18-620" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> heatmapData <span class="op">=</span> (() <span class="kw">=&gt;</span> {</span>
<span id="cb18-621"><a href="#cb18-621" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb18-622"><a href="#cb18-622" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> attentionWords<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb18-623"><a href="#cb18-623" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">let</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> attentionWords<span class="op">.</span><span class="at">length</span><span class="op">;</span> j<span class="op">++</span>) {</span>
<span id="cb18-624"><a href="#cb18-624" aria-hidden="true" tabindex="-1"></a>        data<span class="op">.</span><span class="fu">push</span>({</span>
<span id="cb18-625"><a href="#cb18-625" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Query</span><span class="op">:</span> attentionWords[i]<span class="op">,</span></span>
<span id="cb18-626"><a href="#cb18-626" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Key</span><span class="op">:</span> attentionWords[j]<span class="op">,</span></span>
<span id="cb18-627"><a href="#cb18-627" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Weight</span><span class="op">:</span> attentionWeights[i][j]</span>
<span id="cb18-628"><a href="#cb18-628" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb18-629"><a href="#cb18-629" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb18-630"><a href="#cb18-630" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-631"><a href="#cb18-631" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb18-632"><a href="#cb18-632" aria-hidden="true" tabindex="-1"></a>  })()<span class="op">;</span></span>
<span id="cb18-633"><a href="#cb18-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-634"><a href="#cb18-634" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create attention heatmap</span></span>
<span id="cb18-635"><a href="#cb18-635" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb18-636"><a href="#cb18-636" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">320</span><span class="op">,</span></span>
<span id="cb18-637"><a href="#cb18-637" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">320</span><span class="op">,</span></span>
<span id="cb18-638"><a href="#cb18-638" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb18-639"><a href="#cb18-639" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb18-640"><a href="#cb18-640" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">70</span><span class="op">,</span></span>
<span id="cb18-641"><a href="#cb18-641" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">80</span><span class="op">,</span></span>
<span id="cb18-642"><a href="#cb18-642" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb18-643"><a href="#cb18-643" aria-hidden="true" tabindex="-1"></a>      <span class="dt">background</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span></span>
<span id="cb18-644"><a href="#cb18-644" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb18-645"><a href="#cb18-645" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb18-646"><a href="#cb18-646" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> { <span class="dt">label</span><span class="op">:</span> <span class="st">"Key Word"</span> }<span class="op">,</span></span>
<span id="cb18-647"><a href="#cb18-647" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> { <span class="dt">label</span><span class="op">:</span> <span class="st">"Query Word"</span> }<span class="op">,</span></span>
<span id="cb18-648"><a href="#cb18-648" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb18-649"><a href="#cb18-649" aria-hidden="true" tabindex="-1"></a>      <span class="dt">scheme</span><span class="op">:</span> <span class="st">"Blues"</span><span class="op">,</span></span>
<span id="cb18-650"><a href="#cb18-650" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Attention"</span><span class="op">,</span></span>
<span id="cb18-651"><a href="#cb18-651" aria-hidden="true" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb18-652"><a href="#cb18-652" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb18-653"><a href="#cb18-653" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb18-654"><a href="#cb18-654" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">cell</span>(heatmapData<span class="op">,</span> {</span>
<span id="cb18-655"><a href="#cb18-655" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"Key"</span><span class="op">,</span></span>
<span id="cb18-656"><a href="#cb18-656" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"Query"</span><span class="op">,</span></span>
<span id="cb18-657"><a href="#cb18-657" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"Weight"</span><span class="op">,</span></span>
<span id="cb18-658"><a href="#cb18-658" aria-hidden="true" tabindex="-1"></a>        <span class="dt">tip</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb18-659"><a href="#cb18-659" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb18-660"><a href="#cb18-660" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>(heatmapData<span class="op">,</span> {</span>
<span id="cb18-661"><a href="#cb18-661" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"Key"</span><span class="op">,</span></span>
<span id="cb18-662"><a href="#cb18-662" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"Query"</span><span class="op">,</span></span>
<span id="cb18-663"><a href="#cb18-663" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">Weight</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">,</span></span>
<span id="cb18-664"><a href="#cb18-664" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">Weight</span> <span class="op">&gt;</span> <span class="fl">0.35</span> <span class="op">?</span> <span class="st">"white"</span> <span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb18-665"><a href="#cb18-665" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">11</span></span>
<span id="cb18-666"><a href="#cb18-666" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb18-667"><a href="#cb18-667" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([{ <span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="dv">0</span> }]<span class="op">,</span> {</span>
<span id="cb18-668"><a href="#cb18-668" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> () <span class="kw">=&gt;</span> attentionWords<span class="op">.</span><span class="at">length</span> <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb18-669"><a href="#cb18-669" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="op">-</span><span class="fl">0.8</span><span class="op">,</span></span>
<span id="cb18-670"><a href="#cb18-670" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="st">"Attention Weights (Softmax)"</span><span class="op">,</span></span>
<span id="cb18-671"><a href="#cb18-671" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span></span>
<span id="cb18-672"><a href="#cb18-672" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb18-673"><a href="#cb18-673" aria-hidden="true" tabindex="-1"></a>        <span class="dt">frameAnchor</span><span class="op">:</span> <span class="st">"top"</span><span class="op">,</span></span>
<span id="cb18-674"><a href="#cb18-674" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb18-675"><a href="#cb18-675" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb18-676"><a href="#cb18-676" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb18-677"><a href="#cb18-677" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb18-678"><a href="#cb18-678" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-18" data-nodetype="declaration">

</div>
</div>
</div>
<p>Now scale this up. <strong>Every word</strong> in a sentence needs to attend to <strong>every other word</strong>. For “The cat sat on the mat” (six words), we compute a <span class="math inline">6 \times 6</span> <strong>attention matrix</strong> <span class="math inline">A</span>, where <span class="math inline">A_{ij} = \text{softmax}(\vec{q}_i \cdot \vec{k}_j)</span>. Rows represent words asking for context (Queries); columns represent words providing context (Keys). Each cell <span class="math inline">(i,j)</span> indicates how much word <span class="math inline">i</span> attends to word <span class="math inline">j</span>. Each row sums to 1—it’s a probability distribution over context words.</p>
<p>But here’s the final complication: <strong>one attention matrix captures one type of relationship</strong>. Language is multidimensional. There are syntactic relationships (subject-verb-object), semantic relationships (conceptual similarity between “cat” and “mat” as physical objects), positional relationships (local word order), and pragmatic relationships (coreference, where “her” links to “scientist”). A single attention mechanism can’t capture all of these simultaneously.</p>
<p><img src="../figs/transformer-multihead-attention.jpg" class="img-fluid"></p>
<p>The solution is <strong>multi-head attention</strong>: run multiple attention mechanisms in parallel, each with its own <span class="math inline">W_Q</span>, <span class="math inline">W_K</span>, <span class="math inline">W_V</span> matrices. Mathematically, <span class="math inline">\text{MultiHead}(X) = \text{Concat}(\text{head}_1, \text{head}_2, \ldots, \text{head}_h) W^O</span>. Each head learns a different attention pattern. Modern transformers use 8-16 heads per layer: BERT uses 12, GPT-3 uses 96. It’s like having twelve different experts analyze the sentence simultaneously—one focusing on syntax, one on semantics, one on coreference—and then combining their insights through a learned linear transformation.</p>
</section>
<section id="the-complete-architecture-engineering-for-scale" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="the-complete-architecture-engineering-for-scale"><span class="header-section-number">3</span> The Complete Architecture: Engineering for Scale</h2>
<p>You’ve now discovered the core innovation: <strong>self-attention via Query-Key-Value</strong>. But a working transformer needs additional engineering to make this mechanism trainable at scale.</p>
<p><strong>Positional encoding</strong> solves the problem that attention is permutation-invariant. Without extra information, “cat sat” equals “sat cat” because the dot products don’t encode order. The solution is to add position-dependent vectors to embeddings: <span class="math inline">\text{input}_i = \text{embedding}_i + \text{position}_i</span>. Transformers use sinusoidal functions of varying frequencies: <span class="math inline">\text{PE}(pos, 2i) = \sin(pos / 10000^{2i/d})</span> and <span class="math inline">\text{PE}(pos, 2i+1) = \cos(pos / 10000^{2i/d})</span>. This gives the model access to both absolute position and relative distances between words.</p>
<p><strong>Residual connections</strong> create highways for gradient flow. Deep networks suffer from vanishing gradients—signals decay exponentially as they backpropagate through layers. The solution is skip connections: <span class="math inline">\text{output} = \text{LayerNorm}(x + \text{Attention}(x))</span>. This allows gradients to flow backward through 12-24 layers without vanishing.</p>
<p><strong>Feed-forward networks</strong> add processing power beyond attention. After the attention sublayer, each word’s representation passes through a small multi-layer perceptron independently: <span class="math inline">\text{FFN}(x) = \text{ReLU}(x W_1 + b_1) W_2 + b_2</span>. This introduces non-linearity and gives the model capacity to learn complex transformations.</p>
<p><strong>Layer normalization</strong> keeps activations in a stable numerical range during training, preventing exploding or vanishing values that would make gradient descent unstable.</p>
<p>The complete transformer block, repeated 12 or more times, looks like this: Input → Multi-Head Self-Attention → Add &amp; LayerNorm (residual) → Feed-Forward Network → Add &amp; LayerNorm (residual) → Output passed to next block.</p>
<p>Here’s what matters: residual connections, layer normalization, and feed-forward networks all existed before 2017. The transformer’s innovation is self-attention. That single mechanism replaced recurrent neural networks (RNNs), long short-term memory networks (LSTMs), and convolutional approaches for natural language processing. The original paper’s title—<em>“Attention Is All You Need”</em>—was provocative but accurate.</p>
<p>The attention mechanism gets deployed differently depending on the task. <strong>Encoder-only architectures</strong> like BERT use bidirectional attention where word <span class="math inline">i</span> can attend to all words, past and future. These models excel at understanding text for classification, embeddings, and extraction tasks. You feed in “Is this paper about networks or biology?” and get back a classification. <strong>Decoder-only architectures</strong> like GPT and Gemma use causal attention (masked) where word <span class="math inline">i</span> can only attend to words at positions <span class="math inline">\leq i</span>. This prevents “looking into the future” during autoregressive generation. When generating text word-by-word, you can’t use words you haven’t generated yet. These models excel at completion and chat. <strong>Encoder-decoder architectures</strong> like the original transformer use bidirectional attention in the encoder to process input, causal attention in the decoder for output generation, plus <strong>cross-attention</strong> where the decoder’s Query vectors attend to the encoder’s Key and Value vectors. These models excel at sequence-to-sequence tasks like translation: “Hello world” → “Bonjour monde.”</p>
</section>
<section id="why-this-changed-everything" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="why-this-changed-everything"><span class="header-section-number">4</span> Why This Changed Everything</h2>
<p>Before transformers, natural language processing used <strong>sequential processing</strong> via recurrent neural networks. The computational graph looked like: Word 1 → Hidden State 1 → Word 2 → Hidden State 2 → and so on. This architecture had three fatal flaws. First, sequential computation is inherently slow—you can’t parallelize across words because each hidden state depends on the previous one. Second, information decays over long distances due to vanishing gradients; dependencies 100+ words apart become nearly impossible to learn. Third, the fixed-size hidden state creates an information bottleneck for long sequences.</p>
<p>Transformers solved all three problems simultaneously. <strong>Parallel processing</strong> means all words are processed simultaneously, yielding 100× faster training on modern GPUs. <strong>Arbitrary long-range dependencies</strong> become tractable because “bank” in position 50 can directly attend to “money” in position 2 through a single matrix multiplication—no gradients need to flow through 48 intermediate steps. <strong>Scalability</strong> emerged as a predictable phenomenon: performance scales logarithmically with parameters. This revealed a stunning empirical fact—bigger models aren’t just incrementally better; they unlock <strong>qualitatively new capabilities</strong> like in-context learning and multi-step reasoning. This is why GPT-4 dramatically exceeds GPT-3, which dramatically exceeds GPT-2, despite using essentially the same architecture.</p>
<p>Consider a concrete example of how attention captures linguistic structure. Take the sentence “The scientist published her paper.” We want to resolve the coreference: what does “her” refer to?</p>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb19" data-startfrom="717" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 716;"><span id="cb19-717"><a href="#cb19-717" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb19-718"><a href="#cb19-718" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> words <span class="op">=</span> [<span class="st">"The"</span><span class="op">,</span> <span class="st">"scientist"</span><span class="op">,</span> <span class="st">"published"</span><span class="op">,</span> <span class="st">"her"</span><span class="op">,</span> <span class="st">"paper"</span>]<span class="op">;</span></span>
<span id="cb19-719"><a href="#cb19-719" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> attention <span class="op">=</span> [</span>
<span id="cb19-720"><a href="#cb19-720" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.5</span><span class="op">,</span> <span class="fl">0.3</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.05</span><span class="op">,</span> <span class="fl">0.05</span>]<span class="op">,</span>   <span class="co">// "The"→"scientist"</span></span>
<span id="cb19-721"><a href="#cb19-721" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.5</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.05</span><span class="op">,</span> <span class="fl">0.05</span>]<span class="op">,</span>   <span class="co">// "scientist"</span></span>
<span id="cb19-722"><a href="#cb19-722" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.05</span><span class="op">,</span> <span class="fl">0.3</span><span class="op">,</span> <span class="fl">0.4</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.15</span>]<span class="op">,</span>   <span class="co">// "published"</span></span>
<span id="cb19-723"><a href="#cb19-723" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.05</span><span class="op">,</span> <span class="fl">0.6</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.05</span>]<span class="op">,</span>   <span class="co">// "her"→"scientist" ← KEY!</span></span>
<span id="cb19-724"><a href="#cb19-724" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.05</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.15</span><span class="op">,</span> <span class="fl">0.5</span>]    <span class="co">// "paper"</span></span>
<span id="cb19-725"><a href="#cb19-725" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb19-726"><a href="#cb19-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-727"><a href="#cb19-727" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Prepare heatmap data</span></span>
<span id="cb19-728"><a href="#cb19-728" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> heatmapData <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb19-729"><a href="#cb19-729" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> words<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb19-730"><a href="#cb19-730" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> words<span class="op">.</span><span class="at">length</span><span class="op">;</span> j<span class="op">++</span>) {</span>
<span id="cb19-731"><a href="#cb19-731" aria-hidden="true" tabindex="-1"></a>      heatmapData<span class="op">.</span><span class="fu">push</span>({</span>
<span id="cb19-732"><a href="#cb19-732" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Word</span><span class="op">:</span> words[i]<span class="op">,</span></span>
<span id="cb19-733"><a href="#cb19-733" aria-hidden="true" tabindex="-1"></a>        <span class="dt">AttendsTo</span><span class="op">:</span> words[j]<span class="op">,</span></span>
<span id="cb19-734"><a href="#cb19-734" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Weight</span><span class="op">:</span> attention[i][j]<span class="op">,</span></span>
<span id="cb19-735"><a href="#cb19-735" aria-hidden="true" tabindex="-1"></a>        <span class="dt">isHighlight</span><span class="op">:</span> i <span class="op">===</span> <span class="dv">3</span> <span class="op">&amp;&amp;</span> j <span class="op">===</span> <span class="dv">1</span>  <span class="co">// "her" → "scientist"</span></span>
<span id="cb19-736"><a href="#cb19-736" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb19-737"><a href="#cb19-737" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-738"><a href="#cb19-738" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-739"><a href="#cb19-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-740"><a href="#cb19-740" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb19-741"><a href="#cb19-741" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb19-742"><a href="#cb19-742" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">400</span><span class="op">,</span></span>
<span id="cb19-743"><a href="#cb19-743" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb19-744"><a href="#cb19-744" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb19-745"><a href="#cb19-745" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">90</span><span class="op">,</span></span>
<span id="cb19-746"><a href="#cb19-746" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">120</span><span class="op">,</span></span>
<span id="cb19-747"><a href="#cb19-747" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb19-748"><a href="#cb19-748" aria-hidden="true" tabindex="-1"></a>      <span class="dt">background</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span></span>
<span id="cb19-749"><a href="#cb19-749" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb19-750"><a href="#cb19-750" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb19-751"><a href="#cb19-751" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb19-752"><a href="#cb19-752" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Attends To →"</span><span class="op">,</span></span>
<span id="cb19-753"><a href="#cb19-753" aria-hidden="true" tabindex="-1"></a>      <span class="dt">labelAnchor</span><span class="op">:</span> <span class="st">"center"</span></span>
<span id="cb19-754"><a href="#cb19-754" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb19-755"><a href="#cb19-755" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb19-756"><a href="#cb19-756" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"↑ Word"</span><span class="op">,</span></span>
<span id="cb19-757"><a href="#cb19-757" aria-hidden="true" tabindex="-1"></a>      <span class="dt">labelAnchor</span><span class="op">:</span> <span class="st">"center"</span></span>
<span id="cb19-758"><a href="#cb19-758" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb19-759"><a href="#cb19-759" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb19-760"><a href="#cb19-760" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">"linear"</span><span class="op">,</span></span>
<span id="cb19-761"><a href="#cb19-761" aria-hidden="true" tabindex="-1"></a>      <span class="dt">scheme</span><span class="op">:</span> <span class="st">"Purples"</span><span class="op">,</span></span>
<span id="cb19-762"><a href="#cb19-762" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="fl">0.6</span>]<span class="op">,</span></span>
<span id="cb19-763"><a href="#cb19-763" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Attention Weight"</span><span class="op">,</span></span>
<span id="cb19-764"><a href="#cb19-764" aria-hidden="true" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb19-765"><a href="#cb19-765" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb19-766"><a href="#cb19-766" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb19-767"><a href="#cb19-767" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">cell</span>(heatmapData<span class="op">,</span> {</span>
<span id="cb19-768"><a href="#cb19-768" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"AttendsTo"</span><span class="op">,</span></span>
<span id="cb19-769"><a href="#cb19-769" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"Word"</span><span class="op">,</span></span>
<span id="cb19-770"><a href="#cb19-770" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"Weight"</span><span class="op">,</span></span>
<span id="cb19-771"><a href="#cb19-771" aria-hidden="true" tabindex="-1"></a>        <span class="dt">inset</span><span class="op">:</span> <span class="fl">0.5</span></span>
<span id="cb19-772"><a href="#cb19-772" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb19-773"><a href="#cb19-773" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>(heatmapData<span class="op">,</span> {</span>
<span id="cb19-774"><a href="#cb19-774" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"AttendsTo"</span><span class="op">,</span></span>
<span id="cb19-775"><a href="#cb19-775" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"Word"</span><span class="op">,</span></span>
<span id="cb19-776"><a href="#cb19-776" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">Weight</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">,</span></span>
<span id="cb19-777"><a href="#cb19-777" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">Weight</span> <span class="op">&gt;</span> <span class="fl">0.3</span> <span class="op">?</span> <span class="st">"white"</span> <span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb19-778"><a href="#cb19-778" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">11</span><span class="op">,</span></span>
<span id="cb19-779"><a href="#cb19-779" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span></span>
<span id="cb19-780"><a href="#cb19-780" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb19-781"><a href="#cb19-781" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Highlight box around "her" → "scientist"</span></span>
<span id="cb19-782"><a href="#cb19-782" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">rect</span>([{<span class="dt">x</span><span class="op">:</span> <span class="st">"scientist"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"her"</span>}]<span class="op">,</span> {</span>
<span id="cb19-783"><a href="#cb19-783" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb19-784"><a href="#cb19-784" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb19-785"><a href="#cb19-785" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"none"</span><span class="op">,</span></span>
<span id="cb19-786"><a href="#cb19-786" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stroke</span><span class="op">:</span> <span class="st">"red"</span><span class="op">,</span></span>
<span id="cb19-787"><a href="#cb19-787" aria-hidden="true" tabindex="-1"></a>        <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb19-788"><a href="#cb19-788" aria-hidden="true" tabindex="-1"></a>        <span class="dt">inset</span><span class="op">:</span> <span class="op">-</span><span class="dv">2</span></span>
<span id="cb19-789"><a href="#cb19-789" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb19-790"><a href="#cb19-790" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([{ <span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="dv">0</span> }]<span class="op">,</span> {</span>
<span id="cb19-791"><a href="#cb19-791" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> () <span class="kw">=&gt;</span> words<span class="op">.</span><span class="at">length</span> <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb19-792"><a href="#cb19-792" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="op">-</span><span class="fl">0.9</span><span class="op">,</span></span>
<span id="cb19-793"><a href="#cb19-793" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="st">"Coreference via Attention: 'her' → 'scientist'"</span><span class="op">,</span></span>
<span id="cb19-794"><a href="#cb19-794" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">14</span><span class="op">,</span></span>
<span id="cb19-795"><a href="#cb19-795" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb19-796"><a href="#cb19-796" aria-hidden="true" tabindex="-1"></a>        <span class="dt">frameAnchor</span><span class="op">:</span> <span class="st">"top"</span><span class="op">,</span></span>
<span id="cb19-797"><a href="#cb19-797" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb19-798"><a href="#cb19-798" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb19-799"><a href="#cb19-799" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb19-800"><a href="#cb19-800" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb19-801"><a href="#cb19-801" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-19" data-nodetype="expression">

</div>
</div>
</div>
<p><em>Attention pattern showing ‘her’ → ‘scientist’ (0.60 weight). The model learned coreference <strong>without explicit grammar rules</strong>—purely from prediction tasks.</em></p>
<p>Row 3 corresponds to “her.” The pronoun attends most strongly to “scientist” (0.60), correctly identifying the referent. The model <strong>discovered</strong> that pronouns link to earlier nouns through statistical patterns in training data—no one programmed this grammatical rule. This is the profound insight: transformers learn the structure of language as a side effect of optimizing a simple prediction objective.</p>
</section>
<section id="the-existential-conclusion" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="the-existential-conclusion"><span class="header-section-number">5</span> The Existential Conclusion</h2>
<p>When you use <code>sentence-transformers</code> to generate embeddings for your research, you’re using encoder transformers (BERT-based) with bidirectional attention. When you interact with ChatGPT or run Gemma locally, you’re using decoder transformers with causal attention. When you see attention visualizations in papers, you now understand they represent <strong>learned relevance weights</strong> computed from Query-Key comparisons. The models don’t understand language the way humans do—they perform <strong>pattern matching at scale</strong>—but the patterns they discover are often the same syntactic and semantic structures that linguists have documented for decades.</p>
<p>The limitations are worth remembering. Attention has <strong>quadratic complexity</strong>: computing <span class="math inline">O(N^2)</span> pairwise scores becomes prohibitively expensive for very long texts, which is why context windows typically cap at 2K-32K tokens. Transformers have <strong>no true memory</strong> beyond the current window—they can’t learn facts across documents without retraining. They produce fluent text through statistical pattern matching but lack grounded understanding, leading to <strong>hallucinations</strong> when they confidently generate plausible-sounding nonsense. Training costs are astronomical: GPT-3 required roughly $5 million in compute. But you don’t need to train your own models; you can use pre-trained ones and fine-tune them for specific tasks with orders of magnitude less data and compute.</p>
<p>Return to where we started: the “bank” problem. Static embeddings treated “bank” as one point in space, averaging across all contexts. Transformers compute a <strong>distribution</strong> of representations, conditioned on the surrounding words. The revolution wasn’t in the complexity—it was in recognizing that <strong>meaning is relational, not absolute</strong>. Words are like atoms in a molecule: their properties depend on what they’re bonded to. Transformers formalized this intuition mathematically through a simple mechanism: weighted mixing based on learned relevance.</p>
<p>This entire architecture emerged from asking a single question: <em>What’s the simplest mechanism that lets representations adapt to context?</em> The answer was weighted mixing where the weights come from comparing what each word needs (Query) against what other words offer (Key). Everything else—multi-head attention, layer normalization, feed-forward networks—is engineering to make that core idea scale to 175 billion parameters and beyond.</p>
<p><strong>Next</strong>: <a href="../m03-text/word-embeddings.html">Word Embeddings: Where It Started</a></p>
<script src="https://cdn.jsdelivr.net/npm/@marimo-team/marimo-snippets@1"></script>


<!-- -->

</section>

</main> <!-- /main -->
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W3sibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6ImQzID0gcmVxdWlyZShcImQzQDdcIiwgXCJkMy1zaW1wbGUtc2xpZGVyQDFcIilcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMiIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6ImZ1bmN0aW9uIHNsaWRlcldpdGhMYWJlbChtaW4sIG1heCwgc3RlcCwgd2lkdGgsIGRlZmF1bHRWYWx1ZSwgbGFiZWwpIHtcbiAgY29uc3Qgc2xpZGVyID0gZDMuc2xpZGVyQm90dG9tKClcbiAgICAubWluKG1pbikubWF4KG1heCkuc3RlcChzdGVwKS53aWR0aCh3aWR0aCkuZGVmYXVsdChkZWZhdWx0VmFsdWUpO1xuICBjb25zdCBzdmcgPSBkMy5jcmVhdGUoXCJzdmdcIikuYXR0cihcIndpZHRoXCIsIHdpZHRoICsgNTApLmF0dHIoXCJoZWlnaHRcIiwgNjApO1xuICBzdmcuYXBwZW5kKFwiZ1wiKS5hdHRyKFwidHJhbnNmb3JtXCIsIFwidHJhbnNsYXRlKDI1LDIwKVwiKS5jYWxsKHNsaWRlcik7XG4gIHN2Zy5hcHBlbmQoXCJ0ZXh0XCIpLmF0dHIoXCJ4XCIsICh3aWR0aCArIDUwKSAvIDIpLmF0dHIoXCJ5XCIsIDEwKS5hdHRyKFwidGV4dC1hbmNob3JcIiwgXCJtaWRkbGVcIikuc3R5bGUoXCJmb250LXNpemVcIiwgXCI1cHhcIikudGV4dChsYWJlbCk7XG4gIHJldHVybiBzdmcubm9kZSgpO1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0zIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoie1xuICAvLyBDcmVhdGUgc2xpZGVyIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBib3RoIHRoZSBlbGVtZW50IGFuZCBhIHJlYWN0aXZlIHZhbHVlXG4gIGZ1bmN0aW9uIGNyZWF0ZVdlaWdodFNsaWRlcihtaW4sIG1heCwgc3RlcCwgd2lkdGgsIGRlZmF1bHRWYWx1ZSwgbGFiZWwpIHtcbiAgICBjb25zdCBzbGlkZXIgPSBkMy5zbGlkZXJCb3R0b20oKVxuICAgICAgLm1pbihtaW4pLm1heChtYXgpLnN0ZXAoc3RlcCkud2lkdGgod2lkdGgpLmRlZmF1bHQoZGVmYXVsdFZhbHVlKTtcbiAgICBjb25zdCBzdmcgPSBkMy5jcmVhdGUoXCJzdmdcIikuYXR0cihcIndpZHRoXCIsIHdpZHRoICsgNTApLmF0dHIoXCJoZWlnaHRcIiwgNjApO1xuICAgIGNvbnN0IGcgPSBzdmcuYXBwZW5kKFwiZ1wiKS5hdHRyKFwidHJhbnNmb3JtXCIsIFwidHJhbnNsYXRlKDI1LDIwKVwiKTtcbiAgICBnLmNhbGwoc2xpZGVyKTtcbiAgICBzdmcuYXBwZW5kKFwidGV4dFwiKS5hdHRyKFwieFwiLCAod2lkdGggKyA1MCkgLyAyKS5hdHRyKFwieVwiLCAxMClcbiAgICAgICAuYXR0cihcInRleHQtYW5jaG9yXCIsIFwibWlkZGxlXCIpLnN0eWxlKFwiZm9udC1zaXplXCIsIFwiMTJweFwiKS50ZXh0KGxhYmVsKTtcbiAgICByZXR1cm4geyBub2RlOiBzdmcubm9kZSgpLCBzbGlkZXI6IHNsaWRlciB9O1xuICB9XG5cbiAgLy8gQ3JlYXRlIHNsaWRlcnNcbiAgY29uc3QgYmFua1NsaWRlck9iaiA9IGNyZWF0ZVdlaWdodFNsaWRlcigwLCAxLCAwLjAxLCAxMjAsIDEuMCwgXCJCYW5rIHdlaWdodFwiKTtcbiAgY29uc3QgbW9uZXlTbGlkZXJPYmogPSBjcmVhdGVXZWlnaHRTbGlkZXIoMCwgMSwgMC4wMSwgMTIwLCAwLjAsIFwiTW9uZXkgd2VpZ2h0XCIpO1xuICBjb25zdCByaXZlclNsaWRlck9iaiA9IGNyZWF0ZVdlaWdodFNsaWRlcigwLCAxLCAwLjAxLCAxMjAsIDAuMCwgXCJSaXZlciB3ZWlnaHRcIik7XG5cbiAgLy8gV29yZCBlbWJlZGRpbmdzIGluIDJEIHNwYWNlXG4gIGNvbnN0IGNvbnRleHRXb3JkcyA9IFtcImJhbmtcIiwgXCJtb25leVwiLCBcInJpdmVyXCJdO1xuICBjb25zdCBjb250ZXh0RW1iZWRkaW5ncyA9IFtcbiAgICBbMC4wLCAwLjBdLCAgIC8vIGJhbmsgKGNlbnRlcilcbiAgICBbLTEuNiwgLTAuNl0sIC8vIG1vbmV5IChmaW5hbmNpYWwsIGxlZnQpXG4gICAgWzEuNCwgLTEuMF0gICAvLyByaXZlciAoZ2VvZ3JhcGhpY2FsLCByaWdodClcbiAgXTtcblxuICAvLyBDcmVhdGUgcGxvdCBjb250YWluZXJcbiAgY29uc3QgcGxvdENvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG5cbiAgLy8gRnVuY3Rpb24gdG8gdXBkYXRlIHZpc3VhbGl6YXRpb25cbiAgZnVuY3Rpb24gdXBkYXRlKCkge1xuICAgIC8vIEdldCBjdXJyZW50IHNsaWRlciB2YWx1ZXNcbiAgICBjb25zdCBiYW5rV2VpZ2h0ID0gYmFua1NsaWRlck9iai5zbGlkZXIudmFsdWUoKTtcbiAgICBjb25zdCBtb25leVdlaWdodCA9IG1vbmV5U2xpZGVyT2JqLnNsaWRlci52YWx1ZSgpO1xuICAgIGNvbnN0IHJpdmVyV2VpZ2h0ID0gcml2ZXJTbGlkZXJPYmouc2xpZGVyLnZhbHVlKCk7XG5cbiAgICAvLyBDYWxjdWxhdGUgd2VpZ2h0ZWQgYXZlcmFnZVxuICAgIGNvbnN0IHdlaWdodHMgPSBbYmFua1dlaWdodCwgbW9uZXlXZWlnaHQsIHJpdmVyV2VpZ2h0XTtcbiAgICBjb25zdCB0b3RhbCA9IHdlaWdodHMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7XG4gICAgY29uc3Qgbm9ybWFsaXplZFdlaWdodHMgPSB0b3RhbCA+IDAgPyB3ZWlnaHRzLm1hcCh3ID0+IHcgLyB0b3RhbCkgOiBbMCwgMCwgMF07XG5cbiAgICBjb25zdCBuZXdWZWMgPSBbXG4gICAgICBub3JtYWxpemVkV2VpZ2h0c1swXSAqIGNvbnRleHRFbWJlZGRpbmdzWzBdWzBdICtcbiAgICAgIG5vcm1hbGl6ZWRXZWlnaHRzWzFdICogY29udGV4dEVtYmVkZGluZ3NbMV1bMF0gK1xuICAgICAgbm9ybWFsaXplZFdlaWdodHNbMl0gKiBjb250ZXh0RW1iZWRkaW5nc1syXVswXSxcbiAgICAgIG5vcm1hbGl6ZWRXZWlnaHRzWzBdICogY29udGV4dEVtYmVkZGluZ3NbMF1bMV0gK1xuICAgICAgbm9ybWFsaXplZFdlaWdodHNbMV0gKiBjb250ZXh0RW1iZWRkaW5nc1sxXVsxXSArXG4gICAgICBub3JtYWxpemVkV2VpZ2h0c1syXSAqIGNvbnRleHRFbWJlZGRpbmdzWzJdWzFdXG4gICAgXTtcblxuICAgIC8vIFByZXBhcmUgZGF0YSBmb3IgdmlzdWFsaXphdGlvblxuICAgIGNvbnN0IG9yaWdpbmFsRGF0YSA9IGNvbnRleHRXb3Jkcy5tYXAoKHdvcmQsIGkpID0+ICh7XG4gICAgICB3b3JkOiB3b3JkLFxuICAgICAgeDogY29udGV4dEVtYmVkZGluZ3NbaV1bMF0sXG4gICAgICB5OiBjb250ZXh0RW1iZWRkaW5nc1tpXVsxXSxcbiAgICAgIHR5cGU6IFwiT3JpZ2luYWxcIlxuICAgIH0pKTtcblxuICAgIGNvbnN0IGNvbnRleHR1YWxpemVkRGF0YSA9IFt7XG4gICAgICB3b3JkOiBcImJhbmsgKG5ldylcIixcbiAgICAgIHg6IG5ld1ZlY1swXSxcbiAgICAgIHk6IG5ld1ZlY1sxXSxcbiAgICAgIHR5cGU6IFwiQ29udGV4dHVhbGl6ZWRcIlxuICAgIH1dO1xuXG4gICAgY29uc3QgZGF0YSA9IFsuLi5vcmlnaW5hbERhdGEsIC4uLmNvbnRleHR1YWxpemVkRGF0YV07XG5cbiAgICAvLyBDbGVhciBhbmQgdXBkYXRlIHBsb3RcbiAgICBkMy5zZWxlY3QocGxvdENvbnRhaW5lcikuc2VsZWN0QWxsKFwiKlwiKS5yZW1vdmUoKTtcblxuICAgIC8vIENyZWF0ZSB2aXN1YWxpemF0aW9uXG4gICAgY29uc3QgcGxvdCA9IFBsb3QucGxvdCh7XG4gICAgICB3aWR0aDogMzAwLFxuICAgICAgaGVpZ2h0OiAzMDAsXG4gICAgICBtYXJnaW5Ub3A6IDYwLFxuICAgICAgbWFyZ2luUmlnaHQ6IDIwLFxuICAgICAgbWFyZ2luQm90dG9tOiA1MCxcbiAgICAgIG1hcmdpbkxlZnQ6IDYwLFxuICAgICAgc3R5bGU6IHtcbiAgICAgICAgYmFja2dyb3VuZDogXCJ3aGl0ZVwiLFxuICAgICAgICBjb2xvcjogXCJibGFja1wiXG4gICAgICB9LFxuICAgICAgeDoge1xuICAgICAgICBkb21haW46IFstMiwgMl0sXG4gICAgICAgIGxhYmVsOiBcIkRpbWVuc2lvbiAxXCIsXG4gICAgICAgIGdyaWQ6IHRydWUsXG4gICAgICAgIHRpY2tzOiAxMFxuICAgICAgfSxcbiAgICAgIHk6IHtcbiAgICAgICAgZG9tYWluOiBbLTIsIDJdLFxuICAgICAgICBsYWJlbDogXCJEaW1lbnNpb24gMlwiLFxuICAgICAgICBncmlkOiB0cnVlLFxuICAgICAgICB0aWNrczogMTBcbiAgICAgIH0sXG4gICAgICBjb2xvcjoge1xuICAgICAgICBkb21haW46IFtcIk9yaWdpbmFsXCIsIFwiQ29udGV4dHVhbGl6ZWRcIl0sXG4gICAgICAgIHJhbmdlOiBbXCIjZGFkYWRhXCIsIFwiI2ZmN2YwZVwiXVxuICAgICAgfSxcbiAgICAgIG1hcmtzOiBbXG4gICAgICAgIFBsb3QuZG90KGRhdGEsIHtcbiAgICAgICAgICB4OiBcInhcIixcbiAgICAgICAgICB5OiBcInlcIixcbiAgICAgICAgICBmaWxsOiBcInR5cGVcIixcbiAgICAgICAgICByOiA4LFxuICAgICAgICAgIHRpcDogdHJ1ZVxuICAgICAgICB9KSxcbiAgICAgICAgUGxvdC50ZXh0KGRhdGEsIHtcbiAgICAgICAgICB4OiBcInhcIixcbiAgICAgICAgICB5OiBcInlcIixcbiAgICAgICAgICB0ZXh0OiBcIndvcmRcIixcbiAgICAgICAgICBkeTogLTE1LFxuICAgICAgICAgIGZvbnRTaXplOiA4LFxuICAgICAgICAgIGZvbnRXZWlnaHQ6IFwiYm9sZFwiLFxuICAgICAgICAgIGZpbGw6IFwiYmxhY2tcIlxuICAgICAgICB9KSxcbiAgICAgICAgUGxvdC50ZXh0KFt7eDogMCwgeTogMi4zfV0sIHtcbiAgICAgICAgICB4OiBcInhcIixcbiAgICAgICAgICB5OiBcInlcIixcbiAgICAgICAgICB0ZXh0OiAoKSA9PiBgV2VpZ2h0czogQmFuaz0ke25vcm1hbGl6ZWRXZWlnaHRzWzBdLnRvRml4ZWQoMil9LCBNb25leT0ke25vcm1hbGl6ZWRXZWlnaHRzWzFdLnRvRml4ZWQoMil9LCBSaXZlcj0ke25vcm1hbGl6ZWRXZWlnaHRzWzJdLnRvRml4ZWQoMil9YCxcbiAgICAgICAgICBmb250U2l6ZTogMTEsXG4gICAgICAgICAgZmlsbDogXCJibGFja1wiXG4gICAgICAgIH0pLFxuICAgICAgICAvLyBDdXN0b20gbGVnZW5kIGF0IHRvcCBjZW50ZXJcbiAgICAgICAgUGxvdC5kb3QoW3t4OiAtMC44LCB5OiAyLjcsIGNvbG9yOiBcIiNkYWRhZGFcIn0sIHt4OiAwLjgsIHk6IDIuNywgY29sb3I6IFwiI2ZmN2YwZVwifV0sIHtcbiAgICAgICAgICB4OiBcInhcIixcbiAgICAgICAgICB5OiBcInlcIixcbiAgICAgICAgICBmaWxsOiBcImNvbG9yXCIsXG4gICAgICAgICAgcjogNlxuICAgICAgICB9KSxcbiAgICAgICAgUGxvdC50ZXh0KFt7eDogLTAuNSwgeTogMi43LCBsYWJlbDogXCJPcmlnaW5hbFwifSwge3g6IDEuMSwgeTogMi43LCBsYWJlbDogXCJDb250ZXh0dWFsaXplZFwifV0sIHtcbiAgICAgICAgICB4OiBcInhcIixcbiAgICAgICAgICB5OiBcInlcIixcbiAgICAgICAgICB0ZXh0OiBcImxhYmVsXCIsXG4gICAgICAgICAgZm9udFNpemU6IDEwLFxuICAgICAgICAgIGZpbGw6IFwiYmxhY2tcIixcbiAgICAgICAgICB0ZXh0QW5jaG9yOiBcInN0YXJ0XCJcbiAgICAgICAgfSlcbiAgICAgIF1cbiAgICB9KTtcblxuICAgIGQzLnNlbGVjdChwbG90Q29udGFpbmVyKS5ub2RlKCkuYXBwZW5kQ2hpbGQocGxvdCk7XG4gIH1cblxuICAvLyBBZGQgZXZlbnQgbGlzdGVuZXJzIHRvIHNsaWRlcnNcbiAgYmFua1NsaWRlck9iai5zbGlkZXIub24oXCJvbmNoYW5nZVwiLCB1cGRhdGUpO1xuICBtb25leVNsaWRlck9iai5zbGlkZXIub24oXCJvbmNoYW5nZVwiLCB1cGRhdGUpO1xuICByaXZlclNsaWRlck9iai5zbGlkZXIub24oXCJvbmNoYW5nZVwiLCB1cGRhdGUpO1xuXG4gIC8vIEluaXRpYWwgcmVuZGVyXG4gIHVwZGF0ZSgpO1xuXG4gIHJldHVybiBodG1sYDxkaXYgc3R5bGU9XCJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBnYXA6IDQwcHg7IGp1c3RpZnktY29udGVudDogY2VudGVyO1wiPlxuICAgIDxkaXYgc3R5bGU9XCJkaXNwbGF5OiBmbGV4OyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOyBnYXA6IDEwcHg7XCI+XG4gICAgICAke2JhbmtTbGlkZXJPYmoubm9kZX1cbiAgICAgICR7bW9uZXlTbGlkZXJPYmoubm9kZX1cbiAgICAgICR7cml2ZXJTbGlkZXJPYmoubm9kZX1cbiAgICA8L2Rpdj5cbiAgICA8ZGl2PlxuICAgICAgJHtwbG90Q29udGFpbmVyfVxuICAgIDwvZGl2PlxuICA8L2Rpdj5gO1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC00IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiZnVuY3Rpb24gY3JlYXRlUUtWU2xpZGVyKG1pbiwgbWF4LCBzdGVwLCB3aWR0aCwgZGVmYXVsdFZhbHVlLCBsYWJlbCwgdmFsdWVTZXR0ZXIpIHtcbiAgY29uc3Qgc2xpZGVyID0gZDMuc2xpZGVyQm90dG9tKClcbiAgICAubWluKG1pbikubWF4KG1heCkuc3RlcChzdGVwKS53aWR0aCh3aWR0aCkuZGVmYXVsdChkZWZhdWx0VmFsdWUpXG4gICAgLm9uKCdvbmNoYW5nZScsIHZhbCA9PiB2YWx1ZVNldHRlcih2YWwpKTtcbiAgY29uc3Qgc3ZnID0gZDMuY3JlYXRlKFwic3ZnXCIpLmF0dHIoXCJ3aWR0aFwiLCB3aWR0aCArIDQwKS5hdHRyKFwiaGVpZ2h0XCIsIDUwKTtcbiAgY29uc3QgZyA9IHN2Zy5hcHBlbmQoXCJnXCIpLmF0dHIoXCJ0cmFuc2Zvcm1cIiwgXCJ0cmFuc2xhdGUoMjAsMTUpXCIpO1xuICBnLmNhbGwoc2xpZGVyKTtcbiAgc3ZnLmFwcGVuZChcInRleHRcIikuYXR0cihcInhcIiwgKHdpZHRoICsgNDApIC8gMikuYXR0cihcInlcIiwgMTApXG4gICAgIC5hdHRyKFwidGV4dC1hbmNob3JcIiwgXCJtaWRkbGVcIikuc3R5bGUoXCJmb250LXNpemVcIiwgXCIxMXB4XCIpLnRleHQobGFiZWwpO1xuICByZXR1cm4geyBub2RlOiBzdmcubm9kZSgpLCBzbGlkZXI6IHNsaWRlciB9O1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC01IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoibXV0YWJsZSBxU2NhbGVYVmFsdWUgPSAxLjBcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNiIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Im11dGFibGUgcVNjYWxlWVZhbHVlID0gMS4wXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTciLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJtdXRhYmxlIHFSb3RhdGVWYWx1ZSA9IDBcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtOCIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Im11dGFibGUga1NjYWxlWFZhbHVlID0gMS4wXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTkiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJtdXRhYmxlIGtTY2FsZVlWYWx1ZSA9IDEuMFxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xMCIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Im11dGFibGUga1JvdGF0ZVZhbHVlID0gMFxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xMSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6InFTY2FsZVhTbGlkZXIgPSBjcmVhdGVRS1ZTbGlkZXIoMC4xLCAyLCAwLjEsIDE1MCwgMS4wLCBcIlEgU2NhbGUgWFwiLCB2YWwgPT4gbXV0YWJsZSBxU2NhbGVYVmFsdWUgPSB2YWwpXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTEyIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoicVNjYWxlWVNsaWRlciA9IGNyZWF0ZVFLVlNsaWRlcigwLjEsIDIsIDAuMSwgMTUwLCAxLjAsIFwiUSBTY2FsZSBZXCIsIHZhbCA9PiBtdXRhYmxlIHFTY2FsZVlWYWx1ZSA9IHZhbClcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTMiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJxUm90YXRlU2xpZGVyID0gY3JlYXRlUUtWU2xpZGVyKC0xODAsIDE4MCwgNSwgMTUwLCAwLCBcIlEgUm90YXRlIChkZWcpXCIsIHZhbCA9PiBtdXRhYmxlIHFSb3RhdGVWYWx1ZSA9IHZhbClcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTQiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJrU2NhbGVYU2xpZGVyID0gY3JlYXRlUUtWU2xpZGVyKDAuMSwgMiwgMC4xLCAxNTAsIDEuMCwgXCJLIFNjYWxlIFhcIiwgdmFsID0+IG11dGFibGUga1NjYWxlWFZhbHVlID0gdmFsKVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xNSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6ImtTY2FsZVlTbGlkZXIgPSBjcmVhdGVRS1ZTbGlkZXIoMC4xLCAyLCAwLjEsIDE1MCwgMS4wLCBcIksgU2NhbGUgWVwiLCB2YWwgPT4gbXV0YWJsZSBrU2NhbGVZVmFsdWUgPSB2YWwpXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTE2IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoia1JvdGF0ZVNsaWRlciA9IGNyZWF0ZVFLVlNsaWRlcigtMTgwLCAxODAsIDUsIDE1MCwgMCwgXCJLIFJvdGF0ZSAoZGVnKVwiLCB2YWwgPT4gbXV0YWJsZSBrUm90YXRlVmFsdWUgPSB2YWwpXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTE3IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoicWt2VmlzdWFsaXphdGlvbiA9IHtcbiAgLy8gT3JpZ2luYWwgd29yZCB2ZWN0b3JzIChiYW5rLCBtb25leSwgcml2ZXIpXG4gIGNvbnN0IG9yaWdpbmFsVmVjdG9ycyA9IFtcbiAgICB7IG5hbWU6IFwiYmFua1wiLCB2ZWN0b3I6IFsxLjUsIDAuNV0gfSxcbiAgICB7IG5hbWU6IFwibW9uZXlcIiwgdmVjdG9yOiBbMS44LCAwLjhdIH0sXG4gICAgeyBuYW1lOiBcInJpdmVyXCIsIHZlY3RvcjogWzAuNSwgMS41XSB9XG4gIF07XG5cbiAgLy8gQ3JlYXRlIHBsb3QgY29udGFpbmVyc1xuICBjb25zdCBxUGxvdENvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gIGNvbnN0IGtQbG90Q29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcblxuICAvLyBGdW5jdGlvbiB0byB0cmFuc2Zvcm0gdmVjdG9yXG4gIGZ1bmN0aW9uIHRyYW5zZm9ybVZlY3Rvcih2ZWMsIHNjYWxlWCwgc2NhbGVZLCByb3RhdGVEZWcpIHtcbiAgICBjb25zdCB0aGV0YSA9IChyb3RhdGVEZWcgKiBNYXRoLlBJKSAvIDE4MDtcbiAgICBjb25zdCBjb3MgPSBNYXRoLmNvcyh0aGV0YSk7XG4gICAgY29uc3Qgc2luID0gTWF0aC5zaW4odGhldGEpO1xuICAgIGNvbnN0IHNjYWxlZFggPSB2ZWNbMF0gKiBzY2FsZVg7XG4gICAgY29uc3Qgc2NhbGVkWSA9IHZlY1sxXSAqIHNjYWxlWTtcbiAgICByZXR1cm4gW1xuICAgICAgc2NhbGVkWCAqIGNvcyAtIHNjYWxlZFkgKiBzaW4sXG4gICAgICBzY2FsZWRYICogc2luICsgc2NhbGVkWSAqIGNvc1xuICAgIF07XG4gIH1cblxuICAvLyBHZXQgY3VycmVudCBzbGlkZXIgdmFsdWVzIGZyb20gbXV0YWJsZSB2YXJpYWJsZXMgKGNyZWF0ZXMgcmVhY3RpdmUgZGVwZW5kZW5jeSlcbiAgY29uc3QgcVNjYWxlWCA9IHFTY2FsZVhWYWx1ZTtcbiAgY29uc3QgcVNjYWxlWSA9IHFTY2FsZVlWYWx1ZTtcbiAgY29uc3QgcVJvdGF0ZSA9IHFSb3RhdGVWYWx1ZTtcbiAgY29uc3Qga1NjYWxlWCA9IGtTY2FsZVhWYWx1ZTtcbiAgY29uc3Qga1NjYWxlWSA9IGtTY2FsZVlWYWx1ZTtcbiAgY29uc3Qga1JvdGF0ZSA9IGtSb3RhdGVWYWx1ZTtcblxuICAvLyBQcmVwYXJlIGRhdGEgZm9yIGVhY2ggcGxvdFxuICBjb25zdCBvcmlnaW5hbERhdGEgPSBvcmlnaW5hbFZlY3RvcnMubWFwKGl0ZW0gPT4gKHtcbiAgICBuYW1lOiBpdGVtLm5hbWUsXG4gICAgeDogaXRlbS52ZWN0b3JbMF0sXG4gICAgeTogaXRlbS52ZWN0b3JbMV0sXG4gICAgdHlwZTogXCJPcmlnaW5hbFwiXG4gIH0pKTtcblxuICBjb25zdCBxRGF0YSA9IG9yaWdpbmFsVmVjdG9ycy5tYXAoaXRlbSA9PiB7XG4gICAgY29uc3QgcVZlYyA9IHRyYW5zZm9ybVZlY3RvcihpdGVtLnZlY3RvciwgcVNjYWxlWCwgcVNjYWxlWSwgcVJvdGF0ZSk7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWU6IGBxXyR7aXRlbS5uYW1lfWAsXG4gICAgICB4OiBxVmVjWzBdLFxuICAgICAgeTogcVZlY1sxXSxcbiAgICAgIHR5cGU6IFwiUXVlcnlcIlxuICAgIH07XG4gIH0pO1xuXG4gIGNvbnN0IGtEYXRhID0gb3JpZ2luYWxWZWN0b3JzLm1hcChpdGVtID0+IHtcbiAgICBjb25zdCBrVmVjID0gdHJhbnNmb3JtVmVjdG9yKGl0ZW0udmVjdG9yLCBrU2NhbGVYLCBrU2NhbGVZLCBrUm90YXRlKTtcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogYGtfJHtpdGVtLm5hbWV9YCxcbiAgICAgIHg6IGtWZWNbMF0sXG4gICAgICB5OiBrVmVjWzFdLFxuICAgICAgdHlwZTogXCJLZXlcIlxuICAgIH07XG4gIH0pO1xuXG4gIC8vIENyZWF0ZSBRdWVyeSBwbG90XG4gIGNvbnN0IHFQbG90ID0gUGxvdC5wbG90KHtcbiAgICB3aWR0aDogMjUwLFxuICAgIGhlaWdodDogMjUwLFxuICAgIG1hcmdpblRvcDogNDAsXG4gICAgbWFyZ2luUmlnaHQ6IDIwLFxuICAgIG1hcmdpbkJvdHRvbTogNTAsXG4gICAgbWFyZ2luTGVmdDogNjAsXG4gICAgc3R5bGU6IHtcbiAgICAgIGJhY2tncm91bmQ6IFwid2hpdGVcIixcbiAgICAgIGNvbG9yOiBcImJsYWNrXCJcbiAgICB9LFxuICAgIHg6IHtcbiAgICAgIGRvbWFpbjogWy0zLCAzXSxcbiAgICAgIGxhYmVsOiBcIkRpbWVuc2lvbiAxXCIsXG4gICAgICBncmlkOiB0cnVlLFxuICAgICAgdGlja3M6IDEwXG4gICAgfSxcbiAgICB5OiB7XG4gICAgICBkb21haW46IFstMywgM10sXG4gICAgICBsYWJlbDogXCJEaW1lbnNpb24gMlwiLFxuICAgICAgZ3JpZDogdHJ1ZSxcbiAgICAgIHRpY2tzOiAxMFxuICAgIH0sXG4gICAgbWFya3M6IFtcbiAgICAgIFBsb3QuZG90KFt7eDogMCwgeTogMH1dLCB7XG4gICAgICAgIHg6IFwieFwiLFxuICAgICAgICB5OiBcInlcIixcbiAgICAgICAgcjogMyxcbiAgICAgICAgZmlsbDogXCJibGFja1wiXG4gICAgICB9KSxcbiAgICAgIFBsb3QuYXJyb3coWy4uLm9yaWdpbmFsRGF0YSwgLi4ucURhdGFdLCB7XG4gICAgICAgIHgxOiAwLFxuICAgICAgICB5MTogMCxcbiAgICAgICAgeDI6IFwieFwiLFxuICAgICAgICB5MjogXCJ5XCIsXG4gICAgICAgIHN0cm9rZTogXCJ0eXBlXCIsXG4gICAgICAgIHN0cm9rZVdpZHRoOiAyLFxuICAgICAgICBoZWFkTGVuZ3RoOiA4XG4gICAgICB9KSxcbiAgICAgIFBsb3QuZG90KFsuLi5vcmlnaW5hbERhdGEsIC4uLnFEYXRhXSwge1xuICAgICAgICB4OiBcInhcIixcbiAgICAgICAgeTogXCJ5XCIsXG4gICAgICAgIGZpbGw6IFwidHlwZVwiLFxuICAgICAgICByOiA1LFxuICAgICAgICB0aXA6IHRydWVcbiAgICAgIH0pLFxuICAgICAgUGxvdC50ZXh0KFsuLi5vcmlnaW5hbERhdGEsIC4uLnFEYXRhXSwge1xuICAgICAgICB4OiBcInhcIixcbiAgICAgICAgeTogXCJ5XCIsXG4gICAgICAgIHRleHQ6IFwibmFtZVwiLFxuICAgICAgICBkeTogLTEyLFxuICAgICAgICBmb250U2l6ZTogOSxcbiAgICAgICAgZm9udFdlaWdodDogXCJib2xkXCIsXG4gICAgICAgIGZpbGw6IFwiYmxhY2tcIlxuICAgICAgfSksXG4gICAgICBQbG90LnRleHQoW3sgeDogMCwgeTogMy40IH1dLCB7XG4gICAgICAgIHg6IFwieFwiLFxuICAgICAgICB5OiBcInlcIixcbiAgICAgICAgdGV4dDogKCkgPT4gXCJRdWVyeSBTcGFjZVwiLFxuICAgICAgICBmb250U2l6ZTogMTIsXG4gICAgICAgIGZvbnRXZWlnaHQ6IFwiYm9sZFwiLFxuICAgICAgICBmaWxsOiBcImJsYWNrXCJcbiAgICAgIH0pXG4gICAgXSxcbiAgICBjb2xvcjoge1xuICAgICAgZG9tYWluOiBbXCJPcmlnaW5hbFwiLCBcIlF1ZXJ5XCJdLFxuICAgICAgcmFuZ2U6IFtcIiM2NjY2NjZcIiwgXCIjNDY4MmI0XCJdXG4gICAgfVxuICB9KTtcblxuICAvLyBDcmVhdGUgS2V5IHBsb3RcbiAgY29uc3Qga1Bsb3QgPSBQbG90LnBsb3Qoe1xuICAgIHdpZHRoOiAyNTAsXG4gICAgaGVpZ2h0OiAyNTAsXG4gICAgbWFyZ2luVG9wOiA0MCxcbiAgICBtYXJnaW5SaWdodDogMjAsXG4gICAgbWFyZ2luQm90dG9tOiA1MCxcbiAgICBtYXJnaW5MZWZ0OiA2MCxcbiAgICBzdHlsZToge1xuICAgICAgYmFja2dyb3VuZDogXCJ3aGl0ZVwiLFxuICAgICAgY29sb3I6IFwiYmxhY2tcIlxuICAgIH0sXG4gICAgeDoge1xuICAgICAgZG9tYWluOiBbLTMsIDNdLFxuICAgICAgbGFiZWw6IFwiRGltZW5zaW9uIDFcIixcbiAgICAgIGdyaWQ6IHRydWUsXG4gICAgICB0aWNrczogMTBcbiAgICB9LFxuICAgIHk6IHtcbiAgICAgIGRvbWFpbjogWy0zLCAzXSxcbiAgICAgIGxhYmVsOiBcIkRpbWVuc2lvbiAyXCIsXG4gICAgICBncmlkOiB0cnVlLFxuICAgICAgdGlja3M6IDEwXG4gICAgfSxcbiAgICBtYXJrczogW1xuICAgICAgUGxvdC5kb3QoW3t4OiAwLCB5OiAwfV0sIHtcbiAgICAgICAgeDogXCJ4XCIsXG4gICAgICAgIHk6IFwieVwiLFxuICAgICAgICByOiAzLFxuICAgICAgICBmaWxsOiBcImJsYWNrXCJcbiAgICAgIH0pLFxuICAgICAgUGxvdC5hcnJvdyhbLi4ub3JpZ2luYWxEYXRhLCAuLi5rRGF0YV0sIHtcbiAgICAgICAgeDE6IDAsXG4gICAgICAgIHkxOiAwLFxuICAgICAgICB4MjogXCJ4XCIsXG4gICAgICAgIHkyOiBcInlcIixcbiAgICAgICAgc3Ryb2tlOiBcInR5cGVcIixcbiAgICAgICAgc3Ryb2tlV2lkdGg6IDIsXG4gICAgICAgIGhlYWRMZW5ndGg6IDhcbiAgICAgIH0pLFxuICAgICAgUGxvdC5kb3QoWy4uLm9yaWdpbmFsRGF0YSwgLi4ua0RhdGFdLCB7XG4gICAgICAgIHg6IFwieFwiLFxuICAgICAgICB5OiBcInlcIixcbiAgICAgICAgZmlsbDogXCJ0eXBlXCIsXG4gICAgICAgIHI6IDUsXG4gICAgICAgIHRpcDogdHJ1ZVxuICAgICAgfSksXG4gICAgICBQbG90LnRleHQoWy4uLm9yaWdpbmFsRGF0YSwgLi4ua0RhdGFdLCB7XG4gICAgICAgIHg6IFwieFwiLFxuICAgICAgICB5OiBcInlcIixcbiAgICAgICAgdGV4dDogXCJuYW1lXCIsXG4gICAgICAgIGR5OiAtMTIsXG4gICAgICAgIGZvbnRTaXplOiA5LFxuICAgICAgICBmb250V2VpZ2h0OiBcImJvbGRcIixcbiAgICAgICAgZmlsbDogXCJibGFja1wiXG4gICAgICB9KSxcbiAgICAgIFBsb3QudGV4dChbeyB4OiAwLCB5OiAzLjQgfV0sIHtcbiAgICAgICAgeDogXCJ4XCIsXG4gICAgICAgIHk6IFwieVwiLFxuICAgICAgICB0ZXh0OiAoKSA9PiBcIktleSBTcGFjZVwiLFxuICAgICAgICBmb250U2l6ZTogMTIsXG4gICAgICAgIGZvbnRXZWlnaHQ6IFwiYm9sZFwiLFxuICAgICAgICBmaWxsOiBcImJsYWNrXCJcbiAgICAgIH0pXG4gICAgXSxcbiAgICBjb2xvcjoge1xuICAgICAgZG9tYWluOiBbXCJPcmlnaW5hbFwiLCBcIktleVwiXSxcbiAgICAgIHJhbmdlOiBbXCIjNjY2NjY2XCIsIFwiIzJlOGI1N1wiXVxuICAgIH1cbiAgfSk7XG5cbiAgZDMuc2VsZWN0KHFQbG90Q29udGFpbmVyKS5ub2RlKCkuYXBwZW5kQ2hpbGQocVBsb3QpO1xuICBkMy5zZWxlY3Qoa1Bsb3RDb250YWluZXIpLm5vZGUoKS5hcHBlbmRDaGlsZChrUGxvdCk7XG5cbiAgcmV0dXJuIGh0bWxgPGRpdiBzdHlsZT1cImRpc3BsYXk6IGZsZXg7IGp1c3RpZnktY29udGVudDogY2VudGVyOyBnYXA6IDQwcHg7XCI+XG4gICAgPGRpdiBzdHlsZT1cImRpc3BsYXk6IGZsZXg7IGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47IGdhcDogMjBweDtcIj5cbiAgICAgIDxkaXYgc3R5bGU9XCJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBnYXA6IDIwcHg7XCI+XG4gICAgICAgIDxkaXYgc3R5bGU9XCJkaXNwbGF5OiBmbGV4OyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOyBnYXA6IDhweDtcIj5cbiAgICAgICAgICA8ZGl2IHN0eWxlPVwiZm9udC13ZWlnaHQ6IGJvbGQ7IG1hcmdpbi1ib3R0b206IDNweDtcIj5RdWVyeSAoV19RKTwvZGl2PlxuICAgICAgICAgICR7cVNjYWxlWFNsaWRlci5ub2RlfVxuICAgICAgICAgICR7cVNjYWxlWVNsaWRlci5ub2RlfVxuICAgICAgICAgICR7cVJvdGF0ZVNsaWRlci5ub2RlfVxuICAgICAgICA8L2Rpdj5cbiAgICAgICAgJHtxUGxvdENvbnRhaW5lcn1cbiAgICAgIDwvZGl2PlxuICAgICAgPGRpdiBzdHlsZT1cImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGdhcDogMjBweDtcIj5cbiAgICAgICAgPGRpdiBzdHlsZT1cImRpc3BsYXk6IGZsZXg7IGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47IGdhcDogOHB4O1wiPlxuICAgICAgICAgIDxkaXYgc3R5bGU9XCJmb250LXdlaWdodDogYm9sZDsgbWFyZ2luLWJvdHRvbTogM3B4O1wiPktleSAoV19LKTwvZGl2PlxuICAgICAgICAgICR7a1NjYWxlWFNsaWRlci5ub2RlfVxuICAgICAgICAgICR7a1NjYWxlWVNsaWRlci5ub2RlfVxuICAgICAgICAgICR7a1JvdGF0ZVNsaWRlci5ub2RlfVxuICAgICAgICA8L2Rpdj5cbiAgICAgICAgJHtrUGxvdENvbnRhaW5lcn1cbiAgICAgIDwvZGl2PlxuICAgIDwvZGl2PlxuICA8L2Rpdj5gO1xufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xOCIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6ImF0dGVudGlvbkhlYXRtYXAgPSB7XG4gIC8vIEdldCB0aGUgb3JpZ2luYWwgd29yZCB2ZWN0b3JzIGZyb20gdGhlIHByZXZpb3VzIHZpc3VhbGl6YXRpb25cbiAgY29uc3QgYXR0ZW50aW9uV29yZHMgPSBbXCJiYW5rXCIsIFwibW9uZXlcIiwgXCJyaXZlclwiXTtcbiAgY29uc3QgYXR0ZW50aW9uRW1iZWRkaW5ncyA9IFtcbiAgICBbMS41LCAwLjVdLFxuICAgIFsxLjgsIDAuOF0sXG4gICAgWzAuNSwgMS41XVxuICBdO1xuXG4gIC8vIFRyYW5zZm9ybSB2ZWN0b3IgZnVuY3Rpb25cbiAgZnVuY3Rpb24gdHJhbnNmb3JtVmVjdG9yKHZlYywgc2NhbGVYLCBzY2FsZVksIHJvdGF0ZURlZykge1xuICAgIGNvbnN0IHRoZXRhID0gKHJvdGF0ZURlZyAqIE1hdGguUEkpIC8gMTgwO1xuICAgIGNvbnN0IGNvcyA9IE1hdGguY29zKHRoZXRhKTtcbiAgICBjb25zdCBzaW4gPSBNYXRoLnNpbih0aGV0YSk7XG4gICAgY29uc3Qgc2NhbGVkWCA9IHZlY1swXSAqIHNjYWxlWDtcbiAgICBjb25zdCBzY2FsZWRZID0gdmVjWzFdICogc2NhbGVZO1xuICAgIHJldHVybiBbXG4gICAgICBzY2FsZWRYICogY29zIC0gc2NhbGVkWSAqIHNpbixcbiAgICAgIHNjYWxlZFggKiBzaW4gKyBzY2FsZWRZICogY29zXG4gICAgXTtcbiAgfVxuXG4gIC8vIEdldCBjdXJyZW50IHNsaWRlciB2YWx1ZXMgZnJvbSBtdXRhYmxlIHZhcmlhYmxlcyAoY3JlYXRlcyByZWFjdGl2ZSBkZXBlbmRlbmN5KVxuICBjb25zdCBxU2NhbGVYID0gcVNjYWxlWFZhbHVlO1xuICBjb25zdCBxU2NhbGVZID0gcVNjYWxlWVZhbHVlO1xuICBjb25zdCBxUm90YXRlID0gcVJvdGF0ZVZhbHVlO1xuICBjb25zdCBrU2NhbGVYID0ga1NjYWxlWFZhbHVlO1xuICBjb25zdCBrU2NhbGVZID0ga1NjYWxlWVZhbHVlO1xuICBjb25zdCBrUm90YXRlID0ga1JvdGF0ZVZhbHVlO1xuXG4gIC8vIEFwcGx5IHRyYW5zZm9ybWF0aW9uc1xuICBjb25zdCBRID0gYXR0ZW50aW9uRW1iZWRkaW5ncy5tYXAodmVjID0+XG4gICAgdHJhbnNmb3JtVmVjdG9yKHZlYywgcVNjYWxlWCwgcVNjYWxlWSwgcVJvdGF0ZSlcbiAgKTtcbiAgY29uc3QgSyA9IGF0dGVudGlvbkVtYmVkZGluZ3MubWFwKHZlYyA9PlxuICAgIHRyYW5zZm9ybVZlY3Rvcih2ZWMsIGtTY2FsZVgsIGtTY2FsZVksIGtSb3RhdGUpXG4gICk7XG5cbiAgLy8gQ29tcHV0ZSBhdHRlbnRpb24gc2NvcmVzIChRIEAgS15UKVxuICBjb25zdCBzY29yZXMgPSBRLm1hcChxID0+IEsubWFwKGsgPT4gcVswXSAqIGtbMF0gKyBxWzFdICoga1sxXSkpO1xuXG4gIC8vIEFwcGx5IHNvZnRtYXggdG8gZWFjaCByb3dcbiAgY29uc3QgYXR0ZW50aW9uV2VpZ2h0cyA9IHNjb3Jlcy5tYXAocm93ID0+IHtcbiAgICBjb25zdCBtYXhTY29yZSA9IE1hdGgubWF4KC4uLnJvdyk7XG4gICAgY29uc3QgZXhwU2NvcmVzID0gcm93Lm1hcChzID0+IE1hdGguZXhwKHMgLSBtYXhTY29yZSkpO1xuICAgIGNvbnN0IHN1bUV4cCA9IGV4cFNjb3Jlcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTtcbiAgICByZXR1cm4gZXhwU2NvcmVzLm1hcChlID0+IGUgLyBzdW1FeHApO1xuICB9KTtcblxuICAvLyBQcmVwYXJlIGRhdGEgZm9yIGhlYXRtYXBcbiAgY29uc3QgaGVhdG1hcERhdGEgPSAoKCkgPT4ge1xuICAgIGNvbnN0IGRhdGEgPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGF0dGVudGlvbldvcmRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGF0dGVudGlvbldvcmRzLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIGRhdGEucHVzaCh7XG4gICAgICAgICAgUXVlcnk6IGF0dGVudGlvbldvcmRzW2ldLFxuICAgICAgICAgIEtleTogYXR0ZW50aW9uV29yZHNbal0sXG4gICAgICAgICAgV2VpZ2h0OiBhdHRlbnRpb25XZWlnaHRzW2ldW2pdXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZGF0YTtcbiAgfSkoKTtcblxuICAvLyBDcmVhdGUgYXR0ZW50aW9uIGhlYXRtYXBcbiAgcmV0dXJuIFBsb3QucGxvdCh7XG4gICAgd2lkdGg6IDMyMCxcbiAgICBoZWlnaHQ6IDMyMCxcbiAgICBtYXJnaW5Ub3A6IDUwLFxuICAgIG1hcmdpbkJvdHRvbTogNTAsXG4gICAgbWFyZ2luTGVmdDogNzAsXG4gICAgbWFyZ2luUmlnaHQ6IDgwLFxuICAgIHN0eWxlOiB7XG4gICAgICBiYWNrZ3JvdW5kOiBcIndoaXRlXCIsXG4gICAgICBjb2xvcjogXCJibGFja1wiXG4gICAgfSxcbiAgICB4OiB7IGxhYmVsOiBcIktleSBXb3JkXCIgfSxcbiAgICB5OiB7IGxhYmVsOiBcIlF1ZXJ5IFdvcmRcIiB9LFxuICAgIGNvbG9yOiB7XG4gICAgICBzY2hlbWU6IFwiQmx1ZXNcIixcbiAgICAgIGxhYmVsOiBcIkF0dGVudGlvblwiLFxuICAgICAgbGVnZW5kOiB0cnVlXG4gICAgfSxcbiAgICBtYXJrczogW1xuICAgICAgUGxvdC5jZWxsKGhlYXRtYXBEYXRhLCB7XG4gICAgICAgIHg6IFwiS2V5XCIsXG4gICAgICAgIHk6IFwiUXVlcnlcIixcbiAgICAgICAgZmlsbDogXCJXZWlnaHRcIixcbiAgICAgICAgdGlwOiB0cnVlXG4gICAgICB9KSxcbiAgICAgIFBsb3QudGV4dChoZWF0bWFwRGF0YSwge1xuICAgICAgICB4OiBcIktleVwiLFxuICAgICAgICB5OiBcIlF1ZXJ5XCIsXG4gICAgICAgIHRleHQ6IGQgPT4gZC5XZWlnaHQudG9GaXhlZCgyKSxcbiAgICAgICAgZmlsbDogZCA9PiBkLldlaWdodCA+IDAuMzUgPyBcIndoaXRlXCIgOiBcImJsYWNrXCIsXG4gICAgICAgIGZvbnRTaXplOiAxMVxuICAgICAgfSksXG4gICAgICBQbG90LnRleHQoW3sgeDogMCwgeTogMCB9XSwge1xuICAgICAgICB4OiAoKSA9PiBhdHRlbnRpb25Xb3Jkcy5sZW5ndGggLyAyIC0gMC41LFxuICAgICAgICB5OiAoKSA9PiAtMC44LFxuICAgICAgICB0ZXh0OiAoKSA9PiBcIkF0dGVudGlvbiBXZWlnaHRzIChTb2Z0bWF4KVwiLFxuICAgICAgICBmb250U2l6ZTogMTIsXG4gICAgICAgIGZvbnRXZWlnaHQ6IFwiYm9sZFwiLFxuICAgICAgICBmcmFtZUFuY2hvcjogXCJ0b3BcIixcbiAgICAgICAgZmlsbDogXCJibGFja1wiXG4gICAgICB9KVxuICAgIF1cbiAgfSk7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTE5IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG57XG4gIGNvbnN0IHdvcmRzID0gW1wiVGhlXCIsIFwic2NpZW50aXN0XCIsIFwicHVibGlzaGVkXCIsIFwiaGVyXCIsIFwicGFwZXJcIl07XG4gIGNvbnN0IGF0dGVudGlvbiA9IFtcbiAgICBbMC41LCAwLjMsIDAuMSwgMC4wNSwgMC4wNV0sICAgLy8gXCJUaGVcIuKGklwic2NpZW50aXN0XCJcbiAgICBbMC4yLCAwLjUsIDAuMiwgMC4wNSwgMC4wNV0sICAgLy8gXCJzY2llbnRpc3RcIlxuICAgIFswLjA1LCAwLjMsIDAuNCwgMC4xLCAwLjE1XSwgICAvLyBcInB1Ymxpc2hlZFwiXG4gICAgWzAuMDUsIDAuNiwgMC4xLCAwLjIsIDAuMDVdLCAgIC8vIFwiaGVyXCLihpJcInNjaWVudGlzdFwiIOKGkCBLRVkhXG4gICAgWzAuMDUsIDAuMiwgMC4xLCAwLjE1LCAwLjVdICAgIC8vIFwicGFwZXJcIlxuICBdO1xuXG4gIC8vIFByZXBhcmUgaGVhdG1hcCBkYXRhXG4gIGNvbnN0IGhlYXRtYXBEYXRhID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgd29yZHMubGVuZ3RoOyBpKyspIHtcbiAgICBmb3IgKGxldCBqID0gMDsgaiA8IHdvcmRzLmxlbmd0aDsgaisrKSB7XG4gICAgICBoZWF0bWFwRGF0YS5wdXNoKHtcbiAgICAgICAgV29yZDogd29yZHNbaV0sXG4gICAgICAgIEF0dGVuZHNUbzogd29yZHNbal0sXG4gICAgICAgIFdlaWdodDogYXR0ZW50aW9uW2ldW2pdLFxuICAgICAgICBpc0hpZ2hsaWdodDogaSA9PT0gMyAmJiBqID09PSAxICAvLyBcImhlclwiIOKGkiBcInNjaWVudGlzdFwiXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gUGxvdC5wbG90KHtcbiAgICB3aWR0aDogNTAwLFxuICAgIGhlaWdodDogNDAwLFxuICAgIG1hcmdpblRvcDogNjAsXG4gICAgbWFyZ2luQm90dG9tOiA2MCxcbiAgICBtYXJnaW5MZWZ0OiA5MCxcbiAgICBtYXJnaW5SaWdodDogMTIwLFxuICAgIHN0eWxlOiB7XG4gICAgICBiYWNrZ3JvdW5kOiBcIndoaXRlXCIsXG4gICAgICBjb2xvcjogXCJibGFja1wiXG4gICAgfSxcbiAgICB4OiB7XG4gICAgICBsYWJlbDogXCJBdHRlbmRzIFRvIOKGklwiLFxuICAgICAgbGFiZWxBbmNob3I6IFwiY2VudGVyXCJcbiAgICB9LFxuICAgIHk6IHtcbiAgICAgIGxhYmVsOiBcIuKGkSBXb3JkXCIsXG4gICAgICBsYWJlbEFuY2hvcjogXCJjZW50ZXJcIlxuICAgIH0sXG4gICAgY29sb3I6IHtcbiAgICAgIHR5cGU6IFwibGluZWFyXCIsXG4gICAgICBzY2hlbWU6IFwiUHVycGxlc1wiLFxuICAgICAgZG9tYWluOiBbMCwgMC42XSxcbiAgICAgIGxhYmVsOiBcIkF0dGVudGlvbiBXZWlnaHRcIixcbiAgICAgIGxlZ2VuZDogdHJ1ZVxuICAgIH0sXG4gICAgbWFya3M6IFtcbiAgICAgIFBsb3QuY2VsbChoZWF0bWFwRGF0YSwge1xuICAgICAgICB4OiBcIkF0dGVuZHNUb1wiLFxuICAgICAgICB5OiBcIldvcmRcIixcbiAgICAgICAgZmlsbDogXCJXZWlnaHRcIixcbiAgICAgICAgaW5zZXQ6IDAuNVxuICAgICAgfSksXG4gICAgICBQbG90LnRleHQoaGVhdG1hcERhdGEsIHtcbiAgICAgICAgeDogXCJBdHRlbmRzVG9cIixcbiAgICAgICAgeTogXCJXb3JkXCIsXG4gICAgICAgIHRleHQ6IGQgPT4gZC5XZWlnaHQudG9GaXhlZCgyKSxcbiAgICAgICAgZmlsbDogZCA9PiBkLldlaWdodCA+IDAuMyA/IFwid2hpdGVcIiA6IFwiYmxhY2tcIixcbiAgICAgICAgZm9udFNpemU6IDExLFxuICAgICAgICBmb250V2VpZ2h0OiBcImJvbGRcIlxuICAgICAgfSksXG4gICAgICAvLyBIaWdobGlnaHQgYm94IGFyb3VuZCBcImhlclwiIOKGkiBcInNjaWVudGlzdFwiXG4gICAgICBQbG90LnJlY3QoW3t4OiBcInNjaWVudGlzdFwiLCB5OiBcImhlclwifV0sIHtcbiAgICAgICAgeDogXCJ4XCIsXG4gICAgICAgIHk6IFwieVwiLFxuICAgICAgICBmaWxsOiBcIm5vbmVcIixcbiAgICAgICAgc3Ryb2tlOiBcInJlZFwiLFxuICAgICAgICBzdHJva2VXaWR0aDogMyxcbiAgICAgICAgaW5zZXQ6IC0yXG4gICAgICB9KSxcbiAgICAgIFBsb3QudGV4dChbeyB4OiAwLCB5OiAwIH1dLCB7XG4gICAgICAgIHg6ICgpID0+IHdvcmRzLmxlbmd0aCAvIDIgLSAwLjUsXG4gICAgICAgIHk6ICgpID0+IC0wLjksXG4gICAgICAgIHRleHQ6ICgpID0+IFwiQ29yZWZlcmVuY2UgdmlhIEF0dGVudGlvbjogJ2hlcicg4oaSICdzY2llbnRpc3QnXCIsXG4gICAgICAgIGZvbnRTaXplOiAxNCxcbiAgICAgICAgZm9udFdlaWdodDogXCJib2xkXCIsXG4gICAgICAgIGZyYW1lQW5jaG9yOiBcInRvcFwiLFxuICAgICAgICBmaWxsOiBcImJsYWNrXCJcbiAgICAgIH0pXG4gICAgXVxuICB9KTtcbn1cbiJ9XX0=
</script>
<script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../../m03-text";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "..";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../m03-text/tokenization.html" class="pagination-link" aria-label="Tokenization: Unboxing How LLMs Read Text">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Tokenization: Unboxing How LLMs Read Text</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../m03-text/word-embeddings.html" class="pagination-link" aria-label="Word Embeddings: Where It Started">
        <span class="nav-page-text">Word Embeddings: Where It Started</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb20" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Transformers"</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">    enabled: true</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="an">filters:</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">  - marimo-team/marimo</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>**The Spoiler:** The entire transformer revolution boils down to this—static embeddings assign one vector per word, ignoring that "bank" near "river" is mathematically different from "bank" near "money." Transformers solve this by computing context-aware representations through weighted mixing, and the weights themselves emerge from learned comparisons (Query × Key) between words. The result: machines finally understand that meaning isn't in the word; it's in the *distribution* of words around it.</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="fu">## One word, one vector is not enough</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>For many years, natural language processing treated words as having fixed meanings. We represented each word—like "bank"—as a single vector of numbers, called **static embeddings**.</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>But there's a hidden catch in this "one meaning per word" mindset: with just a single fixed entry in the dictionary, "bank" means exactly the same thing in "I deposited money at the bank" as in "We had a picnic by the bank." Every possible meaning gets mashed into a one-size-fits-all average—like describing the population by its *average* height and pretending that nobody's any shorter or taller. The interesting details—the outliers, the context clues—vanish in the mix.</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>The naive hypothesis went like this: what if we just *mix* the target word with its neighbors? For the sentence "I deposited money at the bank," we could compute a *contextualized representation* as:</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>\vec{v}_{\text{bank (new)}} = w_1 \cdot \vec{v}_{\text{bank}} + w_2 \cdot \vec{v}_{\text{deposited}} + w_3 \cdot \vec{v}_{\text{money}} + \cdots</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>where $w_i$ are weights and $\vec{v}_i$ are word embeddings.</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>Consider the following example. Notice that "bank" sits neutrally between financial terms (money) and geographical terms (river). Now try manually adjusting the weights to contextualize "bank":</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>d3 <span class="op">=</span> <span class="pp">require</span>(<span class="st">"d3@7"</span><span class="op">,</span> <span class="st">"d3-simple-slider@1"</span>)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sliderWithLabel</span>(min<span class="op">,</span> max<span class="op">,</span> step<span class="op">,</span> width<span class="op">,</span> defaultValue<span class="op">,</span> label) {</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> slider <span class="op">=</span> d3<span class="op">.</span><span class="fu">sliderBottom</span>()</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">min</span>(min)<span class="op">.</span><span class="fu">max</span>(max)<span class="op">.</span><span class="fu">step</span>(step)<span class="op">.</span><span class="fu">width</span>(width)<span class="op">.</span><span class="fu">default</span>(defaultValue)<span class="op">;</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width <span class="op">+</span> <span class="dv">50</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> <span class="dv">60</span>)<span class="op">;</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>  svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="st">"translate(25,20)"</span>)<span class="op">.</span><span class="fu">call</span>(slider)<span class="op">;</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>  svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (width <span class="op">+</span> <span class="dv">50</span>) <span class="op">/</span> <span class="dv">2</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"5px"</span>)<span class="op">.</span><span class="fu">text</span>(label)<span class="op">;</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> svg<span class="op">.</span><span class="fu">node</span>()<span class="op">;</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create slider function that returns both the element and a reactive value</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">createWeightSlider</span>(min<span class="op">,</span> max<span class="op">,</span> step<span class="op">,</span> width<span class="op">,</span> defaultValue<span class="op">,</span> label) {</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> slider <span class="op">=</span> d3<span class="op">.</span><span class="fu">sliderBottom</span>()</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">min</span>(min)<span class="op">.</span><span class="fu">max</span>(max)<span class="op">.</span><span class="fu">step</span>(step)<span class="op">.</span><span class="fu">width</span>(width)<span class="op">.</span><span class="fu">default</span>(defaultValue)<span class="op">;</span></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width <span class="op">+</span> <span class="dv">50</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> <span class="dv">60</span>)<span class="op">;</span></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> g <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="st">"translate(25,20)"</span>)<span class="op">;</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>    g<span class="op">.</span><span class="fu">call</span>(slider)<span class="op">;</span></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>    svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (width <span class="op">+</span> <span class="dv">50</span>) <span class="op">/</span> <span class="dv">2</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>       <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"12px"</span>)<span class="op">.</span><span class="fu">text</span>(label)<span class="op">;</span></span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="dt">node</span><span class="op">:</span> svg<span class="op">.</span><span class="fu">node</span>()<span class="op">,</span> <span class="dt">slider</span><span class="op">:</span> slider }<span class="op">;</span></span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create sliders</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> bankSliderObj <span class="op">=</span> <span class="fu">createWeightSlider</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="fl">0.01</span><span class="op">,</span> <span class="dv">120</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="st">"Bank weight"</span>)<span class="op">;</span></span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> moneySliderObj <span class="op">=</span> <span class="fu">createWeightSlider</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="fl">0.01</span><span class="op">,</span> <span class="dv">120</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="st">"Money weight"</span>)<span class="op">;</span></span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> riverSliderObj <span class="op">=</span> <span class="fu">createWeightSlider</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="fl">0.01</span><span class="op">,</span> <span class="dv">120</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="st">"River weight"</span>)<span class="op">;</span></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Word embeddings in 2D space</span></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> contextWords <span class="op">=</span> [<span class="st">"bank"</span><span class="op">,</span> <span class="st">"money"</span><span class="op">,</span> <span class="st">"river"</span>]<span class="op">;</span></span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> contextEmbeddings <span class="op">=</span> [</span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.0</span>]<span class="op">,</span>   <span class="co">// bank (center)</span></span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>    [<span class="op">-</span><span class="fl">1.6</span><span class="op">,</span> <span class="op">-</span><span class="fl">0.6</span>]<span class="op">,</span> <span class="co">// money (financial, left)</span></span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">1.4</span><span class="op">,</span> <span class="op">-</span><span class="fl">1.0</span>]   <span class="co">// river (geographical, right)</span></span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create plot container</span></span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> plotContainer <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">"div"</span>)<span class="op">;</span></span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Function to update visualization</span></span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">update</span>() {</span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get current slider values</span></span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> bankWeight <span class="op">=</span> bankSliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">value</span>()<span class="op">;</span></span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> moneyWeight <span class="op">=</span> moneySliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">value</span>()<span class="op">;</span></span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> riverWeight <span class="op">=</span> riverSliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">value</span>()<span class="op">;</span></span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calculate weighted average</span></span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> weights <span class="op">=</span> [bankWeight<span class="op">,</span> moneyWeight<span class="op">,</span> riverWeight]<span class="op">;</span></span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> total <span class="op">=</span> weights<span class="op">.</span><span class="fu">reduce</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a <span class="op">+</span> b<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> normalizedWeights <span class="op">=</span> total <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> weights<span class="op">.</span><span class="fu">map</span>(w <span class="kw">=&gt;</span> w <span class="op">/</span> total) <span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> newVec <span class="op">=</span> [</span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">0</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span></span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">1</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">1</span>][<span class="dv">0</span>] <span class="op">+</span></span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">2</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">2</span>][<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">0</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">+</span></span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">1</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">1</span>][<span class="dv">1</span>] <span class="op">+</span></span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>      normalizedWeights[<span class="dv">2</span>] <span class="op">*</span> contextEmbeddings[<span class="dv">2</span>][<span class="dv">1</span>]</span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Prepare data for visualization</span></span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> originalData <span class="op">=</span> contextWords<span class="op">.</span><span class="fu">map</span>((word<span class="op">,</span> i) <span class="kw">=&gt;</span> ({</span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a>      <span class="dt">word</span><span class="op">:</span> word<span class="op">,</span></span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> contextEmbeddings[i][<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> contextEmbeddings[i][<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">"Original"</span></span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> contextualizedData <span class="op">=</span> [{</span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a>      <span class="dt">word</span><span class="op">:</span> <span class="st">"bank (new)"</span><span class="op">,</span></span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> newVec[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> newVec[<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb20-114"><a href="#cb20-114" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">"Contextualized"</span></span>
<span id="cb20-115"><a href="#cb20-115" aria-hidden="true" tabindex="-1"></a>    }]<span class="op">;</span></span>
<span id="cb20-116"><a href="#cb20-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-117"><a href="#cb20-117" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> [<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>contextualizedData]<span class="op">;</span></span>
<span id="cb20-118"><a href="#cb20-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-119"><a href="#cb20-119" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clear and update plot</span></span>
<span id="cb20-120"><a href="#cb20-120" aria-hidden="true" tabindex="-1"></a>    d3<span class="op">.</span><span class="fu">select</span>(plotContainer)<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb20-121"><a href="#cb20-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-122"><a href="#cb20-122" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create visualization</span></span>
<span id="cb20-123"><a href="#cb20-123" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> plot <span class="op">=</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb20-124"><a href="#cb20-124" aria-hidden="true" tabindex="-1"></a>      <span class="dt">width</span><span class="op">:</span> <span class="dv">300</span><span class="op">,</span></span>
<span id="cb20-125"><a href="#cb20-125" aria-hidden="true" tabindex="-1"></a>      <span class="dt">height</span><span class="op">:</span> <span class="dv">300</span><span class="op">,</span></span>
<span id="cb20-126"><a href="#cb20-126" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb20-127"><a href="#cb20-127" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb20-128"><a href="#cb20-128" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb20-129"><a href="#cb20-129" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb20-130"><a href="#cb20-130" aria-hidden="true" tabindex="-1"></a>      <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb20-131"><a href="#cb20-131" aria-hidden="true" tabindex="-1"></a>        <span class="dt">background</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span></span>
<span id="cb20-132"><a href="#cb20-132" aria-hidden="true" tabindex="-1"></a>        <span class="dt">color</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb20-133"><a href="#cb20-133" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb20-134"><a href="#cb20-134" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb20-135"><a href="#cb20-135" aria-hidden="true" tabindex="-1"></a>        <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">2</span>]<span class="op">,</span></span>
<span id="cb20-136"><a href="#cb20-136" aria-hidden="true" tabindex="-1"></a>        <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 1"</span><span class="op">,</span></span>
<span id="cb20-137"><a href="#cb20-137" aria-hidden="true" tabindex="-1"></a>        <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb20-138"><a href="#cb20-138" aria-hidden="true" tabindex="-1"></a>        <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb20-139"><a href="#cb20-139" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb20-140"><a href="#cb20-140" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb20-141"><a href="#cb20-141" aria-hidden="true" tabindex="-1"></a>        <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">2</span>]<span class="op">,</span></span>
<span id="cb20-142"><a href="#cb20-142" aria-hidden="true" tabindex="-1"></a>        <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 2"</span><span class="op">,</span></span>
<span id="cb20-143"><a href="#cb20-143" aria-hidden="true" tabindex="-1"></a>        <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb20-144"><a href="#cb20-144" aria-hidden="true" tabindex="-1"></a>        <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb20-145"><a href="#cb20-145" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb20-146"><a href="#cb20-146" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb20-147"><a href="#cb20-147" aria-hidden="true" tabindex="-1"></a>        <span class="dt">domain</span><span class="op">:</span> [<span class="st">"Original"</span><span class="op">,</span> <span class="st">"Contextualized"</span>]<span class="op">,</span></span>
<span id="cb20-148"><a href="#cb20-148" aria-hidden="true" tabindex="-1"></a>        <span class="dt">range</span><span class="op">:</span> [<span class="st">"#dadada"</span><span class="op">,</span> <span class="st">"#ff7f0e"</span>]</span>
<span id="cb20-149"><a href="#cb20-149" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb20-150"><a href="#cb20-150" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb20-151"><a href="#cb20-151" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">dot</span>(data<span class="op">,</span> {</span>
<span id="cb20-152"><a href="#cb20-152" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb20-153"><a href="#cb20-153" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb20-154"><a href="#cb20-154" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"type"</span><span class="op">,</span></span>
<span id="cb20-155"><a href="#cb20-155" aria-hidden="true" tabindex="-1"></a>          <span class="dt">r</span><span class="op">:</span> <span class="dv">8</span><span class="op">,</span></span>
<span id="cb20-156"><a href="#cb20-156" aria-hidden="true" tabindex="-1"></a>          <span class="dt">tip</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb20-157"><a href="#cb20-157" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb20-158"><a href="#cb20-158" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">text</span>(data<span class="op">,</span> {</span>
<span id="cb20-159"><a href="#cb20-159" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb20-160"><a href="#cb20-160" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb20-161"><a href="#cb20-161" aria-hidden="true" tabindex="-1"></a>          <span class="dt">text</span><span class="op">:</span> <span class="st">"word"</span><span class="op">,</span></span>
<span id="cb20-162"><a href="#cb20-162" aria-hidden="true" tabindex="-1"></a>          <span class="dt">dy</span><span class="op">:</span> <span class="op">-</span><span class="dv">15</span><span class="op">,</span></span>
<span id="cb20-163"><a href="#cb20-163" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">8</span><span class="op">,</span></span>
<span id="cb20-164"><a href="#cb20-164" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb20-165"><a href="#cb20-165" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb20-166"><a href="#cb20-166" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb20-167"><a href="#cb20-167" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">text</span>([{<span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">2.3</span>}]<span class="op">,</span> {</span>
<span id="cb20-168"><a href="#cb20-168" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb20-169"><a href="#cb20-169" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb20-170"><a href="#cb20-170" aria-hidden="true" tabindex="-1"></a>          <span class="dt">text</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="vs">`Weights: Bank=</span><span class="sc">${</span>normalizedWeights[<span class="dv">0</span>]<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">, Money=</span><span class="sc">${</span>normalizedWeights[<span class="dv">1</span>]<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">, River=</span><span class="sc">${</span>normalizedWeights[<span class="dv">2</span>]<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb20-171"><a href="#cb20-171" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">11</span><span class="op">,</span></span>
<span id="cb20-172"><a href="#cb20-172" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb20-173"><a href="#cb20-173" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb20-174"><a href="#cb20-174" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Custom legend at top center</span></span>
<span id="cb20-175"><a href="#cb20-175" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">dot</span>([{<span class="dt">x</span><span class="op">:</span> <span class="op">-</span><span class="fl">0.8</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">2.7</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span> <span class="st">"#dadada"</span>}<span class="op">,</span> {<span class="dt">x</span><span class="op">:</span> <span class="fl">0.8</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">2.7</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span> <span class="st">"#ff7f0e"</span>}]<span class="op">,</span> {</span>
<span id="cb20-176"><a href="#cb20-176" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb20-177"><a href="#cb20-177" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb20-178"><a href="#cb20-178" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"color"</span><span class="op">,</span></span>
<span id="cb20-179"><a href="#cb20-179" aria-hidden="true" tabindex="-1"></a>          <span class="dt">r</span><span class="op">:</span> <span class="dv">6</span></span>
<span id="cb20-180"><a href="#cb20-180" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb20-181"><a href="#cb20-181" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">text</span>([{<span class="dt">x</span><span class="op">:</span> <span class="op">-</span><span class="fl">0.5</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">2.7</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Original"</span>}<span class="op">,</span> {<span class="dt">x</span><span class="op">:</span> <span class="fl">1.1</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">2.7</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Contextualized"</span>}]<span class="op">,</span> {</span>
<span id="cb20-182"><a href="#cb20-182" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb20-183"><a href="#cb20-183" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb20-184"><a href="#cb20-184" aria-hidden="true" tabindex="-1"></a>          <span class="dt">text</span><span class="op">:</span> <span class="st">"label"</span><span class="op">,</span></span>
<span id="cb20-185"><a href="#cb20-185" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb20-186"><a href="#cb20-186" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb20-187"><a href="#cb20-187" aria-hidden="true" tabindex="-1"></a>          <span class="dt">textAnchor</span><span class="op">:</span> <span class="st">"start"</span></span>
<span id="cb20-188"><a href="#cb20-188" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb20-189"><a href="#cb20-189" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb20-190"><a href="#cb20-190" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb20-191"><a href="#cb20-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-192"><a href="#cb20-192" aria-hidden="true" tabindex="-1"></a>    d3<span class="op">.</span><span class="fu">select</span>(plotContainer)<span class="op">.</span><span class="fu">node</span>()<span class="op">.</span><span class="fu">appendChild</span>(plot)<span class="op">;</span></span>
<span id="cb20-193"><a href="#cb20-193" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-194"><a href="#cb20-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-195"><a href="#cb20-195" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add event listeners to sliders</span></span>
<span id="cb20-196"><a href="#cb20-196" aria-hidden="true" tabindex="-1"></a>  bankSliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">on</span>(<span class="st">"onchange"</span><span class="op">,</span> update)<span class="op">;</span></span>
<span id="cb20-197"><a href="#cb20-197" aria-hidden="true" tabindex="-1"></a>  moneySliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">on</span>(<span class="st">"onchange"</span><span class="op">,</span> update)<span class="op">;</span></span>
<span id="cb20-198"><a href="#cb20-198" aria-hidden="true" tabindex="-1"></a>  riverSliderObj<span class="op">.</span><span class="at">slider</span><span class="op">.</span><span class="fu">on</span>(<span class="st">"onchange"</span><span class="op">,</span> update)<span class="op">;</span></span>
<span id="cb20-199"><a href="#cb20-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-200"><a href="#cb20-200" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initial render</span></span>
<span id="cb20-201"><a href="#cb20-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>()<span class="op">;</span></span>
<span id="cb20-202"><a href="#cb20-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-203"><a href="#cb20-203" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div style="display: flex; align-items: center; gap: 40px; justify-content: center;"&gt;</span></span>
<span id="cb20-204"><a href="#cb20-204" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="display: flex; flex-direction: column; gap: 10px;"&gt;</span></span>
<span id="cb20-205"><a href="#cb20-205" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>bankSliderObj<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb20-206"><a href="#cb20-206" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>moneySliderObj<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb20-207"><a href="#cb20-207" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>riverSliderObj<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb20-208"><a href="#cb20-208" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/div&gt;</span></span>
<span id="cb20-209"><a href="#cb20-209" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div&gt;</span></span>
<span id="cb20-210"><a href="#cb20-210" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>plotContainer<span class="sc">}</span></span>
<span id="cb20-211"><a href="#cb20-211" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/div&gt;</span></span>
<span id="cb20-212"><a href="#cb20-212" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb20-213"><a href="#cb20-213" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-214"><a href="#cb20-214" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-215"><a href="#cb20-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-216"><a href="#cb20-216" aria-hidden="true" tabindex="-1"></a>By changing the weights, we can see that the vector for "bank" can lean more towards the financial terms or the geographical terms. So how can we determine the weights?</span>
<span id="cb20-217"><a href="#cb20-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-218"><a href="#cb20-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-219"><a href="#cb20-219" aria-hidden="true" tabindex="-1"></a>The simplest idea is to give each word an equal weight: $w_i = 1/N$. This creates a basic "bag-of-words" average. But sentences aren’t actually this fair—some words are much more important than others. For example, in "I deposited money at the bank," the words "deposited" and "money" are key, while "I," "at," and "the" add little meaning. If we treat all words the same, we lose the details that matter. We need a way to highlight the important words and downplay the rest.</span>
<span id="cb20-220"><a href="#cb20-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-221"><a href="#cb20-221" aria-hidden="true" tabindex="-1"></a><span class="fu">## Attention mechanism</span></span>
<span id="cb20-222"><a href="#cb20-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-223"><a href="#cb20-223" aria-hidden="true" tabindex="-1"></a>Let's walk through how transformers identify the surrounding words that are relevant to a focal word to be contextualized, which is called the **attention mechanism**. Before we dive into the attention mechanism, let's first prepare some terminology.</span>
<span id="cb20-224"><a href="#cb20-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-225"><a href="#cb20-225" aria-hidden="true" tabindex="-1"></a>Suppose we have a sentence "I deposited money at the bank". Given a word "bank", we want to determine the weights $w_i$ for the surrounding words "I", "deposited", "money", and "at". We call the word "bank" the **query** word, and the surrounding words the **key** words. At a high level, we want to compute the weights $w_i$ for each query and key pair, and then average them.</span>
<span id="cb20-226"><a href="#cb20-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-227"><a href="#cb20-227" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-228"><a href="#cb20-228" aria-hidden="true" tabindex="-1"></a>\vec{v}_{\text{query}} ^{\text{c}} = \sum_{i=1}^N w_i \cdot \vec{v}_{i}</span>
<span id="cb20-229"><a href="#cb20-229" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-230"><a href="#cb20-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-231"><a href="#cb20-231" aria-hidden="true" tabindex="-1"></a>with weights $w_i$ being determined by the query and key vectors $w_{i}:=f(\vec{v}_{\text{query}}, \vec{v}_{i})$.</span>
<span id="cb20-232"><a href="#cb20-232" aria-hidden="true" tabindex="-1"></a>This function, $f$, is calle the **attention score function**.</span>
<span id="cb20-233"><a href="#cb20-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-234"><a href="#cb20-234" aria-hidden="true" tabindex="-1"></a>In transformers, the attention score function $f$ is implemented as follows.</span>
<span id="cb20-235"><a href="#cb20-235" aria-hidden="true" tabindex="-1"></a>Given the original vector for a word (regardless of whether it is the query word or the key word), we linearly transform it into three vectors: Query, Key, and Value.</span>
<span id="cb20-236"><a href="#cb20-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-237"><a href="#cb20-237" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-238"><a href="#cb20-238" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb20-239"><a href="#cb20-239" aria-hidden="true" tabindex="-1"></a>\vec{q}_i &amp;= W_Q \vec{x}_i<span class="sc">\\</span></span>
<span id="cb20-240"><a href="#cb20-240" aria-hidden="true" tabindex="-1"></a>\vec{k}_i &amp;= W_K \vec{x}_i<span class="sc">\\</span></span>
<span id="cb20-241"><a href="#cb20-241" aria-hidden="true" tabindex="-1"></a>\vec{v}_i &amp;= W_V \vec{x}_i</span>
<span id="cb20-242"><a href="#cb20-242" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb20-243"><a href="#cb20-243" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-244"><a href="#cb20-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-245"><a href="#cb20-245" aria-hidden="true" tabindex="-1"></a>Why do we need three different vectors?</span>
<span id="cb20-246"><a href="#cb20-246" aria-hidden="true" tabindex="-1"></a>Imagine you are participating in a dinner party. You want to identify the people who are talking about a topic you care about. You listen to the surrounding people, playing as a 'listener'. At the same time, you also broadcast your own interests, playing as a 'speaker'. The query vector is representing you as a listener, the key vector is representing the people as speakers. And the value vector is representing the content of the conversation.</span>
<span id="cb20-247"><a href="#cb20-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-248"><a href="#cb20-248" aria-hidden="true" tabindex="-1"></a>Once we have the query, key, and value vectors, we can compute the attention scores between the query and key vector as follows:</span>
<span id="cb20-249"><a href="#cb20-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-250"><a href="#cb20-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-251"><a href="#cb20-251" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-252"><a href="#cb20-252" aria-hidden="true" tabindex="-1"></a>w_{ij} = \frac{\exp(\vec{q}_i \cdot \vec{k}_j / \sqrt{d})}{\sum_{\ell} \exp(\vec{q}_i \cdot \vec{k}_\ell / \sqrt{d})},</span>
<span id="cb20-253"><a href="#cb20-253" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-254"><a href="#cb20-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-255"><a href="#cb20-255" aria-hidden="true" tabindex="-1"></a>where $\vec{q}_i \cdot \vec{k}_j$ is the dot product between the query and key vectors, which is larger when the query and key vectors are *similar* (e.g., pointing to a similar direction).</span>
<span id="cb20-256"><a href="#cb20-256" aria-hidden="true" tabindex="-1"></a>The division by $\sqrt{d}$ (where $d$ is the embedding dimension) is a scaling factor that prevents vanishing gradients during training. Finally, compute the **contextualized representation** as a weighted sum: $\text{contextualized}_i = \sum_j w_{ij} \vec{v}_j$.</span>
<span id="cb20-257"><a href="#cb20-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-258"><a href="#cb20-258" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb20-259"><a href="#cb20-259" aria-hidden="true" tabindex="-1"></a>What is the vanishing gradient problem? It is a problem that the gradients of the loss function with respect to the weights become too small to be effective during training.</span>
<span id="cb20-260"><a href="#cb20-260" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb20-261"><a href="#cb20-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-262"><a href="#cb20-262" aria-hidden="true" tabindex="-1"></a>Explore how different Query and Key transformations produce different attention patterns. First, let us create the key, query, and value vectors. In 2d, the linear transformation is just a scaling and a rotation.</span>
<span id="cb20-263"><a href="#cb20-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-266"><a href="#cb20-266" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-267"><a href="#cb20-267" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-268"><a href="#cb20-268" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">createQKVSlider</span>(min<span class="op">,</span> max<span class="op">,</span> step<span class="op">,</span> width<span class="op">,</span> defaultValue<span class="op">,</span> label<span class="op">,</span> valueSetter) {</span>
<span id="cb20-269"><a href="#cb20-269" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> slider <span class="op">=</span> d3<span class="op">.</span><span class="fu">sliderBottom</span>()</span>
<span id="cb20-270"><a href="#cb20-270" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">min</span>(min)<span class="op">.</span><span class="fu">max</span>(max)<span class="op">.</span><span class="fu">step</span>(step)<span class="op">.</span><span class="fu">width</span>(width)<span class="op">.</span><span class="fu">default</span>(defaultValue)</span>
<span id="cb20-271"><a href="#cb20-271" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">on</span>(<span class="st">'onchange'</span><span class="op">,</span> val <span class="kw">=&gt;</span> <span class="fu">valueSetter</span>(val))<span class="op">;</span></span>
<span id="cb20-272"><a href="#cb20-272" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width <span class="op">+</span> <span class="dv">40</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> <span class="dv">50</span>)<span class="op">;</span></span>
<span id="cb20-273"><a href="#cb20-273" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> g <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="st">"translate(20,15)"</span>)<span class="op">;</span></span>
<span id="cb20-274"><a href="#cb20-274" aria-hidden="true" tabindex="-1"></a>  g<span class="op">.</span><span class="fu">call</span>(slider)<span class="op">;</span></span>
<span id="cb20-275"><a href="#cb20-275" aria-hidden="true" tabindex="-1"></a>  svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (width <span class="op">+</span> <span class="dv">40</span>) <span class="op">/</span> <span class="dv">2</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb20-276"><a href="#cb20-276" aria-hidden="true" tabindex="-1"></a>     <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"11px"</span>)<span class="op">.</span><span class="fu">text</span>(label)<span class="op">;</span></span>
<span id="cb20-277"><a href="#cb20-277" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> { <span class="dt">node</span><span class="op">:</span> svg<span class="op">.</span><span class="fu">node</span>()<span class="op">,</span> <span class="dt">slider</span><span class="op">:</span> slider }<span class="op">;</span></span>
<span id="cb20-278"><a href="#cb20-278" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-279"><a href="#cb20-279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-280"><a href="#cb20-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-283"><a href="#cb20-283" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-284"><a href="#cb20-284" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-285"><a href="#cb20-285" aria-hidden="true" tabindex="-1"></a>mutable qScaleXValue <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb20-286"><a href="#cb20-286" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-287"><a href="#cb20-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-290"><a href="#cb20-290" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-291"><a href="#cb20-291" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-292"><a href="#cb20-292" aria-hidden="true" tabindex="-1"></a>mutable qScaleYValue <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb20-293"><a href="#cb20-293" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-294"><a href="#cb20-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-297"><a href="#cb20-297" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-298"><a href="#cb20-298" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-299"><a href="#cb20-299" aria-hidden="true" tabindex="-1"></a>mutable qRotateValue <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb20-300"><a href="#cb20-300" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-301"><a href="#cb20-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-304"><a href="#cb20-304" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-305"><a href="#cb20-305" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-306"><a href="#cb20-306" aria-hidden="true" tabindex="-1"></a>mutable kScaleXValue <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb20-307"><a href="#cb20-307" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-308"><a href="#cb20-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-311"><a href="#cb20-311" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-312"><a href="#cb20-312" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-313"><a href="#cb20-313" aria-hidden="true" tabindex="-1"></a>mutable kScaleYValue <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb20-314"><a href="#cb20-314" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-315"><a href="#cb20-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-318"><a href="#cb20-318" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-319"><a href="#cb20-319" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-320"><a href="#cb20-320" aria-hidden="true" tabindex="-1"></a>mutable kRotateValue <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb20-321"><a href="#cb20-321" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-322"><a href="#cb20-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-325"><a href="#cb20-325" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-326"><a href="#cb20-326" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-327"><a href="#cb20-327" aria-hidden="true" tabindex="-1"></a>qScaleXSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="fl">0.1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="st">"Q Scale X"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable qScaleXValue <span class="op">=</span> val)</span>
<span id="cb20-328"><a href="#cb20-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-329"><a href="#cb20-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-332"><a href="#cb20-332" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-333"><a href="#cb20-333" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-334"><a href="#cb20-334" aria-hidden="true" tabindex="-1"></a>qScaleYSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="fl">0.1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="st">"Q Scale Y"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable qScaleYValue <span class="op">=</span> val)</span>
<span id="cb20-335"><a href="#cb20-335" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-336"><a href="#cb20-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-339"><a href="#cb20-339" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-340"><a href="#cb20-340" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-341"><a href="#cb20-341" aria-hidden="true" tabindex="-1"></a>qRotateSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="op">-</span><span class="dv">180</span><span class="op">,</span> <span class="dv">180</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="st">"Q Rotate (deg)"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable qRotateValue <span class="op">=</span> val)</span>
<span id="cb20-342"><a href="#cb20-342" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-343"><a href="#cb20-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-346"><a href="#cb20-346" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-347"><a href="#cb20-347" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-348"><a href="#cb20-348" aria-hidden="true" tabindex="-1"></a>kScaleXSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="fl">0.1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="st">"K Scale X"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable kScaleXValue <span class="op">=</span> val)</span>
<span id="cb20-349"><a href="#cb20-349" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-350"><a href="#cb20-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-353"><a href="#cb20-353" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-354"><a href="#cb20-354" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-355"><a href="#cb20-355" aria-hidden="true" tabindex="-1"></a>kScaleYSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="fl">0.1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="st">"K Scale Y"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable kScaleYValue <span class="op">=</span> val)</span>
<span id="cb20-356"><a href="#cb20-356" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-357"><a href="#cb20-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-360"><a href="#cb20-360" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-361"><a href="#cb20-361" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-362"><a href="#cb20-362" aria-hidden="true" tabindex="-1"></a>kRotateSlider <span class="op">=</span> <span class="fu">createQKVSlider</span>(<span class="op">-</span><span class="dv">180</span><span class="op">,</span> <span class="dv">180</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="st">"K Rotate (deg)"</span><span class="op">,</span> val <span class="kw">=&gt;</span> mutable kRotateValue <span class="op">=</span> val)</span>
<span id="cb20-363"><a href="#cb20-363" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-364"><a href="#cb20-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-367"><a href="#cb20-367" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-368"><a href="#cb20-368" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-369"><a href="#cb20-369" aria-hidden="true" tabindex="-1"></a>qkvVisualization <span class="op">=</span> {</span>
<span id="cb20-370"><a href="#cb20-370" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Original word vectors (bank, money, river)</span></span>
<span id="cb20-371"><a href="#cb20-371" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> originalVectors <span class="op">=</span> [</span>
<span id="cb20-372"><a href="#cb20-372" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">name</span><span class="op">:</span> <span class="st">"bank"</span><span class="op">,</span> <span class="dt">vector</span><span class="op">:</span> [<span class="fl">1.5</span><span class="op">,</span> <span class="fl">0.5</span>] }<span class="op">,</span></span>
<span id="cb20-373"><a href="#cb20-373" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">name</span><span class="op">:</span> <span class="st">"money"</span><span class="op">,</span> <span class="dt">vector</span><span class="op">:</span> [<span class="fl">1.8</span><span class="op">,</span> <span class="fl">0.8</span>] }<span class="op">,</span></span>
<span id="cb20-374"><a href="#cb20-374" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">name</span><span class="op">:</span> <span class="st">"river"</span><span class="op">,</span> <span class="dt">vector</span><span class="op">:</span> [<span class="fl">0.5</span><span class="op">,</span> <span class="fl">1.5</span>] }</span>
<span id="cb20-375"><a href="#cb20-375" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb20-376"><a href="#cb20-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-377"><a href="#cb20-377" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create plot containers</span></span>
<span id="cb20-378"><a href="#cb20-378" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qPlotContainer <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">"div"</span>)<span class="op">;</span></span>
<span id="cb20-379"><a href="#cb20-379" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kPlotContainer <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">"div"</span>)<span class="op">;</span></span>
<span id="cb20-380"><a href="#cb20-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-381"><a href="#cb20-381" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Function to transform vector</span></span>
<span id="cb20-382"><a href="#cb20-382" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">transformVector</span>(vec<span class="op">,</span> scaleX<span class="op">,</span> scaleY<span class="op">,</span> rotateDeg) {</span>
<span id="cb20-383"><a href="#cb20-383" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> theta <span class="op">=</span> (rotateDeg <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span>) <span class="op">/</span> <span class="dv">180</span><span class="op">;</span></span>
<span id="cb20-384"><a href="#cb20-384" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cos <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">cos</span>(theta)<span class="op">;</span></span>
<span id="cb20-385"><a href="#cb20-385" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sin <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(theta)<span class="op">;</span></span>
<span id="cb20-386"><a href="#cb20-386" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> scaledX <span class="op">=</span> vec[<span class="dv">0</span>] <span class="op">*</span> scaleX<span class="op">;</span></span>
<span id="cb20-387"><a href="#cb20-387" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> scaledY <span class="op">=</span> vec[<span class="dv">1</span>] <span class="op">*</span> scaleY<span class="op">;</span></span>
<span id="cb20-388"><a href="#cb20-388" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [</span>
<span id="cb20-389"><a href="#cb20-389" aria-hidden="true" tabindex="-1"></a>      scaledX <span class="op">*</span> cos <span class="op">-</span> scaledY <span class="op">*</span> sin<span class="op">,</span></span>
<span id="cb20-390"><a href="#cb20-390" aria-hidden="true" tabindex="-1"></a>      scaledX <span class="op">*</span> sin <span class="op">+</span> scaledY <span class="op">*</span> cos</span>
<span id="cb20-391"><a href="#cb20-391" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb20-392"><a href="#cb20-392" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-393"><a href="#cb20-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-394"><a href="#cb20-394" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get current slider values from mutable variables (creates reactive dependency)</span></span>
<span id="cb20-395"><a href="#cb20-395" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qScaleX <span class="op">=</span> qScaleXValue<span class="op">;</span></span>
<span id="cb20-396"><a href="#cb20-396" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qScaleY <span class="op">=</span> qScaleYValue<span class="op">;</span></span>
<span id="cb20-397"><a href="#cb20-397" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qRotate <span class="op">=</span> qRotateValue<span class="op">;</span></span>
<span id="cb20-398"><a href="#cb20-398" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kScaleX <span class="op">=</span> kScaleXValue<span class="op">;</span></span>
<span id="cb20-399"><a href="#cb20-399" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kScaleY <span class="op">=</span> kScaleYValue<span class="op">;</span></span>
<span id="cb20-400"><a href="#cb20-400" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kRotate <span class="op">=</span> kRotateValue<span class="op">;</span></span>
<span id="cb20-401"><a href="#cb20-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-402"><a href="#cb20-402" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Prepare data for each plot</span></span>
<span id="cb20-403"><a href="#cb20-403" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> originalData <span class="op">=</span> originalVectors<span class="op">.</span><span class="fu">map</span>(item <span class="kw">=&gt;</span> ({</span>
<span id="cb20-404"><a href="#cb20-404" aria-hidden="true" tabindex="-1"></a>    <span class="dt">name</span><span class="op">:</span> item<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb20-405"><a href="#cb20-405" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> item<span class="op">.</span><span class="at">vector</span>[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb20-406"><a href="#cb20-406" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> item<span class="op">.</span><span class="at">vector</span>[<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb20-407"><a href="#cb20-407" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"Original"</span></span>
<span id="cb20-408"><a href="#cb20-408" aria-hidden="true" tabindex="-1"></a>  }))<span class="op">;</span></span>
<span id="cb20-409"><a href="#cb20-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-410"><a href="#cb20-410" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qData <span class="op">=</span> originalVectors<span class="op">.</span><span class="fu">map</span>(item <span class="kw">=&gt;</span> {</span>
<span id="cb20-411"><a href="#cb20-411" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> qVec <span class="op">=</span> <span class="fu">transformVector</span>(item<span class="op">.</span><span class="at">vector</span><span class="op">,</span> qScaleX<span class="op">,</span> qScaleY<span class="op">,</span> qRotate)<span class="op">;</span></span>
<span id="cb20-412"><a href="#cb20-412" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb20-413"><a href="#cb20-413" aria-hidden="true" tabindex="-1"></a>      <span class="dt">name</span><span class="op">:</span> <span class="vs">`q_</span><span class="sc">${</span>item<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb20-414"><a href="#cb20-414" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> qVec[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb20-415"><a href="#cb20-415" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> qVec[<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb20-416"><a href="#cb20-416" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">"Query"</span></span>
<span id="cb20-417"><a href="#cb20-417" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb20-418"><a href="#cb20-418" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb20-419"><a href="#cb20-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-420"><a href="#cb20-420" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kData <span class="op">=</span> originalVectors<span class="op">.</span><span class="fu">map</span>(item <span class="kw">=&gt;</span> {</span>
<span id="cb20-421"><a href="#cb20-421" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> kVec <span class="op">=</span> <span class="fu">transformVector</span>(item<span class="op">.</span><span class="at">vector</span><span class="op">,</span> kScaleX<span class="op">,</span> kScaleY<span class="op">,</span> kRotate)<span class="op">;</span></span>
<span id="cb20-422"><a href="#cb20-422" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb20-423"><a href="#cb20-423" aria-hidden="true" tabindex="-1"></a>      <span class="dt">name</span><span class="op">:</span> <span class="vs">`k_</span><span class="sc">${</span>item<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb20-424"><a href="#cb20-424" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> kVec[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb20-425"><a href="#cb20-425" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> kVec[<span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb20-426"><a href="#cb20-426" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">"Key"</span></span>
<span id="cb20-427"><a href="#cb20-427" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb20-428"><a href="#cb20-428" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb20-429"><a href="#cb20-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-430"><a href="#cb20-430" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create Query plot</span></span>
<span id="cb20-431"><a href="#cb20-431" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qPlot <span class="op">=</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb20-432"><a href="#cb20-432" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb20-433"><a href="#cb20-433" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb20-434"><a href="#cb20-434" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">40</span><span class="op">,</span></span>
<span id="cb20-435"><a href="#cb20-435" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb20-436"><a href="#cb20-436" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb20-437"><a href="#cb20-437" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb20-438"><a href="#cb20-438" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb20-439"><a href="#cb20-439" aria-hidden="true" tabindex="-1"></a>      <span class="dt">background</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span></span>
<span id="cb20-440"><a href="#cb20-440" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb20-441"><a href="#cb20-441" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb20-442"><a href="#cb20-442" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb20-443"><a href="#cb20-443" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">3</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span></span>
<span id="cb20-444"><a href="#cb20-444" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 1"</span><span class="op">,</span></span>
<span id="cb20-445"><a href="#cb20-445" aria-hidden="true" tabindex="-1"></a>      <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb20-446"><a href="#cb20-446" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb20-447"><a href="#cb20-447" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb20-448"><a href="#cb20-448" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb20-449"><a href="#cb20-449" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">3</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span></span>
<span id="cb20-450"><a href="#cb20-450" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 2"</span><span class="op">,</span></span>
<span id="cb20-451"><a href="#cb20-451" aria-hidden="true" tabindex="-1"></a>      <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb20-452"><a href="#cb20-452" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb20-453"><a href="#cb20-453" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb20-454"><a href="#cb20-454" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb20-455"><a href="#cb20-455" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>([{<span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="dv">0</span>}]<span class="op">,</span> {</span>
<span id="cb20-456"><a href="#cb20-456" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb20-457"><a href="#cb20-457" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb20-458"><a href="#cb20-458" aria-hidden="true" tabindex="-1"></a>        <span class="dt">r</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb20-459"><a href="#cb20-459" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb20-460"><a href="#cb20-460" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb20-461"><a href="#cb20-461" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">arrow</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>qData]<span class="op">,</span> {</span>
<span id="cb20-462"><a href="#cb20-462" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x1</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb20-463"><a href="#cb20-463" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y1</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb20-464"><a href="#cb20-464" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x2</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb20-465"><a href="#cb20-465" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y2</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb20-466"><a href="#cb20-466" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stroke</span><span class="op">:</span> <span class="st">"type"</span><span class="op">,</span></span>
<span id="cb20-467"><a href="#cb20-467" aria-hidden="true" tabindex="-1"></a>        <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb20-468"><a href="#cb20-468" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headLength</span><span class="op">:</span> <span class="dv">8</span></span>
<span id="cb20-469"><a href="#cb20-469" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb20-470"><a href="#cb20-470" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>qData]<span class="op">,</span> {</span>
<span id="cb20-471"><a href="#cb20-471" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb20-472"><a href="#cb20-472" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb20-473"><a href="#cb20-473" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"type"</span><span class="op">,</span></span>
<span id="cb20-474"><a href="#cb20-474" aria-hidden="true" tabindex="-1"></a>        <span class="dt">r</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb20-475"><a href="#cb20-475" aria-hidden="true" tabindex="-1"></a>        <span class="dt">tip</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb20-476"><a href="#cb20-476" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb20-477"><a href="#cb20-477" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>qData]<span class="op">,</span> {</span>
<span id="cb20-478"><a href="#cb20-478" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb20-479"><a href="#cb20-479" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb20-480"><a href="#cb20-480" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> <span class="st">"name"</span><span class="op">,</span></span>
<span id="cb20-481"><a href="#cb20-481" aria-hidden="true" tabindex="-1"></a>        <span class="dt">dy</span><span class="op">:</span> <span class="op">-</span><span class="dv">12</span><span class="op">,</span></span>
<span id="cb20-482"><a href="#cb20-482" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">9</span><span class="op">,</span></span>
<span id="cb20-483"><a href="#cb20-483" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb20-484"><a href="#cb20-484" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb20-485"><a href="#cb20-485" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb20-486"><a href="#cb20-486" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([{ <span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">3.4</span> }]<span class="op">,</span> {</span>
<span id="cb20-487"><a href="#cb20-487" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb20-488"><a href="#cb20-488" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb20-489"><a href="#cb20-489" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="st">"Query Space"</span><span class="op">,</span></span>
<span id="cb20-490"><a href="#cb20-490" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span></span>
<span id="cb20-491"><a href="#cb20-491" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb20-492"><a href="#cb20-492" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb20-493"><a href="#cb20-493" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb20-494"><a href="#cb20-494" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb20-495"><a href="#cb20-495" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb20-496"><a href="#cb20-496" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="st">"Original"</span><span class="op">,</span> <span class="st">"Query"</span>]<span class="op">,</span></span>
<span id="cb20-497"><a href="#cb20-497" aria-hidden="true" tabindex="-1"></a>      <span class="dt">range</span><span class="op">:</span> [<span class="st">"#666666"</span><span class="op">,</span> <span class="st">"#4682b4"</span>]</span>
<span id="cb20-498"><a href="#cb20-498" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-499"><a href="#cb20-499" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb20-500"><a href="#cb20-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-501"><a href="#cb20-501" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create Key plot</span></span>
<span id="cb20-502"><a href="#cb20-502" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kPlot <span class="op">=</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb20-503"><a href="#cb20-503" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb20-504"><a href="#cb20-504" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb20-505"><a href="#cb20-505" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">40</span><span class="op">,</span></span>
<span id="cb20-506"><a href="#cb20-506" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb20-507"><a href="#cb20-507" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb20-508"><a href="#cb20-508" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb20-509"><a href="#cb20-509" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb20-510"><a href="#cb20-510" aria-hidden="true" tabindex="-1"></a>      <span class="dt">background</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span></span>
<span id="cb20-511"><a href="#cb20-511" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb20-512"><a href="#cb20-512" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb20-513"><a href="#cb20-513" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb20-514"><a href="#cb20-514" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">3</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span></span>
<span id="cb20-515"><a href="#cb20-515" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 1"</span><span class="op">,</span></span>
<span id="cb20-516"><a href="#cb20-516" aria-hidden="true" tabindex="-1"></a>      <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb20-517"><a href="#cb20-517" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb20-518"><a href="#cb20-518" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb20-519"><a href="#cb20-519" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb20-520"><a href="#cb20-520" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="dv">3</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">,</span></span>
<span id="cb20-521"><a href="#cb20-521" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Dimension 2"</span><span class="op">,</span></span>
<span id="cb20-522"><a href="#cb20-522" aria-hidden="true" tabindex="-1"></a>      <span class="dt">grid</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb20-523"><a href="#cb20-523" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ticks</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb20-524"><a href="#cb20-524" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb20-525"><a href="#cb20-525" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb20-526"><a href="#cb20-526" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>([{<span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="dv">0</span>}]<span class="op">,</span> {</span>
<span id="cb20-527"><a href="#cb20-527" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb20-528"><a href="#cb20-528" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb20-529"><a href="#cb20-529" aria-hidden="true" tabindex="-1"></a>        <span class="dt">r</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb20-530"><a href="#cb20-530" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb20-531"><a href="#cb20-531" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb20-532"><a href="#cb20-532" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">arrow</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>kData]<span class="op">,</span> {</span>
<span id="cb20-533"><a href="#cb20-533" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x1</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb20-534"><a href="#cb20-534" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y1</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb20-535"><a href="#cb20-535" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x2</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb20-536"><a href="#cb20-536" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y2</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb20-537"><a href="#cb20-537" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stroke</span><span class="op">:</span> <span class="st">"type"</span><span class="op">,</span></span>
<span id="cb20-538"><a href="#cb20-538" aria-hidden="true" tabindex="-1"></a>        <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb20-539"><a href="#cb20-539" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headLength</span><span class="op">:</span> <span class="dv">8</span></span>
<span id="cb20-540"><a href="#cb20-540" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb20-541"><a href="#cb20-541" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>kData]<span class="op">,</span> {</span>
<span id="cb20-542"><a href="#cb20-542" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb20-543"><a href="#cb20-543" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb20-544"><a href="#cb20-544" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"type"</span><span class="op">,</span></span>
<span id="cb20-545"><a href="#cb20-545" aria-hidden="true" tabindex="-1"></a>        <span class="dt">r</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb20-546"><a href="#cb20-546" aria-hidden="true" tabindex="-1"></a>        <span class="dt">tip</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb20-547"><a href="#cb20-547" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb20-548"><a href="#cb20-548" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([<span class="op">...</span>originalData<span class="op">,</span> <span class="op">...</span>kData]<span class="op">,</span> {</span>
<span id="cb20-549"><a href="#cb20-549" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb20-550"><a href="#cb20-550" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb20-551"><a href="#cb20-551" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> <span class="st">"name"</span><span class="op">,</span></span>
<span id="cb20-552"><a href="#cb20-552" aria-hidden="true" tabindex="-1"></a>        <span class="dt">dy</span><span class="op">:</span> <span class="op">-</span><span class="dv">12</span><span class="op">,</span></span>
<span id="cb20-553"><a href="#cb20-553" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">9</span><span class="op">,</span></span>
<span id="cb20-554"><a href="#cb20-554" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb20-555"><a href="#cb20-555" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb20-556"><a href="#cb20-556" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb20-557"><a href="#cb20-557" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([{ <span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fl">3.4</span> }]<span class="op">,</span> {</span>
<span id="cb20-558"><a href="#cb20-558" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb20-559"><a href="#cb20-559" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb20-560"><a href="#cb20-560" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="st">"Key Space"</span><span class="op">,</span></span>
<span id="cb20-561"><a href="#cb20-561" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span></span>
<span id="cb20-562"><a href="#cb20-562" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb20-563"><a href="#cb20-563" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb20-564"><a href="#cb20-564" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb20-565"><a href="#cb20-565" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb20-566"><a href="#cb20-566" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb20-567"><a href="#cb20-567" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="st">"Original"</span><span class="op">,</span> <span class="st">"Key"</span>]<span class="op">,</span></span>
<span id="cb20-568"><a href="#cb20-568" aria-hidden="true" tabindex="-1"></a>      <span class="dt">range</span><span class="op">:</span> [<span class="st">"#666666"</span><span class="op">,</span> <span class="st">"#2e8b57"</span>]</span>
<span id="cb20-569"><a href="#cb20-569" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-570"><a href="#cb20-570" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb20-571"><a href="#cb20-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-572"><a href="#cb20-572" aria-hidden="true" tabindex="-1"></a>  d3<span class="op">.</span><span class="fu">select</span>(qPlotContainer)<span class="op">.</span><span class="fu">node</span>()<span class="op">.</span><span class="fu">appendChild</span>(qPlot)<span class="op">;</span></span>
<span id="cb20-573"><a href="#cb20-573" aria-hidden="true" tabindex="-1"></a>  d3<span class="op">.</span><span class="fu">select</span>(kPlotContainer)<span class="op">.</span><span class="fu">node</span>()<span class="op">.</span><span class="fu">appendChild</span>(kPlot)<span class="op">;</span></span>
<span id="cb20-574"><a href="#cb20-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-575"><a href="#cb20-575" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div style="display: flex; justify-content: center; gap: 40px;"&gt;</span></span>
<span id="cb20-576"><a href="#cb20-576" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div style="display: flex; flex-direction: column; gap: 20px;"&gt;</span></span>
<span id="cb20-577"><a href="#cb20-577" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div style="display: flex; align-items: center; gap: 20px;"&gt;</span></span>
<span id="cb20-578"><a href="#cb20-578" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style="display: flex; flex-direction: column; gap: 8px;"&gt;</span></span>
<span id="cb20-579"><a href="#cb20-579" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div style="font-weight: bold; margin-bottom: 3px;"&gt;Query (W_Q)&lt;/div&gt;</span></span>
<span id="cb20-580"><a href="#cb20-580" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>qScaleXSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb20-581"><a href="#cb20-581" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>qScaleYSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb20-582"><a href="#cb20-582" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>qRotateSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb20-583"><a href="#cb20-583" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb20-584"><a href="#cb20-584" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span>qPlotContainer<span class="sc">}</span></span>
<span id="cb20-585"><a href="#cb20-585" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb20-586"><a href="#cb20-586" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div style="display: flex; align-items: center; gap: 20px;"&gt;</span></span>
<span id="cb20-587"><a href="#cb20-587" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style="display: flex; flex-direction: column; gap: 8px;"&gt;</span></span>
<span id="cb20-588"><a href="#cb20-588" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div style="font-weight: bold; margin-bottom: 3px;"&gt;Key (W_K)&lt;/div&gt;</span></span>
<span id="cb20-589"><a href="#cb20-589" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>kScaleXSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb20-590"><a href="#cb20-590" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>kScaleYSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb20-591"><a href="#cb20-591" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>kRotateSlider<span class="op">.</span><span class="at">node</span><span class="sc">}</span></span>
<span id="cb20-592"><a href="#cb20-592" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb20-593"><a href="#cb20-593" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span>kPlotContainer<span class="sc">}</span></span>
<span id="cb20-594"><a href="#cb20-594" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb20-595"><a href="#cb20-595" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/div&gt;</span></span>
<span id="cb20-596"><a href="#cb20-596" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb20-597"><a href="#cb20-597" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-598"><a href="#cb20-598" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-599"><a href="#cb20-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-600"><a href="#cb20-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-601"><a href="#cb20-601" aria-hidden="true" tabindex="-1"></a>Using the transformations above, we can compute the attention weights showing how each word attends to every other word:</span>
<span id="cb20-602"><a href="#cb20-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-605"><a href="#cb20-605" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-606"><a href="#cb20-606" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-607"><a href="#cb20-607" aria-hidden="true" tabindex="-1"></a>attentionHeatmap <span class="op">=</span> {</span>
<span id="cb20-608"><a href="#cb20-608" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get the original word vectors from the previous visualization</span></span>
<span id="cb20-609"><a href="#cb20-609" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> attentionWords <span class="op">=</span> [<span class="st">"bank"</span><span class="op">,</span> <span class="st">"money"</span><span class="op">,</span> <span class="st">"river"</span>]<span class="op">;</span></span>
<span id="cb20-610"><a href="#cb20-610" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> attentionEmbeddings <span class="op">=</span> [</span>
<span id="cb20-611"><a href="#cb20-611" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">1.5</span><span class="op">,</span> <span class="fl">0.5</span>]<span class="op">,</span></span>
<span id="cb20-612"><a href="#cb20-612" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">1.8</span><span class="op">,</span> <span class="fl">0.8</span>]<span class="op">,</span></span>
<span id="cb20-613"><a href="#cb20-613" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.5</span><span class="op">,</span> <span class="fl">1.5</span>]</span>
<span id="cb20-614"><a href="#cb20-614" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb20-615"><a href="#cb20-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-616"><a href="#cb20-616" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Transform vector function</span></span>
<span id="cb20-617"><a href="#cb20-617" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">transformVector</span>(vec<span class="op">,</span> scaleX<span class="op">,</span> scaleY<span class="op">,</span> rotateDeg) {</span>
<span id="cb20-618"><a href="#cb20-618" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> theta <span class="op">=</span> (rotateDeg <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span>) <span class="op">/</span> <span class="dv">180</span><span class="op">;</span></span>
<span id="cb20-619"><a href="#cb20-619" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cos <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">cos</span>(theta)<span class="op">;</span></span>
<span id="cb20-620"><a href="#cb20-620" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sin <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(theta)<span class="op">;</span></span>
<span id="cb20-621"><a href="#cb20-621" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> scaledX <span class="op">=</span> vec[<span class="dv">0</span>] <span class="op">*</span> scaleX<span class="op">;</span></span>
<span id="cb20-622"><a href="#cb20-622" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> scaledY <span class="op">=</span> vec[<span class="dv">1</span>] <span class="op">*</span> scaleY<span class="op">;</span></span>
<span id="cb20-623"><a href="#cb20-623" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [</span>
<span id="cb20-624"><a href="#cb20-624" aria-hidden="true" tabindex="-1"></a>      scaledX <span class="op">*</span> cos <span class="op">-</span> scaledY <span class="op">*</span> sin<span class="op">,</span></span>
<span id="cb20-625"><a href="#cb20-625" aria-hidden="true" tabindex="-1"></a>      scaledX <span class="op">*</span> sin <span class="op">+</span> scaledY <span class="op">*</span> cos</span>
<span id="cb20-626"><a href="#cb20-626" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb20-627"><a href="#cb20-627" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-628"><a href="#cb20-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-629"><a href="#cb20-629" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get current slider values from mutable variables (creates reactive dependency)</span></span>
<span id="cb20-630"><a href="#cb20-630" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qScaleX <span class="op">=</span> qScaleXValue<span class="op">;</span></span>
<span id="cb20-631"><a href="#cb20-631" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qScaleY <span class="op">=</span> qScaleYValue<span class="op">;</span></span>
<span id="cb20-632"><a href="#cb20-632" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> qRotate <span class="op">=</span> qRotateValue<span class="op">;</span></span>
<span id="cb20-633"><a href="#cb20-633" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kScaleX <span class="op">=</span> kScaleXValue<span class="op">;</span></span>
<span id="cb20-634"><a href="#cb20-634" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kScaleY <span class="op">=</span> kScaleYValue<span class="op">;</span></span>
<span id="cb20-635"><a href="#cb20-635" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kRotate <span class="op">=</span> kRotateValue<span class="op">;</span></span>
<span id="cb20-636"><a href="#cb20-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-637"><a href="#cb20-637" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Apply transformations</span></span>
<span id="cb20-638"><a href="#cb20-638" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> Q <span class="op">=</span> attentionEmbeddings<span class="op">.</span><span class="fu">map</span>(vec <span class="kw">=&gt;</span></span>
<span id="cb20-639"><a href="#cb20-639" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transformVector</span>(vec<span class="op">,</span> qScaleX<span class="op">,</span> qScaleY<span class="op">,</span> qRotate)</span>
<span id="cb20-640"><a href="#cb20-640" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb20-641"><a href="#cb20-641" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> K <span class="op">=</span> attentionEmbeddings<span class="op">.</span><span class="fu">map</span>(vec <span class="kw">=&gt;</span></span>
<span id="cb20-642"><a href="#cb20-642" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transformVector</span>(vec<span class="op">,</span> kScaleX<span class="op">,</span> kScaleY<span class="op">,</span> kRotate)</span>
<span id="cb20-643"><a href="#cb20-643" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb20-644"><a href="#cb20-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-645"><a href="#cb20-645" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute attention scores (Q @ K^T)</span></span>
<span id="cb20-646"><a href="#cb20-646" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> scores <span class="op">=</span> Q<span class="op">.</span><span class="fu">map</span>(q <span class="kw">=&gt;</span> K<span class="op">.</span><span class="fu">map</span>(k <span class="kw">=&gt;</span> q[<span class="dv">0</span>] <span class="op">*</span> k[<span class="dv">0</span>] <span class="op">+</span> q[<span class="dv">1</span>] <span class="op">*</span> k[<span class="dv">1</span>]))<span class="op">;</span></span>
<span id="cb20-647"><a href="#cb20-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-648"><a href="#cb20-648" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Apply softmax to each row</span></span>
<span id="cb20-649"><a href="#cb20-649" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> attentionWeights <span class="op">=</span> scores<span class="op">.</span><span class="fu">map</span>(row <span class="kw">=&gt;</span> {</span>
<span id="cb20-650"><a href="#cb20-650" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> maxScore <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(<span class="op">...</span>row)<span class="op">;</span></span>
<span id="cb20-651"><a href="#cb20-651" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> expScores <span class="op">=</span> row<span class="op">.</span><span class="fu">map</span>(s <span class="kw">=&gt;</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">exp</span>(s <span class="op">-</span> maxScore))<span class="op">;</span></span>
<span id="cb20-652"><a href="#cb20-652" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sumExp <span class="op">=</span> expScores<span class="op">.</span><span class="fu">reduce</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a <span class="op">+</span> b<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb20-653"><a href="#cb20-653" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> expScores<span class="op">.</span><span class="fu">map</span>(e <span class="kw">=&gt;</span> e <span class="op">/</span> sumExp)<span class="op">;</span></span>
<span id="cb20-654"><a href="#cb20-654" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb20-655"><a href="#cb20-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-656"><a href="#cb20-656" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Prepare data for heatmap</span></span>
<span id="cb20-657"><a href="#cb20-657" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> heatmapData <span class="op">=</span> (() <span class="kw">=&gt;</span> {</span>
<span id="cb20-658"><a href="#cb20-658" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb20-659"><a href="#cb20-659" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> attentionWords<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb20-660"><a href="#cb20-660" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">let</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> attentionWords<span class="op">.</span><span class="at">length</span><span class="op">;</span> j<span class="op">++</span>) {</span>
<span id="cb20-661"><a href="#cb20-661" aria-hidden="true" tabindex="-1"></a>        data<span class="op">.</span><span class="fu">push</span>({</span>
<span id="cb20-662"><a href="#cb20-662" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Query</span><span class="op">:</span> attentionWords[i]<span class="op">,</span></span>
<span id="cb20-663"><a href="#cb20-663" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Key</span><span class="op">:</span> attentionWords[j]<span class="op">,</span></span>
<span id="cb20-664"><a href="#cb20-664" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Weight</span><span class="op">:</span> attentionWeights[i][j]</span>
<span id="cb20-665"><a href="#cb20-665" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb20-666"><a href="#cb20-666" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb20-667"><a href="#cb20-667" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-668"><a href="#cb20-668" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb20-669"><a href="#cb20-669" aria-hidden="true" tabindex="-1"></a>  })()<span class="op">;</span></span>
<span id="cb20-670"><a href="#cb20-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-671"><a href="#cb20-671" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create attention heatmap</span></span>
<span id="cb20-672"><a href="#cb20-672" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb20-673"><a href="#cb20-673" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">320</span><span class="op">,</span></span>
<span id="cb20-674"><a href="#cb20-674" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">320</span><span class="op">,</span></span>
<span id="cb20-675"><a href="#cb20-675" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb20-676"><a href="#cb20-676" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb20-677"><a href="#cb20-677" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">70</span><span class="op">,</span></span>
<span id="cb20-678"><a href="#cb20-678" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">80</span><span class="op">,</span></span>
<span id="cb20-679"><a href="#cb20-679" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb20-680"><a href="#cb20-680" aria-hidden="true" tabindex="-1"></a>      <span class="dt">background</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span></span>
<span id="cb20-681"><a href="#cb20-681" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb20-682"><a href="#cb20-682" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb20-683"><a href="#cb20-683" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> { <span class="dt">label</span><span class="op">:</span> <span class="st">"Key Word"</span> }<span class="op">,</span></span>
<span id="cb20-684"><a href="#cb20-684" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> { <span class="dt">label</span><span class="op">:</span> <span class="st">"Query Word"</span> }<span class="op">,</span></span>
<span id="cb20-685"><a href="#cb20-685" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb20-686"><a href="#cb20-686" aria-hidden="true" tabindex="-1"></a>      <span class="dt">scheme</span><span class="op">:</span> <span class="st">"Blues"</span><span class="op">,</span></span>
<span id="cb20-687"><a href="#cb20-687" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Attention"</span><span class="op">,</span></span>
<span id="cb20-688"><a href="#cb20-688" aria-hidden="true" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb20-689"><a href="#cb20-689" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb20-690"><a href="#cb20-690" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb20-691"><a href="#cb20-691" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">cell</span>(heatmapData<span class="op">,</span> {</span>
<span id="cb20-692"><a href="#cb20-692" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"Key"</span><span class="op">,</span></span>
<span id="cb20-693"><a href="#cb20-693" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"Query"</span><span class="op">,</span></span>
<span id="cb20-694"><a href="#cb20-694" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"Weight"</span><span class="op">,</span></span>
<span id="cb20-695"><a href="#cb20-695" aria-hidden="true" tabindex="-1"></a>        <span class="dt">tip</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb20-696"><a href="#cb20-696" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb20-697"><a href="#cb20-697" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>(heatmapData<span class="op">,</span> {</span>
<span id="cb20-698"><a href="#cb20-698" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"Key"</span><span class="op">,</span></span>
<span id="cb20-699"><a href="#cb20-699" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"Query"</span><span class="op">,</span></span>
<span id="cb20-700"><a href="#cb20-700" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">Weight</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">,</span></span>
<span id="cb20-701"><a href="#cb20-701" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">Weight</span> <span class="op">&gt;</span> <span class="fl">0.35</span> <span class="op">?</span> <span class="st">"white"</span> <span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb20-702"><a href="#cb20-702" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">11</span></span>
<span id="cb20-703"><a href="#cb20-703" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb20-704"><a href="#cb20-704" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([{ <span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="dv">0</span> }]<span class="op">,</span> {</span>
<span id="cb20-705"><a href="#cb20-705" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> () <span class="kw">=&gt;</span> attentionWords<span class="op">.</span><span class="at">length</span> <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb20-706"><a href="#cb20-706" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="op">-</span><span class="fl">0.8</span><span class="op">,</span></span>
<span id="cb20-707"><a href="#cb20-707" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="st">"Attention Weights (Softmax)"</span><span class="op">,</span></span>
<span id="cb20-708"><a href="#cb20-708" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span></span>
<span id="cb20-709"><a href="#cb20-709" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb20-710"><a href="#cb20-710" aria-hidden="true" tabindex="-1"></a>        <span class="dt">frameAnchor</span><span class="op">:</span> <span class="st">"top"</span><span class="op">,</span></span>
<span id="cb20-711"><a href="#cb20-711" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb20-712"><a href="#cb20-712" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb20-713"><a href="#cb20-713" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb20-714"><a href="#cb20-714" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb20-715"><a href="#cb20-715" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-716"><a href="#cb20-716" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-717"><a href="#cb20-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-718"><a href="#cb20-718" aria-hidden="true" tabindex="-1"></a>Now scale this up. **Every word** in a sentence needs to attend to **every other word**. For "The cat sat on the mat" (six words), we compute a $6 \times 6$ **attention matrix** $A$, where $A_{ij} = \text{softmax}(\vec{q}_i \cdot \vec{k}_j)$. Rows represent words asking for context (Queries); columns represent words providing context (Keys). Each cell $(i,j)$ indicates how much word $i$ attends to word $j$. Each row sums to 1—it's a probability distribution over context words.</span>
<span id="cb20-719"><a href="#cb20-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-720"><a href="#cb20-720" aria-hidden="true" tabindex="-1"></a>But here's the final complication: **one attention matrix captures one type of relationship**. Language is multidimensional. There are syntactic relationships (subject-verb-object), semantic relationships (conceptual similarity between "cat" and "mat" as physical objects), positional relationships (local word order), and pragmatic relationships (coreference, where "her" links to "scientist"). A single attention mechanism can't capture all of these simultaneously.</span>
<span id="cb20-721"><a href="#cb20-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-722"><a href="#cb20-722" aria-hidden="true" tabindex="-1"></a><span class="al">![](../figs/transformer-multihead-attention.jpg)</span></span>
<span id="cb20-723"><a href="#cb20-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-724"><a href="#cb20-724" aria-hidden="true" tabindex="-1"></a>The solution is **multi-head attention**: run multiple attention mechanisms in parallel, each with its own $W_Q$, $W_K$, $W_V$ matrices. Mathematically, $\text{MultiHead}(X) = \text{Concat}(\text{head}_1, \text{head}_2, \ldots, \text{head}_h) W^O$. Each head learns a different attention pattern. Modern transformers use 8-16 heads per layer: BERT uses 12, GPT-3 uses 96. It's like having twelve different experts analyze the sentence simultaneously—one focusing on syntax, one on semantics, one on coreference—and then combining their insights through a learned linear transformation.</span>
<span id="cb20-725"><a href="#cb20-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-726"><a href="#cb20-726" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Complete Architecture: Engineering for Scale</span></span>
<span id="cb20-727"><a href="#cb20-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-728"><a href="#cb20-728" aria-hidden="true" tabindex="-1"></a>You've now discovered the core innovation: **self-attention via Query-Key-Value**. But a working transformer needs additional engineering to make this mechanism trainable at scale.</span>
<span id="cb20-729"><a href="#cb20-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-730"><a href="#cb20-730" aria-hidden="true" tabindex="-1"></a>**Positional encoding** solves the problem that attention is permutation-invariant. Without extra information, "cat sat" equals "sat cat" because the dot products don't encode order. The solution is to add position-dependent vectors to embeddings: $\text{input}_i = \text{embedding}_i + \text{position}_i$. Transformers use sinusoidal functions of varying frequencies: $\text{PE}(pos, 2i) = \sin(pos / 10000^{2i/d})$ and $\text{PE}(pos, 2i+1) = \cos(pos / 10000^{2i/d})$. This gives the model access to both absolute position and relative distances between words.</span>
<span id="cb20-731"><a href="#cb20-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-732"><a href="#cb20-732" aria-hidden="true" tabindex="-1"></a>**Residual connections** create highways for gradient flow. Deep networks suffer from vanishing gradients—signals decay exponentially as they backpropagate through layers. The solution is skip connections: $\text{output} = \text{LayerNorm}(x + \text{Attention}(x))$. This allows gradients to flow backward through 12-24 layers without vanishing.</span>
<span id="cb20-733"><a href="#cb20-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-734"><a href="#cb20-734" aria-hidden="true" tabindex="-1"></a>**Feed-forward networks** add processing power beyond attention. After the attention sublayer, each word's representation passes through a small multi-layer perceptron independently: $\text{FFN}(x) = \text{ReLU}(x W_1 + b_1) W_2 + b_2$. This introduces non-linearity and gives the model capacity to learn complex transformations.</span>
<span id="cb20-735"><a href="#cb20-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-736"><a href="#cb20-736" aria-hidden="true" tabindex="-1"></a>**Layer normalization** keeps activations in a stable numerical range during training, preventing exploding or vanishing values that would make gradient descent unstable.</span>
<span id="cb20-737"><a href="#cb20-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-738"><a href="#cb20-738" aria-hidden="true" tabindex="-1"></a>The complete transformer block, repeated 12 or more times, looks like this: Input → Multi-Head Self-Attention → Add &amp; LayerNorm (residual) → Feed-Forward Network → Add &amp; LayerNorm (residual) → Output passed to next block.</span>
<span id="cb20-739"><a href="#cb20-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-740"><a href="#cb20-740" aria-hidden="true" tabindex="-1"></a>Here's what matters: residual connections, layer normalization, and feed-forward networks all existed before 2017. The transformer's innovation is self-attention. That single mechanism replaced recurrent neural networks (RNNs), long short-term memory networks (LSTMs), and convolutional approaches for natural language processing. The original paper's title—*"Attention Is All You Need"*—was provocative but accurate.</span>
<span id="cb20-741"><a href="#cb20-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-742"><a href="#cb20-742" aria-hidden="true" tabindex="-1"></a>The attention mechanism gets deployed differently depending on the task. **Encoder-only architectures** like BERT use bidirectional attention where word $i$ can attend to all words, past and future. These models excel at understanding text for classification, embeddings, and extraction tasks. You feed in "Is this paper about networks or biology?" and get back a classification. **Decoder-only architectures** like GPT and Gemma use causal attention (masked) where word $i$ can only attend to words at positions $\leq i$. This prevents "looking into the future" during autoregressive generation. When generating text word-by-word, you can't use words you haven't generated yet. These models excel at completion and chat. **Encoder-decoder architectures** like the original transformer use bidirectional attention in the encoder to process input, causal attention in the decoder for output generation, plus **cross-attention** where the decoder's Query vectors attend to the encoder's Key and Value vectors. These models excel at sequence-to-sequence tasks like translation: "Hello world" → "Bonjour monde."</span>
<span id="cb20-743"><a href="#cb20-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-744"><a href="#cb20-744" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why This Changed Everything</span></span>
<span id="cb20-745"><a href="#cb20-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-746"><a href="#cb20-746" aria-hidden="true" tabindex="-1"></a>Before transformers, natural language processing used **sequential processing** via recurrent neural networks. The computational graph looked like: Word 1 → Hidden State 1 → Word 2 → Hidden State 2 → and so on. This architecture had three fatal flaws. First, sequential computation is inherently slow—you can't parallelize across words because each hidden state depends on the previous one. Second, information decays over long distances due to vanishing gradients; dependencies 100+ words apart become nearly impossible to learn. Third, the fixed-size hidden state creates an information bottleneck for long sequences.</span>
<span id="cb20-747"><a href="#cb20-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-748"><a href="#cb20-748" aria-hidden="true" tabindex="-1"></a>Transformers solved all three problems simultaneously. **Parallel processing** means all words are processed simultaneously, yielding 100× faster training on modern GPUs. **Arbitrary long-range dependencies** become tractable because "bank" in position 50 can directly attend to "money" in position 2 through a single matrix multiplication—no gradients need to flow through 48 intermediate steps. **Scalability** emerged as a predictable phenomenon: performance scales logarithmically with parameters. This revealed a stunning empirical fact—bigger models aren't just incrementally better; they unlock **qualitatively new capabilities** like in-context learning and multi-step reasoning. This is why GPT-4 dramatically exceeds GPT-3, which dramatically exceeds GPT-2, despite using essentially the same architecture.</span>
<span id="cb20-749"><a href="#cb20-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-750"><a href="#cb20-750" aria-hidden="true" tabindex="-1"></a>Consider a concrete example of how attention captures linguistic structure. Take the sentence "The scientist published her paper." We want to resolve the coreference: what does "her" refer to?</span>
<span id="cb20-751"><a href="#cb20-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-754"><a href="#cb20-754" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb20-755"><a href="#cb20-755" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb20-756"><a href="#cb20-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-757"><a href="#cb20-757" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb20-758"><a href="#cb20-758" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> words <span class="op">=</span> [<span class="st">"The"</span><span class="op">,</span> <span class="st">"scientist"</span><span class="op">,</span> <span class="st">"published"</span><span class="op">,</span> <span class="st">"her"</span><span class="op">,</span> <span class="st">"paper"</span>]<span class="op">;</span></span>
<span id="cb20-759"><a href="#cb20-759" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> attention <span class="op">=</span> [</span>
<span id="cb20-760"><a href="#cb20-760" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.5</span><span class="op">,</span> <span class="fl">0.3</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.05</span><span class="op">,</span> <span class="fl">0.05</span>]<span class="op">,</span>   <span class="co">// "The"→"scientist"</span></span>
<span id="cb20-761"><a href="#cb20-761" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.5</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.05</span><span class="op">,</span> <span class="fl">0.05</span>]<span class="op">,</span>   <span class="co">// "scientist"</span></span>
<span id="cb20-762"><a href="#cb20-762" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.05</span><span class="op">,</span> <span class="fl">0.3</span><span class="op">,</span> <span class="fl">0.4</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.15</span>]<span class="op">,</span>   <span class="co">// "published"</span></span>
<span id="cb20-763"><a href="#cb20-763" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.05</span><span class="op">,</span> <span class="fl">0.6</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.05</span>]<span class="op">,</span>   <span class="co">// "her"→"scientist" ← KEY!</span></span>
<span id="cb20-764"><a href="#cb20-764" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.05</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.15</span><span class="op">,</span> <span class="fl">0.5</span>]    <span class="co">// "paper"</span></span>
<span id="cb20-765"><a href="#cb20-765" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb20-766"><a href="#cb20-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-767"><a href="#cb20-767" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Prepare heatmap data</span></span>
<span id="cb20-768"><a href="#cb20-768" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> heatmapData <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb20-769"><a href="#cb20-769" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> words<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb20-770"><a href="#cb20-770" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> words<span class="op">.</span><span class="at">length</span><span class="op">;</span> j<span class="op">++</span>) {</span>
<span id="cb20-771"><a href="#cb20-771" aria-hidden="true" tabindex="-1"></a>      heatmapData<span class="op">.</span><span class="fu">push</span>({</span>
<span id="cb20-772"><a href="#cb20-772" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Word</span><span class="op">:</span> words[i]<span class="op">,</span></span>
<span id="cb20-773"><a href="#cb20-773" aria-hidden="true" tabindex="-1"></a>        <span class="dt">AttendsTo</span><span class="op">:</span> words[j]<span class="op">,</span></span>
<span id="cb20-774"><a href="#cb20-774" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Weight</span><span class="op">:</span> attention[i][j]<span class="op">,</span></span>
<span id="cb20-775"><a href="#cb20-775" aria-hidden="true" tabindex="-1"></a>        <span class="dt">isHighlight</span><span class="op">:</span> i <span class="op">===</span> <span class="dv">3</span> <span class="op">&amp;&amp;</span> j <span class="op">===</span> <span class="dv">1</span>  <span class="co">// "her" → "scientist"</span></span>
<span id="cb20-776"><a href="#cb20-776" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb20-777"><a href="#cb20-777" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-778"><a href="#cb20-778" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-779"><a href="#cb20-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-780"><a href="#cb20-780" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb20-781"><a href="#cb20-781" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb20-782"><a href="#cb20-782" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">400</span><span class="op">,</span></span>
<span id="cb20-783"><a href="#cb20-783" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb20-784"><a href="#cb20-784" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb20-785"><a href="#cb20-785" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">90</span><span class="op">,</span></span>
<span id="cb20-786"><a href="#cb20-786" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">120</span><span class="op">,</span></span>
<span id="cb20-787"><a href="#cb20-787" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb20-788"><a href="#cb20-788" aria-hidden="true" tabindex="-1"></a>      <span class="dt">background</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span></span>
<span id="cb20-789"><a href="#cb20-789" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb20-790"><a href="#cb20-790" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb20-791"><a href="#cb20-791" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb20-792"><a href="#cb20-792" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Attends To →"</span><span class="op">,</span></span>
<span id="cb20-793"><a href="#cb20-793" aria-hidden="true" tabindex="-1"></a>      <span class="dt">labelAnchor</span><span class="op">:</span> <span class="st">"center"</span></span>
<span id="cb20-794"><a href="#cb20-794" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb20-795"><a href="#cb20-795" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb20-796"><a href="#cb20-796" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"↑ Word"</span><span class="op">,</span></span>
<span id="cb20-797"><a href="#cb20-797" aria-hidden="true" tabindex="-1"></a>      <span class="dt">labelAnchor</span><span class="op">:</span> <span class="st">"center"</span></span>
<span id="cb20-798"><a href="#cb20-798" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb20-799"><a href="#cb20-799" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb20-800"><a href="#cb20-800" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">"linear"</span><span class="op">,</span></span>
<span id="cb20-801"><a href="#cb20-801" aria-hidden="true" tabindex="-1"></a>      <span class="dt">scheme</span><span class="op">:</span> <span class="st">"Purples"</span><span class="op">,</span></span>
<span id="cb20-802"><a href="#cb20-802" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="fl">0.6</span>]<span class="op">,</span></span>
<span id="cb20-803"><a href="#cb20-803" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Attention Weight"</span><span class="op">,</span></span>
<span id="cb20-804"><a href="#cb20-804" aria-hidden="true" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb20-805"><a href="#cb20-805" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb20-806"><a href="#cb20-806" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb20-807"><a href="#cb20-807" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">cell</span>(heatmapData<span class="op">,</span> {</span>
<span id="cb20-808"><a href="#cb20-808" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"AttendsTo"</span><span class="op">,</span></span>
<span id="cb20-809"><a href="#cb20-809" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"Word"</span><span class="op">,</span></span>
<span id="cb20-810"><a href="#cb20-810" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"Weight"</span><span class="op">,</span></span>
<span id="cb20-811"><a href="#cb20-811" aria-hidden="true" tabindex="-1"></a>        <span class="dt">inset</span><span class="op">:</span> <span class="fl">0.5</span></span>
<span id="cb20-812"><a href="#cb20-812" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb20-813"><a href="#cb20-813" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>(heatmapData<span class="op">,</span> {</span>
<span id="cb20-814"><a href="#cb20-814" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"AttendsTo"</span><span class="op">,</span></span>
<span id="cb20-815"><a href="#cb20-815" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"Word"</span><span class="op">,</span></span>
<span id="cb20-816"><a href="#cb20-816" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">Weight</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">,</span></span>
<span id="cb20-817"><a href="#cb20-817" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">Weight</span> <span class="op">&gt;</span> <span class="fl">0.3</span> <span class="op">?</span> <span class="st">"white"</span> <span class="op">:</span> <span class="st">"black"</span><span class="op">,</span></span>
<span id="cb20-818"><a href="#cb20-818" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">11</span><span class="op">,</span></span>
<span id="cb20-819"><a href="#cb20-819" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span></span>
<span id="cb20-820"><a href="#cb20-820" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb20-821"><a href="#cb20-821" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Highlight box around "her" → "scientist"</span></span>
<span id="cb20-822"><a href="#cb20-822" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">rect</span>([{<span class="dt">x</span><span class="op">:</span> <span class="st">"scientist"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"her"</span>}]<span class="op">,</span> {</span>
<span id="cb20-823"><a href="#cb20-823" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span></span>
<span id="cb20-824"><a href="#cb20-824" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span></span>
<span id="cb20-825"><a href="#cb20-825" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"none"</span><span class="op">,</span></span>
<span id="cb20-826"><a href="#cb20-826" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stroke</span><span class="op">:</span> <span class="st">"red"</span><span class="op">,</span></span>
<span id="cb20-827"><a href="#cb20-827" aria-hidden="true" tabindex="-1"></a>        <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb20-828"><a href="#cb20-828" aria-hidden="true" tabindex="-1"></a>        <span class="dt">inset</span><span class="op">:</span> <span class="op">-</span><span class="dv">2</span></span>
<span id="cb20-829"><a href="#cb20-829" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb20-830"><a href="#cb20-830" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>([{ <span class="dt">x</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="dv">0</span> }]<span class="op">,</span> {</span>
<span id="cb20-831"><a href="#cb20-831" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> () <span class="kw">=&gt;</span> words<span class="op">.</span><span class="at">length</span> <span class="op">/</span> <span class="dv">2</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb20-832"><a href="#cb20-832" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="op">-</span><span class="fl">0.9</span><span class="op">,</span></span>
<span id="cb20-833"><a href="#cb20-833" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="st">"Coreference via Attention: 'her' → 'scientist'"</span><span class="op">,</span></span>
<span id="cb20-834"><a href="#cb20-834" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">14</span><span class="op">,</span></span>
<span id="cb20-835"><a href="#cb20-835" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">"bold"</span><span class="op">,</span></span>
<span id="cb20-836"><a href="#cb20-836" aria-hidden="true" tabindex="-1"></a>        <span class="dt">frameAnchor</span><span class="op">:</span> <span class="st">"top"</span><span class="op">,</span></span>
<span id="cb20-837"><a href="#cb20-837" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"black"</span></span>
<span id="cb20-838"><a href="#cb20-838" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb20-839"><a href="#cb20-839" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb20-840"><a href="#cb20-840" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb20-841"><a href="#cb20-841" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-842"><a href="#cb20-842" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-843"><a href="#cb20-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-844"><a href="#cb20-844" aria-hidden="true" tabindex="-1"></a>*Attention pattern showing 'her' → 'scientist' (0.60 weight). The model learned coreference **without explicit grammar rules**—purely from prediction tasks.*</span>
<span id="cb20-845"><a href="#cb20-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-846"><a href="#cb20-846" aria-hidden="true" tabindex="-1"></a>Row 3 corresponds to "her." The pronoun attends most strongly to "scientist" (0.60), correctly identifying the referent. The model **discovered** that pronouns link to earlier nouns through statistical patterns in training data—no one programmed this grammatical rule. This is the profound insight: transformers learn the structure of language as a side effect of optimizing a simple prediction objective.</span>
<span id="cb20-847"><a href="#cb20-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-848"><a href="#cb20-848" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Existential Conclusion</span></span>
<span id="cb20-849"><a href="#cb20-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-850"><a href="#cb20-850" aria-hidden="true" tabindex="-1"></a>When you use <span class="in">`sentence-transformers`</span> to generate embeddings for your research, you're using encoder transformers (BERT-based) with bidirectional attention. When you interact with ChatGPT or run Gemma locally, you're using decoder transformers with causal attention. When you see attention visualizations in papers, you now understand they represent **learned relevance weights** computed from Query-Key comparisons. The models don't understand language the way humans do—they perform **pattern matching at scale**—but the patterns they discover are often the same syntactic and semantic structures that linguists have documented for decades.</span>
<span id="cb20-851"><a href="#cb20-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-852"><a href="#cb20-852" aria-hidden="true" tabindex="-1"></a>The limitations are worth remembering. Attention has **quadratic complexity**: computing $O(N^2)$ pairwise scores becomes prohibitively expensive for very long texts, which is why context windows typically cap at 2K-32K tokens. Transformers have **no true memory** beyond the current window—they can't learn facts across documents without retraining. They produce fluent text through statistical pattern matching but lack grounded understanding, leading to **hallucinations** when they confidently generate plausible-sounding nonsense. Training costs are astronomical: GPT-3 required roughly \$5 million in compute. But you don't need to train your own models; you can use pre-trained ones and fine-tune them for specific tasks with orders of magnitude less data and compute.</span>
<span id="cb20-853"><a href="#cb20-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-854"><a href="#cb20-854" aria-hidden="true" tabindex="-1"></a>Return to where we started: the "bank" problem. Static embeddings treated "bank" as one point in space, averaging across all contexts. Transformers compute a **distribution** of representations, conditioned on the surrounding words. The revolution wasn't in the complexity—it was in recognizing that **meaning is relational, not absolute**. Words are like atoms in a molecule: their properties depend on what they're bonded to. Transformers formalized this intuition mathematically through a simple mechanism: weighted mixing based on learned relevance.</span>
<span id="cb20-855"><a href="#cb20-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-856"><a href="#cb20-856" aria-hidden="true" tabindex="-1"></a>This entire architecture emerged from asking a single question: *What's the simplest mechanism that lets representations adapt to context?* The answer was weighted mixing where the weights come from comparing what each word needs (Query) against what other words offer (Key). Everything else—multi-head attention, layer normalization, feed-forward networks—is engineering to make that core idea scale to 175 billion parameters and beyond.</span>
<span id="cb20-857"><a href="#cb20-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-858"><a href="#cb20-858" aria-hidden="true" tabindex="-1"></a>**Next**: <span class="co">[</span><span class="ot">Word Embeddings: Where It Started</span><span class="co">](word-embeddings.qmd)</span></span>
<span id="cb20-859"><a href="#cb20-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-860"><a href="#cb20-860" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> src</span><span class="op">=</span><span class="st">"https://cdn.jsdelivr.net/npm/@marimo-team/marimo-snippets@1"</span><span class="dt">&gt;&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2025, Sadamori Kojaku</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions"><ul><li><a href="https://github.com/skojaku/applied-soft-comp/edit/main/m03-text/transformers.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/skojaku/applied-soft-comp/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/skojaku/applied-soft-comp">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>